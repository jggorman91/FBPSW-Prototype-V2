<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Function Based Problem Solving Worksheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com/"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e3f2fd; color: #334155; line-height: 1.6; }
        .container { max-width: 1200px; margin: 1.5rem auto; padding: 2rem; background-color: #fff; border-radius: 1.25rem; box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); }
        .card { background-color: #fff; border-radius: 1rem; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08); padding: 1.75rem; margin-bottom: 1.75rem; border: 1px solid #d0eaff; }
        textarea, input[type="text"], input[type="number"], input[type="date"], select {
            border: 2px solid #90caf9; border-radius: 0.625rem; padding: 0.875rem; width: 100%; font-size: 1rem; line-height: 1.5;
        }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus {
            outline: none; border-color: #2196f3; box-shadow: 0 0 0 4px rgba(33,150,243,0.3);
        }
        button { display: inline-flex; align-items: center; justify-content: center; padding: 0.875rem 1.5rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s, transform 0.15s, box-shadow 0.3s; box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        button:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
        .btn-primary { background-color: #2196f3; color: #fff; border: none; background-image: linear-gradient(to right,#2196f3,#1976d2);}
        .btn-primary:hover { background-color: #1976d2; background-image: linear-gradient(to right,#1976d2,#1565c0);}
        .btn-secondary { background-color: #e0e0e0; color: #424242; border: 1px solid #bdbdbd; background-image: linear-gradient(to right,#e0e0e0,#cccccc);}
        .btn-secondary:hover { background-color: #cccccc; border-color: #9e9e9e; background-image: linear-gradient(to right,#cccccc,#9e9e9e);}
        .loading-spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin-right: 0.5rem;}
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .plan-section { margin-bottom: 1.5rem; }
        .plan-section h3 { font-weight: 700; margin-bottom: 0.75rem; color: #1976d2; font-size: 1.375rem;}
        .behavior-block { border: 2px solid #90caf9; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; background-color: #e3f2fd; box-shadow: 0 4px 8px rgba(0,0,0,0.08);}
        .behavior-block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 2px solid #64b5f6;}
        .info-modal-parent {
            position: relative;
        }
        .info-modal {
            left: 0;
            top: 100%;
            min-width: 320px;
            max-width: 500px;
        }
        .ai-output-content {
            white-space: pre-line;
        }
        .other-input {
            margin-top: 0.5rem;
            display: none; /* Hidden by default */
        }
        .other-input.active {
            display: block;
        }
        .add-remove-btn {
            background-color: #607d8b; /* Blue Grey */
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .add-remove-btn:hover {
            background-color: #455a64; /* Darker Blue Grey */
        }
        .add-remove-btn.remove {
            background-color: #ef5350; /* Red */
        }
        .add-remove-btn.remove:hover {
            background-color: #d32f2f; /* Darker Red */
        }
        .completion-indicator {
            text-align: right;
            font-weight: 500;
            color: #4CAF50; /* Green */
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container">
        <h1 class="text-4xl font-extrabold text-center text-blue-700 mb-8">
            Function Based Problem Solving Worksheet
        </h1>

        <div class="card flex justify-between items-center bg-blue-50 border border-blue-200 p-4 mb-6">
            <p class="text-blue-800 font-semibold">FBPSW: <span id="sessionStatusDisplay" class="font-normal text-blue-600">Active</span></p>
            <p class="completion-indicator">Form Progress: <span id="formProgress">0%</span></p>
            <button id="newPlanButton" class="btn-secondary">
                <i class="fas fa-plus mr-2"></i> New Plan
            </button>
        </div>

        <div class="card">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Teacher Input</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="studentAge" class="block text-gray-700 text-sm font-semibold mb-2">Student Age</label>
                    <input type="number" id="studentAge" placeholder="e.g., 7" min="3" max="18" aria-label="Student Age">
                </div>
                <div>
                    <label for="studentGrade" class="block text-gray-700 text-sm font-semibold mb-2">Student Grade Level</label>
                    <select id="studentGrade" aria-label="Student Grade Level">
                        <option value="">Select Grade</option>
                        <option value="K">Kindergarten</option>
                        <option value="1st">1st Grade</option>
                        <option value="2nd">2nd Grade</option>
                        <option value="3rd">3rd Grade</option>
                        <option value="4th">4th Grade</option>
                        <option value="5th">5th Grade</option>
                        <option value="6th">6th Grade</option>
                        <option value="7th">7th Grade</option>
                        <option value="8th">8th Grade</option>
                        <option value="Higher">Higher Grades</option>
                        <option value="Other">Other / Not Applicable</option>
                    </select>
                </div>

                <div class="md:col-span-2">
                    <label for="strengthsInterestsResiliency" class="block text-gray-700 text-sm font-semibold mb-2">Strengths, Interests, and Resiliency Factors</label>
                    <textarea id="strengthsInterestsResiliency" rows="3" placeholder="e.g., Strong in art, loves dinosaurs, responds well to positive adult attention, supportive family..." aria-label="Student Strengths, Interests, and Resiliency Factors"></textarea>
                </div>

                <div id="behaviorsContainer" class="md:col-span-2">
                    <button id="addBehaviorPatternBtn" class="add-remove-btn mt-4"><i class="fas fa-plus mr-2"></i> Add Behavior Pattern</button>
                </div>
                
                <div>
                    <label for="anecdotal" class="block text-gray-700 text-sm font-semibold mb-2">Anecdotal Notes (include information about frequency, intensity, duration of behaviors if known)</label>
                    <textarea id="anecdotal" rows="3" placeholder="e.g., Student exhibits task refusal daily during math, lasting 5-10 minutes..." aria-label="Anecdotal Notes on Behavior"></textarea>
                </div>
                <div>
                    <label for="reinforcerPreferences" class="block text-gray-700 text-sm font-semibold mb-2">Student's Preferred Reinforcers</label>
                    <textarea id="reinforcerPreferences" rows="2" placeholder="e.g., Loves computer time, enjoys drawing..." aria-label="Student's Preferred Reinforcers"></textarea>
                </div>

                <div class="info-modal-parent">
                    <div class="flex items-center mb-1">
                        <label for="behavioralSkillsSelect" class="block text-gray-700 text-sm font-semibold">Behavioral Skills Level</label>
                        <i id="behavioralInfoIcon" class="fas fa-info-circle text-blue-500 ml-2 cursor-pointer hover:text-blue-700" title="Click for behavioral levels description" aria-label="Information about Behavioral Skills Levels"></i>
                    </div>
                    <select id="behavioralSkillsSelect" aria-label="Behavioral Skills Level">
                        <option value="">Select Level</option>
                        <option value="Foundational Regulator">Foundational Regulator</option>
                        <option value="Guided Participant">Guided Participant</option>
                        <option value="Emerging Self-Manager">Emerging Self-Manager</option>
                        <option value="Flexible Adapter">Flexible Adapter</option>
                        <option value="Intentional Strategist">Intentional Strategist</option>
                        <option value="Reflective Adapter">Reflective Adapter</option>
                        <option value="Independent Regulator">Independent Regulator</option>
                        <option value="Strategic Manager">Strategic Manager</option>
                        <option value="Autonomous Problem-Solver">Autonomous Problem-Solver</option>
                    </select>
                    <div id="behavioralInfoModal" class="info-modal hidden absolute z-50 mt-1 p-4 bg-white border-2 border-blue-300 rounded-lg shadow-xl">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-md font-semibold text-blue-700">Behavioral Developmental Levels</h4>
                            <button id="closeBehavioralModal" class="text-gray-500 hover:text-gray-800 text-2xl leading-none" aria-label="Close Behavioral Info Modal">&times;</button>
                        </div>
                        <table class="w-full text-xs table-fixed">
                            <thead class="sticky top-0 bg-blue-100">
                                <tr>
                                    <th class="p-1 text-left font-semibold text-blue-800 w-1/3">Level</th>
                                    <th class="p-1 text-left font-semibold text-blue-800 w-2/3">Description</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="info-modal-parent">
                    <div class="flex items-center mb-1">
                        <label for="socialSkillsSelect" class="block text-gray-700 text-sm font-semibold">Social Skills Level</label>
                        <i id="socialInfoIcon" class="fas fa-info-circle text-blue-500 ml-2 cursor-pointer hover:text-blue-700" title="Click for social levels description" aria-label="Information about Social Skills Levels"></i>
                    </div>
                    <select id="socialSkillsSelect" aria-label="Social Skills Level">
                        <option value="">Select Level</option>
                        <option value="Social Initiator">Social Initiator</option>
                        <option value="Emerging Peer">Emerging Peer</option>
                        <option value="Collaborative Partner">Collaborative Partner</option>
                        <option value="Connected Participant">Connected Partner</option>
                        <option value="Social Navigator">Social Navigator</option>
                        <option value="Empathetic Ally">Empathetic Ally</option>
                        <option value="Relational Strategist">Relational Strategist</option>
                        <option value="Social Integrator">Social Integrator</option>
                        <option value="Leadership Model">Leadership Model</option>
                    </select>
                    <div id="socialInfoModal" class="info-modal hidden absolute z-50 mt-1 p-4 bg-white border-2 border-blue-300 rounded-lg shadow-xl">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-md font-semibold text-blue-700">Social Developmental Levels</h4>
                            <button id="closeSocialModal" class="text-gray-500 hover:text-gray-800 text-2xl leading-none" aria-label="Close Social Info Modal">&times;</button>
                        </div>
                        <table class="w-full text-xs table-fixed">
                            <thead class="sticky top-0 bg-blue-100">
                                <tr>
                                    <th class="p-1 text-left font-semibold text-blue-800 w-1/3">Level</th>
                                    <th class="p-1 text-left font-semibold text-blue-800 w-2/3">Description</th>
                                </tr>
                            </thead>
                                <tbody class="text-gray-700">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="info-modal-parent">
                    <div class="flex items-center mb-1">
                        <label for="pragmaticLanguageSkillsSelect" class="block text-gray-700 text-sm font-semibold">Pragmatic Language Skills Level</label>
                        <i id="pragmaticInfoIcon" class="fas fa-info-circle text-blue-500 ml-2 cursor-pointer hover:text-blue-700" title="Click for pragmatic language levels description" aria-label="Information about Pragmatic Language Skills Levels"></i>
                    </div>
                    <select id="pragmaticLanguageSkillsSelect" aria-label="Pragmatic Language Skills Level">
                        <option value="">Select Level</option>
                        <option value="Foundational Communicator">Foundational Communicator</option>
                        <option value="Emerging Conversationalist">Emerging Conversationalist</option>
                        <option value="Functional Speaker">Functional Speaker</option>
                        <option value="Social Interpreter">Social Interpreter</option>
                        <option value="Contextual Communicator">Contextual Communicator</option>
                        <option value="Purposeful Speaker">Purposeful Speaker</option>
                        <option value="Strategic Conversationalist">Strategic Conversationalist</option>
                        <option value="Adaptive Communicator">Adaptive Communicator</option>
                        <option value="Discourse Leader">Discourse Leader</option>
                    </select>
                                <div id="pragmaticInfoModal" class="info-modal hidden absolute z-50 mt-1 p-4 bg-white border-2 border-blue-300 rounded-lg shadow-xl">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-md font-semibold text-blue-700">Pragmatic Language Developmental Levels</h4>
                                    <button id="closePragmaticModal" class="text-gray-500 hover:text-gray-800 text-2xl leading-none" aria-label="Close Pragmatic Info Modal">&times;</button>
                                </div>
                                <table class="w-full text-xs table-fixed">
                                    <thead class="sticky top-0 bg-blue-100">
                                        <tr>
                                            <th class="p-1 text-left font-semibold text-blue-800 w-1/3">Level</th>
                                            <th class="p-1 text-left font-semibold text-blue-800 w-2/3">Description</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-gray-700">
                                    </tbody>
                                </table>
                                </div>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-gray-700 text-sm font-semibold mb-2">Add pertinent referral information?</label>
                    <div class="flex items-center space-x-4 mb-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="addReferralInfo" value="yes" class="form-radio" id="addReferralYes" aria-label="Add referral information Yes">
                            <span class="ml-2 text-gray-700">Yes</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="addReferralInfo" value="no" class="form-radio" id="addReferralNo" checked aria-label="Add referral information No">
                            <span class="ml-2 text-gray-700">No</span>
                        </label>
                    </div>
                    <div id="referralInfoContainer" class="hidden">
                        <label for="referral" class="block text-gray-700 text-sm font-semibold mb-2">Referral Information</label>
                        <textarea id="referral" rows="4" placeholder="e.g., Student referred for disruptive behavior..." aria-label="Referral Information"></textarea>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="generateBIPButton" class="btn-primary">
                    <span id="generateBIPSpinner" class="loading-spinner hidden" role="status" aria-hidden="true"></span>
                    Generate Plan
                </button>
            </div>
        </div>

        <div id="bipOutput" class="card hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Generated Function Based Problem Solving Worksheet</h2>
            <div class="mb-4">
                <p id="bipFunctionHypothesis" class="text-blue-600 font-medium text-xl whitespace-pre-line"></p>
            </div>
            <div class="plan-section">
                <h3>Antecedent Strategies:</h3>
                <div id="bipAntecedentStrategies" class="prose max-w-none text-gray-800 ai-output-content"></div>
            </div>
            <div class="plan-section">
                <h3>Short-term Replacement Behaviors:</h3>
                <div id="bipShortTermBehaviors" class="prose max-w-none text-gray-800 ai-output-content"></div>
            </div>
            <div class="plan-section">
                <h3>Teaching Strategies for Short-Term Replacement Behaviors:</h3>
                <div id="bipTeachingStrategies" class="prose max-w-none text-gray-800 ai-output-content"></div>
            </div>
            <div class="plan-section">
                <h3>Reinforcement Strategies for Short-Term Replacement Behaviors:</h3>
                <div id="bipReinforcementShortTerm" class="prose max-w-none text-gray-800 ai-output-content"></div>
            </div>
            <div class="plan-section">
                <h3>Long-term Replacement Behaviors:</h3>
                <div id="bipLongTermBehaviors" class="prose max-w-none text-gray-800 ai-output-content"></div>
            </div>
            <div class="plan-section">
                <h3>Response Strategies for Problem Behavior:</h3>
                <div id="bipResponseStrategies" class="prose max-w-none text-gray-800 ai-output-content"></div>
            </div>

            <div class="plan-section">
                <h3>Monitoring and Plan Review:</h3>
                <div id="monitoringStatementContent" class="prose max-w-none text-gray-800">
                    <p>This plan needs to be reviewed by the school team no less than every four to six weeks starting the 25-26 school year. If the plan is not working, then some aspects should be revised at the meeting. If the plan is successful (extinguished maladaptive behaviors) for four consecutive weeks, then the IEP team should meet to amend the IEP and turn it into a full behavior intervention plan (BIP). Data supporting more intervention or success will be determined by Infinite Campus classroom incidents and referrals.</p>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-4">
                <button id="copyBIPButton" class="btn-secondary" aria-label="Copy Plan to Clipboard">
                    <i class="fas fa-copy mr-2"></i> Copy Plan
                </button>
                <button id="exportPdfButton" class="btn-primary" aria-label="Export Plan to PDF">
                    <i class="fas fa-file-pdf mr-2"></i> Export to PDF
                </button>
                <button id="exportCsvButton" class="btn-secondary" aria-label="Export Plan to CSV">
                    <i class="fas fa-file-csv mr-2"></i> Export to CSV
                </button>
            </div>
        </div>
    </div>

<script type="module">
    // --- Data for ABC dropdowns from "ABC_Framework_Behavior_Plan (Chat GPT Orginal)" & User Expansion ---
    const bipData = {
        "Physical Aggression": {
            antecedents: ["Challenging tasks", "Denial of requests", "Interruption of preferred activity", "Peer conflicts", "Protecting personal space/items", "Sensory overload", "Transitions", "Unwanted physical touch"].sort(),
            behaviors: ["Biting (others)", "Hitting", "Kicking", "Pinching", "Pulling hair (others)", "Pushing", "Scratching (others)", "Shoving", "Spitting (at others)", "Throwing objects (at people/property with intent to harm/disrupt)"].sort(),
            consequences: ["Adult attention (reprimand, comfort, intervention)", "Item/activity obtained", "Loss of privileges", "Peer avoidance/withdrawal", "Physical restraint (for safety)", "Removal from activity/area", "Task/demand escaped"].sort()
        },
        "Verbal Aggression": {
            antecedents: ["Denial of requests", "Feeling unheard/misunderstood", "Frustration with task", "Peer teasing/provocation", "Perceived unfairness", "Receiving corrections/reprimands", "Unexpected changes"].sort(),
            behaviors: ["Arguing/Defiance (verbal, e.g., \"No!\")", "Name-calling/Insults", "Sarcasm/Rude comments", "Swearing/Profanity", "Threats (verbal)", "Yelling/Screaming"].sort(),
            consequences: ["Adult attention (discussion, warning)", "Loss of privileges", "Peer reactions (laughter, arguing, fear)", "Reprimands (can be attention)", "Task/demand escaped or modified", "Time-outs"].sort()
        },
        "Self-Injurious Behavior": {
            antecedents: ["Denial of preferred item/activity", "Emotional distress (anxiety, frustration)", "High task demands", "Lack of stimulation/boredom", "Physical pain/discomfort (internal)", "Sensory discomfort/overload", "Transitions"].sort(),
            behaviors: ["Biting self", "Hair pulling (own)", "Head banging (against surface/self)", "Hitting self", "Picking skin/scabs", "Scratching self"].sort(),
            consequences: ["Access to sensory input (automatic reinforcement)", "Comfort/attention provided", "Escape from demand/social interaction", "Intervention for safety (physical block, removal)", "Task removal/postponement"].sort()
        },
        "Task Refusal / Noncompliance": {
            antecedents: ["Challenging/Difficult tasks", "Fatigue", "Lack of choice in task", "Long work periods", "Non-preferred tasks", "Transitions to non-preferred activity", "Unclear instructions"].sort(),
            behaviors: ["Arguing about task", "Asking to do something else", "Ignoring instructions/prompts", "Leaving work area (not elopement)", "Passively not starting task", "Putting head down", "Saying 'no' to requests"].sort(),
            consequences: ["Adult prompts/redirection (can be attention)", "Allowed to do preferred activity instead (escape)", "Break given", "Loss of reward/privilege if task incomplete", "Task postponed/removed", "Task simplification"].sort()
        },
        "Elopement (Running Away)": {
            antecedents: ["Non-preferred settings/activities", "Overstimulating environment", "To escape a demand or aversive situation", "To gain access to a preferred item/area/person outside current setting", "Transitions", "Unstructured times"].sort(),
            behaviors: ["Hiding from staff", "Leaving supervised area without permission", "Running away from staff/group"].sort(),
            consequences: ["Access to desired location/item (if successful elopement)", "Chased by staff (can be reinforcing)", "Increased one-on-one supervision", "Loss of privileges", "Return to original area/task (sometimes delayed)"].sort()
        },
        "Disruptive Behavior (Non-Aggressive)": {
            antecedents: ["Boring/Easy tasks", "Lack of engagement", "Seeking adult attention", "Seeking peer attention", "Transition periods", "Unstructured periods"].sort(),
            behaviors: ["Making noises (vocal, tapping, etc.)", "Out-of-seat (without permission)", "Playing with non-task items", "Talking out of turn/Interrupting", "Touching/bothering peers' belongings", "Wandering around (not elopement)"].sort(),
            consequences: ["Brief removal from group (if disruptive)", "Loss of rewards/points", "Peer attention (laughter, annoyance)", "Sent to a different seat", "Teacher attention (redirect, reprimand)"].sort()
        },
        "Off-Task Behavior": {
            antecedents: ["Distractions in environment", "Internal distractions (thoughts, fatigue)", "Lack of interest in task", "Long work periods without breaks", "Tasks too easy or too hard", "Unclear instructions"].sort(),
            behaviors: ["Daydreaming/Staring into space", "Doodling (unrelated to task)", "Fiddling with objects (non-task related)", "Getting up to do unrelated things (sharpen pencil repeatedly)", "Looking around the room (not at task)", "Slow task initiation/procrastination"].sort(),
            consequences: ["Less free time later", "Loss of privileges (if work not done)", "Natural consequence (work not completed, doesn't learn material)", "Prompts to focus from adult", "Task simplification (if too hard)"].sort()
        },
        "Property Destruction/Misuse": {
            antecedents: ["Denied access to desired items/activities", "Escape from task", "Frustration/Anger", "Seeking attention", "Unstructured moments"].sort(),
            behaviors: ["Breaking objects (pencils, crayons, toys)", "Drawing/writing on property (desks, walls, books)", "Tearing materials (books, worksheets)", "Throwing objects (not aimed at people, e.g., in frustration)"].sort(),
            consequences: ["Loss of item/access to similar items", "Reprimand/adult attention", "Required cleanup/restitution", "Task delayed or removed", "Time-out"].sort()
        },
        "General / Other": { // For when behavior type is "Other"
            antecedents: [
                "Academic demand", "Change in routine", "Correction/Feedback", "Denial of access",
                "Internal state (hungry, tired, anxious)", "Lack of attention", "Peer interaction (positive or negative)",
                "Presence of specific person/item", "Sensory input (loud noise, bright light)",
                "Social demand", "Transition", "Unstructured time"
            ].sort(),
            behaviors: [ // User will rely more on anecdotal notes for "Other" behaviors
                "Crying", "Inappropriate physical contact (non-aggressive)", "Not following social rules",
                "Pacing", "Refusing to speak", "Whining", "Withdrawing from interaction",
                "(Specify in anecdotal notes)"
            ].sort(),
            consequences: [
                "Access to preferred item/activity/person", "Adult attention (positive/negative)", "Comfort",
                "Escape/Avoidance of task/situation/person", "Ignoring", "Loss of privilege",
                "Peer attention (positive/negative)", "Removal from area", "Reprimand", "Redirection",
                "Sensory stimulation (automatic)", "Task modification"
            ].sort()
        }
    };

    // --- Data for Developmental Level Modals from "Psychological_Developmental_Levels_Framework (Chat GPT Orginal)" ---
    const developmentalLevels = {
        behavioral: [
            { level: "Foundational Regulator", description: "Begins to respond to adult direction and follow basic instructions." },
            { level: "Guided Participant", description: "Learning routines and starting to manage impulses with support." },
            { level: "Emerging Self-Manager", description: "Follows daily expectations with minimal prompting; early signs of self-regulation." },
            { level: "Flexible Adapter", description: "Demonstrates behavioral awareness and adjusts actions to meet expectations." },
            { level: "Intentional Strategist", description: "Uses learned strategies to manage feelings and stay engaged." },
            { level: "Reflective Adapter", description: "Reflects on decisions and alters behavior based on environment." },
            { level: "Independent Regulator", description: "Applies strategies independently; shows accountability for behavior." },
            { level: "Strategic Manager", description: "Manages emotions in different settings with consistent strategy use." },
            { level: "Autonomous Problem-Solver", description: "Independently evaluates actions and mentors peers in regulation." }
        ],
        social: [
            { level: "Social Initiator", description: "Begins to interact and show interest in social contact." },
            { level: "Emerging Peer", description: "Engages in basic group participation and follows simple social rules." },
            { level: "Collaborative Partner", description: "Cooperates in tasks with support and initiates teamwork." },
            { level: "Connected Participant", description: "Shares ideas and respects others’ contributions." },
            { level: "Social Navigator", description: "Develops friendships and adapts to group dynamics." },
            { level: "Empathetic Ally", description: "Demonstrates empathy and resolves social issues constructively." },
            { level: "Relational Strategist", description: "Balances personal identity with social inclusion." },
            { level: "Social Integrator", description: "Manges complex peer relationships and social contexts." },
            { level: "Leadership Model", description: "Demonstrates leadership and models inclusive practices." }
        ],
        pragmatic: [
            { level: "Foundational Communicator", description: "Uses simple phrases to express needs and respond to others." },
            { level: "Emerging Conversationalist", description: "Begins conversations and uses basic conversational norms." },
            { level: "Functional Speaker", description: "Carries conversations and clarifies when needed." },
            { level: "Social Interpreter", description: "Uses humor and manages dialogue in social settings." },
            { level: "Contextual Communicator", description: "Adapts speech to suit audience and situation." },
            { level: "Purposeful Speaker", description: "Expresses intentions clearly and addresses breakdowns in communication." },
            { level: "Strategic Conversationalist", description: "Engages in layered, intentional discussions." },
            { level: "Adaptive Communicator", description: "Uses appropriate communication across varied settings." },
            { level: "Discourse Leader", description: "Communicates abstract ideas and leads discussions." }
        ]
    };

    // --- Data for Grade-Level Context from "Combined_Developmental_Levels_by_Grade.docx" ---
    const gradeLevelContexts = {
        "K": {
            behavioral: "Foundational Regulator to Guided Participant – Students are beginning to follow adult guidance, learn classroom routines, and require support to manage impulses.",
            social: "Social Initiator to Emerging Peer – Students start interacting with others and learn simple social rules and group participation.",
            language: "Foundational Communicator to Emerging Conversationalist – Students use basic language to express needs and begin short conversations using polite terms."
        },
        "1st": {
            behavioral: "Foundational Regulator to Guided Participant – Students are beginning to follow adult guidance, learn classroom routines, and require support to manage impulses.",
            social: "Social Initiator to Emerging Peer – Students start interacting with others and learn simple social rules and group participation.",
            language: "Foundational Communicator to Emerging Conversationalist – Students use basic language to express needs and begin short conversations using polite terms."
        },
        "2nd": {
            behavioral: "Emerging Self-Manager to Flexible Adapter – Students follow routines with less prompting and begin showing behavioral awareness.",
            social: "Collaborative Partner to Connected Participant – Students start cooperating in tasks and respecting others' contributions in group settings.",
            language: "Functional Speaker to Social Interpreter – Students maintain conversations and begin using humor or negotiation during interactions."
        },
        "3rd": {
            behavioral: "Emerging Self-Manager to Flexible Adapter – Students follow routines with less prompting and begin showing behavioral awareness.",
            social: "Collaborative Partner to Connected Participant – Students start cooperating in tasks and respecting others' contributions in group settings.",
            language: "Functional Speaker to Social Interpreter – Students maintain conversations and begin using humor or negotiation during interactions."
        },
        "4th": {
            behavioral: "Intentional Strategist to Reflective Adapter – Students apply coping strategies and reflect on behaviors to adjust to expectations.",
            social: "Social Navigator to Empathetic Ally – Students form friendships, include others, and begin resolving social conflicts empathetically.",
            language: "Contextual Communicator to Purposeful Speaker – Students adapt language to the setting and begin to discuss with clear intent and reasoning."
        },
        "5th": {
            behavioral: "Intentional Strategist to Reflective Adapter – Students apply coping strategies and reflect on behaviors to adjust to expectations.",
            social: "Social Navigator to Empathetic Ally – Students form friendships, include others, and begin resolving social conflicts empathetically.",
            language: "Contextual Communicator to Purposeful Speaker – Students adapt language to the setting and begin to discuss with clear intent and reasoning."
        },
        "6th": {
            behavioral: "Independent Regulator to Autonomous Problem-Solver – Students regulate behavior independently, show accountability, and support peers.",
            social: "Relational Strategist to Leadership Model – Students manage social identity, complex relationships, and lead by modeling inclusiveness.",
            language: "Strategic Conversationalist to Discourse Leader – Students use advanced dialogue, adjust communication styles across settings, and engage in persuasive or abstract discussions."
        },
        "7th": {
            behavioral: "Independent Regulator to Autonomous Problem-Solver – Students regulate behavior independently, show accountability, and support peers.",
            social: "Relational Strategist to Leadership Model – Students manage social identity, complex relationships, and lead by modeling inclusiveness.",
            language: "Strategic Conversationalist to Discourse Leader – Students use advanced dialogue, adjust communication styles across settings, and engage in persuasive or abstract discussions."
        },
        "8th": {
            behavioral: "Independent Regulator to Autonomous Problem-Solver – Students regulate behavior independently, show accountability, and support peers.",
            social: "Relational Strategist to Leadership Model – Students manage social identity, complex relationships, and lead by modeling inclusiveness.",
            language: "Strategic Conversationalist to Discourse Leader – Students use advanced dialogue, adjust communication styles across settings, and engage in persuasive or abstract discussions."
        }
    };

    // DOM elements
    const studentAgeInput = document.getElementById('studentAge');
    const studentGradeSelect = document.getElementById('studentGrade');
    const strengthsInterestsResiliencyInput = document.getElementById('strengthsInterestsResiliency');
    const reinforcerPreferencesInput = document.getElementById('reinforcerPreferences');
    const behavioralSkillsSelect = document.getElementById('behavioralSkillsSelect');
    const socialSkillsSelect = document.getElementById('socialSkillsSelect');
    const pragmaticLanguageSkillsSelect = document.getElementById('pragmaticLanguageSkillsSelect');
    const anecdotalInput = document.getElementById('anecdotal');
    const referralInput = document.getElementById('referral');
    const generateBIPButton = document.getElementById('generateBIPButton');
    const generateBIPSpinner = document.getElementById('generateBIPSpinner');
    const bipOutputDiv = document.getElementById('bipOutput');
    const bipFunctionHypothesis = document.getElementById('bipFunctionHypothesis');
    const bipAntecedentStrategies = document.getElementById('bipAntecedentStrategies');
    const bipShortTermBehaviors = document.getElementById('bipShortTermBehaviors');
    const bipTeachingStrategies = document.getElementById('bipTeachingStrategies');
    const bipReinforcementShortTerm = document.getElementById('bipReinforcementShortTerm');
    const bipLongTermBehaviors = document.getElementById('bipLongTermBehaviors');
    const bipResponseStrategies = document.getElementById('bipResponseStrategies');
    const copyBIPButton = document.getElementById('copyBIPButton');
    const exportPdfButton = document.getElementById('exportPdfButton');
    const exportCsvButton = document.getElementById('exportCsvButton');
    const sessionStatusDisplay = document.getElementById('sessionStatusDisplay');
    const addReferralYes = document.getElementById('addReferralYes');
    const addReferralNo = document.getElementById('addReferralNo');
    const referralInfoContainer = document.getElementById('referralInfoContainer');
    const monitoringStatementContentElement = document.getElementById('monitoringStatementContent');

    const behavioralInfoIcon = document.getElementById('behavioralInfoIcon');
    const behavioralInfoModal = document.getElementById('behavioralInfoModal');
    const closeBehavioralModalButton = document.getElementById('closeBehavioralModal');

    const socialInfoIcon = document.getElementById('socialInfoIcon');
    const socialInfoModal = document.getElementById('socialInfoModal');
    const closeSocialModalButton = document.getElementById('closeSocialModal');

    const pragmaticInfoIcon = document.getElementById('pragmaticInfoIcon');
    const pragmaticInfoModal = document.getElementById('pragmaticInfoModal');
    const closePragmaticModalButton = document.getElementById('closePragmaticModal');

    const behaviorsContainer = document.getElementById('behaviorsContainer');
    const addBehaviorPatternBtn = document.getElementById('addBehaviorPatternBtn');
    let behaviorPatternIndex = 0; // To keep track of current behavior blocks

    const formFields = document.querySelectorAll('input, select, textarea');
    const formProgressSpan = document.getElementById('formProgress');


    addReferralYes.addEventListener('change', () => {
        referralInfoContainer.classList.remove('hidden');
        updateFormProgress();
    });
    addReferralNo.addEventListener('change', () => {
        referralInfoContainer.classList.add('hidden');
        updateFormProgress();
    });

    function populateSelectWithOptions(selectElement, optionsArray, defaultOptionText, keepOther = true) {
        let otherOptionHTML = '';
        if (keepOther) {
            const existingOther = selectElement.querySelector('option[value="Other"]');
            if (existingOther) {
                otherOptionHTML = existingOther.outerHTML;
            } else {
                otherOptionHTML = '<option value="Other">Other (Specify in Notes)</option>';
            }
        }
        selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
        if (optionsArray && Array.isArray(optionsArray)) {
            optionsArray.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectElement.appendChild(option);
            });
        }
        if (keepOther && otherOptionHTML) {
            selectElement.insertAdjacentHTML('beforeend', otherOptionHTML);
        }
    }

    function createBehaviorBlock() {
        const blockIndex = behaviorPatternIndex++;
        const behaviorBlockDiv = document.createElement('div');
        behaviorBlockDiv.className = 'behavior-block';
        behaviorBlockDiv.dataset.behaviorIndex = blockIndex;

        behaviorBlockDiv.innerHTML = `
            <div class="behavior-block-header">
                <h3 class="text-lg font-semibold text-gray-700">Behavior Pattern ${blockIndex + 1}${blockIndex > 0 ? ' (Optional)' : ''}</h3>
                ${blockIndex > 0 ? '<button type="button" class="add-remove-btn remove remove-behavior-btn"><i class="fas fa-times mr-2"></i> Remove</button>' : ''}
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="behaviorTypeSelect_${blockIndex}" class="block text-gray-700 text-sm font-semibold mb-2">Behavior Type</label>
                    <select id="behaviorTypeSelect_${blockIndex}" data-other-target="behaviorTypeOther_${blockIndex}" aria-label="Behavior Type for pattern ${blockIndex + 1}"></select>
                    <input type="text" id="behaviorTypeOther_${blockIndex}" class="other-input" placeholder="Specify Behavior Type" aria-label="Specify other behavior type">
                </div>
                <div>
                    <label for="antecedentSelect_${blockIndex}" class="block text-gray-700 text-sm font-semibold mb-2">Antecedent</label>
                    <select id="antecedentSelect_${blockIndex}" data-other-target="antecedentOther_${blockIndex}" aria-label="Antecedent for pattern ${blockIndex + 1}"></select>
                    <input type="text" id="antecedentOther_${blockIndex}" class="other-input" placeholder="Specify Antecedent" aria-label="Specify other antecedent">
                </div>
                <div>
                    <label for="behaviorSelect_${blockIndex}" class="block text-gray-700 text-sm font-semibold mb-2">Specific Behavior</label>
                    <select id="behaviorSelect_${blockIndex}" data-other-target="behaviorSpecificOther_${blockIndex}" aria-label="Specific Behavior for pattern ${blockIndex + 1}"></select>
                    <input type="text" id="behaviorSpecificOther_${blockIndex}" class="other-input" placeholder="Specify Specific Behavior" aria-label="Specify other specific behavior">
                </div>
                <div>
                    <label for="consequenceSelect_${blockIndex}" class="block text-gray-700 text-sm font-semibold mb-2">Typical Consequence</label>
                    <select id="consequenceSelect_${blockIndex}" data-other-target="consequenceOther_${blockIndex}" aria-label="Typical Consequence for pattern ${blockIndex + 1}"></select>
                    <input type="text" id="consequenceOther_${blockIndex}" class="other-input" placeholder="Specify Consequence" aria-label="Specify other consequence">
                </div>
            </div>
        `;
        behaviorsContainer.insertBefore(behaviorBlockDiv, addBehaviorPatternBtn);

        const behaviorTypeSelect = document.getElementById(`behaviorTypeSelect_${blockIndex}`);
        const antecedentSelect = document.getElementById(`antecedentSelect_${blockIndex}`);
        const behaviorSpecificSelect = document.getElementById(`behaviorSelect_${blockIndex}`);
        const consequenceSelect = document.getElementById(`consequenceSelect_${blockIndex}`);

        // Populate Behavior Type select
        populateSelectWithOptions(behaviorTypeSelect, Object.keys(bipData), "Select Behavior Type");
        // Populate Antecedent with ALL general antecedents, and keep them constant
        populateSelectWithOptions(antecedentSelect, bipData["General / Other"].antecedents, "Select Antecedent");
        // Populate Behavior and Consequence based on initial "General / Other" or empty
        populateSelectWithOptions(behaviorSpecificSelect, bipData["General / Other"].behaviors, "Select Specific Behavior");
        populateSelectWithOptions(consequenceSelect, bipData["General / Other"].consequences, "Select Consequence");


        // Add event listeners for "Other" selections
        [behaviorTypeSelect, antecedentSelect, behaviorSpecificSelect, consequenceSelect].forEach(selectEl => {
            selectEl.addEventListener('change', function() {
                const otherInputId = this.dataset.otherTarget;
                const otherInputField = document.getElementById(otherInputId);
                if (this.value === "Other" || this.value === "General / Other") {
                    otherInputField.classList.add('active');
                    otherInputField.setAttribute('required', 'required');
                } else {
                    otherInputField.classList.remove('active');
                    otherInputField.removeAttribute('required');
                    otherInputField.value = ''; // Clear value if no longer "Other"
                }
                updateFormProgress();
            });
        });

        behaviorTypeSelect.addEventListener('change', function() {
            const selectedBehaviorType = this.value;
            const currentBlockHeader = this.closest('.behavior-block').querySelector('h3');
            if (selectedBehaviorType && currentBlockHeader) {
                if (selectedBehaviorType === "Other" || selectedBehaviorType === "General / Other") {
                    currentBlockHeader.textContent = `Behavior Pattern ${blockIndex + 1} (Other - specify in notes)`;
                } else {
                    currentBlockHeader.textContent = selectedBehaviorType;
                }
            } else if (currentBlockHeader) {
                currentBlockHeader.textContent = `Behavior Pattern ${blockIndex + 1}${blockIndex > 0 ? ' (Optional)' : '' }`;
            }

            // Only update Behavior and Consequence based on selected type
            // Antecedents remain fixed to "General / Other" list
            if (selectedBehaviorType && bipData[selectedBehaviorType]) {
                // Do NOT touch antecedentSelect here
                populateSelectWithOptions(behaviorSpecificSelect, bipData[selectedBehaviorType].behaviors, "Select Specific Behavior");
                populateSelectWithOptions(consequenceSelect, bipData[selectedBehaviorType].consequences, "Select Consequence");
            } else { // Fallback for "Other" or empty selection
                // Do NOT touch antecedentSelect here
                populateSelectWithOptions(behaviorSpecificSelect, bipData["General / Other"].behaviors, "Select Specific Behavior");
                populateSelectWithOptions(consequenceSelect, bipData["General / Other"].consequences, "Select Consequence");
            }
            updateFormProgress();
        });

        // Add event listener for removal
        if (blockIndex > 0) {
            behaviorBlockDiv.querySelector('.remove-behavior-btn').addEventListener('click', function() {
                behaviorBlockDiv.remove();
                updateFormProgress();
            });
        }
        updateFormProgress();
        return behaviorBlockDiv;
    }

    // Initial creation of the first behavior block
    createBehaviorBlock();

    addBehaviorPatternBtn.addEventListener('click', createBehaviorBlock);

    function populateInfoModalTable(modalBodyElement, levelsData) {
        modalBodyElement.innerHTML = ''; // Clear existing rows
        levelsData.forEach(item => {
            const row = modalBodyElement.insertRow();
            const levelCell = row.insertCell();
            const descriptionCell = row.insertCell();
            levelCell.className = 'p-1 border-t align-top';
            descriptionCell.className = 'p-1 border-t align-top';
            levelCell.textContent = item.level;
            descriptionCell.textContent = item.description;
        });
    }

    function setupInfoModal(iconId, modalId, closeButtonId, levelsData) {
        const icon = document.getElementById(iconId);
        const modal = document.getElementById(modalId);
        const closeButton = document.getElementById(closeButtonId);
        const modalTableBody = modal.querySelector('tbody');

        if (modalTableBody && levelsData) {
            populateInfoModalTable(modalTableBody, levelsData);
        }

        if (icon && modal) {
            icon.addEventListener('click', (event) => {
                event.stopPropagation();
                [behavioralInfoModal, socialInfoModal, pragmaticInfoModal].forEach(m => {
                    if (m && m !== modal) m.classList.add('hidden');
                });
                modal.classList.toggle('hidden');
            });
        }
        if (closeButton && modal) {
            closeButton.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Already called createBehaviorBlock() once
        setupInfoModal('behavioralInfoIcon', 'behavioralInfoModal', 'closeBehavioralModal', developmentalLevels.behavioral);
        setupInfoModal('socialInfoIcon', 'socialInfoModal', 'closeSocialModal', developmentalLevels.social);
        setupInfoModal('pragmaticInfoIcon', 'pragmaticInfoModal', 'closePragmaticModal', developmentalLevels.pragmatic);

        // Auto-save/load setup
        formFields.forEach(field => {
            field.addEventListener('change', updateFormProgress); // Update progress on change
            field.addEventListener('input', updateFormProgress); // Update progress on input for textareas/text fields
        });
        loadFormData(); // Load data on page load
        updateFormProgress(); // Calculate initial progress

        // Initial setup for the form and status display
        sessionStatusDisplay.textContent = "Active";
    });

    document.addEventListener('click', (event) => {
        const modals = [behavioralInfoModal, socialInfoModal, pragmaticInfoModal];
        const icons = [behavioralInfoIcon, socialInfoIcon, pragmaticInfoIcon];

        modals.forEach((modal, index) => {
            if (modal && !modal.classList.contains('hidden')) {
                let currentIcon = icons[index];
                let targetIsIconOrChild = false;
                if (currentIcon) {
                    targetIsIconOrChild = currentIcon.contains(event.target) || currentIcon === event.target;
                }

                if (!modal.contains(event.target) && !targetIsIconOrChild) {
                    modal.classList.add('hidden');
                }
            }
        });
    });

    function saveFormData() {
        const formData = {};
        document.querySelectorAll('#studentAge, #studentGrade, #strengthsInterestsResiliency, #anecdotal, #reinforcerPreferences, #behavioralSkillsSelect, #socialSkillsSelect, #pragmaticLanguageSkillsSelect, #referral').forEach(field => {
            formData[field.id] = field.value;
        });

        formData.addReferralInfo = document.querySelector('input[name="addReferralInfo"]:checked').value;
        
        const behaviorBlocksData = [];
        document.querySelectorAll('.behavior-block').forEach((block, index) => {
            const typeSelect = document.getElementById(`behaviorTypeSelect_${index}`);
            const antecedentSelect = document.getElementById(`antecedentSelect_${index}`);
            const behaviorSpecificSelect = document.getElementById(`behaviorSelect_${index}`);
            const consequenceSelect = document.getElementById(`consequenceSelect_${index}`);

            const blockData = {
                behaviorType: typeSelect ? typeSelect.value : '',
                antecedent: antecedentSelect ? antecedentSelect.value : '',
                behaviorSpecific: behaviorSpecificSelect ? behaviorSpecificSelect.value : '',
                consequence: consequenceSelect ? consequenceSelect.value : '',
                behaviorTypeOther: document.getElementById(`behaviorTypeOther_${index}`) ? document.getElementById(`behaviorTypeOther_${index}`).value : '',
                antecedentOther: document.getElementById(`antecedentOther_${index}`) ? document.getElementById(`antecedentOther_${index}`).value : '',
                behaviorSpecificOther: document.getElementById(`behaviorSpecificOther_${index}`) ? document.getElementById(`behaviorSpecificOther_${index}`).value : '',
                consequenceOther: document.getElementById(`consequenceOther_${index}`) ? document.getElementById(`consequenceOther_${index}`).value : '',
            };
            behaviorBlocksData.push(blockData);
        });
        formData.behaviorBlocks = behaviorBlocksData;
        formData.behaviorPatternIndex = behaviorPatternIndex; // Save the next index

        localStorage.setItem('fbpswFormData', JSON.stringify(formData));
    }

    function loadFormData() {
        const savedData = localStorage.getItem('fbpswFormData');
        if (savedData) {
            const formData = JSON.parse(savedData);

            document.querySelectorAll('#studentAge, #studentGrade, #strengthsInterestsResiliency, #anecdotal, #reinforcerPreferences, #behavioralSkillsSelect, #socialSkillsSelect, #pragmaticLanguageSkillsSelect, #referral').forEach(field => {
                if (formData[field.id] !== undefined) {
                    field.value = formData[field.id];
                }
            });

            if (formData.addReferralInfo) {
                document.getElementById(`addReferral${formData.addReferralInfo === 'yes' ? 'Yes' : 'No'}`).checked = true;
                if (formData.addReferralInfo === 'yes') {
                    referralInfoContainer.classList.remove('hidden');
                }
            }

            // Load behavior blocks
            if (formData.behaviorBlocks && formData.behaviorBlocks.length > 0) {
                // Remove initial empty block
                document.querySelectorAll('.behavior-block').forEach(block => block.remove());
                behaviorPatternIndex = 0; // Reset index for loading

                formData.behaviorBlocks.forEach(blockData => {
                    const newBlock = createBehaviorBlock(); // Create new block and get its index
                    const currentBlockIndex = parseInt(newBlock.dataset.behaviorIndex);

                    const behaviorTypeSelect = document.getElementById(`behaviorTypeSelect_${currentBlockIndex}`);
                    const antecedentSelect = document.getElementById(`antecedentSelect_${currentBlockIndex}`);
                    const behaviorSpecificSelect = document.getElementById(`behaviorSelect_${currentBlockIndex}`);
                    const consequenceSelect = document.getElementById(`consequenceSelect_${currentBlockIndex}`);
                    
                    // Set values for dropdowns and trigger change to populate dependent dropdowns
                    if (behaviorTypeSelect && blockData.behaviorType !== undefined) {
                        behaviorTypeSelect.value = blockData.behaviorType;
                        // Do not dispatch change for antecedentSelect here, as it's now constant
                        behaviorTypeSelect.dispatchEvent(new Event('change')); // Still needed for behaviorSpecific and consequence
                    }
                    if (antecedentSelect && blockData.antecedent !== undefined) {
                        antecedentSelect.value = blockData.antecedent;
                    }
                    if (behaviorSpecificSelect && blockData.behaviorSpecific !== undefined) {
                        behaviorSpecificSelect.value = blockData.behaviorSpecific;
                    }
                    if (consequenceSelect && blockData.consequence !== undefined) {
                        consequenceSelect.value = blockData.consequence;
                    }

                    // Set values for "Other" inputs
                    const otherBehaviorTypeInput = document.getElementById(`behaviorTypeOther_${currentBlockIndex}`);
                    const otherAntecedentInput = document.getElementById(`antecedentOther_${currentBlockIndex}`);
                    const otherBehaviorSpecificInput = document.getElementById(`behaviorSpecificOther_${currentBlockIndex}`);
                    const otherConsequenceInput = document.getElementById(`consequenceOther_${currentBlockIndex}`);

                    if (otherBehaviorTypeInput && blockData.behaviorTypeOther !== undefined) otherBehaviorTypeInput.value = blockData.behaviorTypeOther;
                    if (otherAntecedentInput && blockData.antecedentOther !== undefined) otherAntecedentInput.value = blockData.antecedentOther;
                    if (otherBehaviorSpecificInput && blockData.behaviorSpecificOther !== undefined) otherBehaviorSpecificInput.value = blockData.behaviorSpecificOther;
                    if (otherConsequenceInput && blockData.consequenceOther !== undefined) otherConsequenceInput.value = blockData.consequenceOther;

                    // Re-trigger change to show "Other" fields correctly
                    if (behaviorTypeSelect) behaviorTypeSelect.dispatchEvent(new Event('change'));
                    // No need to dispatch change for antecedentSelect as its options are static
                    if (behaviorSpecificSelect) behaviorSpecificSelect.dispatchEvent(new Event('change'));
                    if (consequenceSelect) consequenceSelect.dispatchEvent(new Event('change'));
                });
                behaviorPatternIndex = formData.behaviorPatternIndex; // Restore exact index
            } else {
                // If no saved blocks, ensure at least one empty block is present
                if (document.querySelectorAll('.behavior-block').length === 0) {
                    createBehaviorBlock();
                }
            }
        } else {
                // If no saved data, ensure at least one empty block is present
                if (document.querySelectorAll('.behavior-block').length === 0) {
                    createBehaviorBlock();
                }
        }
    }

    // Calculate form completion percentage
    function updateFormProgress() {
        let currentFilledCount = 0;

        if (studentAgeInput.value) currentFilledCount++;
        if (studentGradeSelect.value) currentFilledCount++;
        if (strengthsInterestsResiliencyInput.value) currentFilledCount++;
        if (anecdotalInput.value) currentFilledCount++;
        if (reinforcerPreferencesInput.value) currentFilledCount++;
        if (behavioralSkillsSelect.value) currentFilledCount++;
        if (socialSkillsSelect.value) currentFilledCount++;
        if (pragmaticLanguageSkillsSelect.value) currentFilledCount++;
        
        // Check referral info
        if (document.getElementById('addReferralYes').checked) {
            if (referralInput.value) currentFilledCount++;
        } else if (document.getElementById('addReferralNo').checked) {
            currentFilledCount++;
        }
        
        // Iterate through all behavior blocks
        document.querySelectorAll('.behavior-block').forEach((block, index) => {
            const typeSelect = document.getElementById(`behaviorTypeSelect_${index}`);
            const antecedentSelect = document.getElementById(`antecedentSelect_${index}`);
            const behaviorSpecificSelect = document.getElementById(`behaviorSelect_${index}`);
            const consequenceSelect = document.getElementById(`consequenceSelect_${index}`);

            // Check Behavior Type
            if (typeSelect && typeSelect.value) {
                if (typeSelect.value === 'Other' || typeSelect.value === 'General / Other') {
                    const otherInput = document.getElementById(`behaviorTypeOther_${index}`);
                    if (otherInput && otherInput.value) currentFilledCount++;
                } else {
                    currentFilledCount++;
                }
            }

            // Check Antecedent
            if (antecedentSelect && antecedentSelect.value) {
                if (antecedentSelect.value === 'Other') {
                    const otherInput = document.getElementById(`antecedentOther_${index}`);
                    if (otherInput && otherInput.value) currentFilledCount++;
                } else {
                    currentFilledCount++;
                }
            }

            // Check Specific Behavior
            if (behaviorSpecificSelect && behaviorSpecificSelect.value) {
                if (behaviorSpecificSelect.value === 'Other') {
                    const otherInput = document.getElementById(`behaviorSpecificOther_${index}`);
                    if (otherInput && otherInput.value) currentFilledCount++;
                } else {
                    currentFilledCount++;
                }
            }

            // Check Consequence
            if (consequenceSelect && consequenceSelect.value) {
                if (consequenceSelect.value === 'Other') {
                    const otherInput = document.getElementById(`consequenceOther_${index}`);
                    if (otherInput && otherInput.value) currentFilledCount++;
                } else {
                    currentFilledCount++;
                }
            }
        });

        const totalPossible = 9 + (document.querySelectorAll('.behavior-block').length * 4); // 9 initial fields + 4 fields per block
        const percentage = Math.round((currentFilledCount / totalPossible) * 100);
        formProgressSpan.textContent = `${percentage}%`;
        saveFormData(); // Auto-save on every progress update
    }

    // Call updateFormProgress on all relevant input events
    document.querySelectorAll('input, select, textarea').forEach(field => {
        field.addEventListener('input', updateFormProgress);
        field.addEventListener('change', updateFormProgress); // For select elements
    });
    
    // Initial call to set up the first block and progress
    // createBehaviorBlock() called on DOMContentLoaded already.
    // loadFormData() will also call updateFormProgress().

    function createPromptFromForm() {
        const age = studentAgeInput.value || 'Not specified';
        const grade = studentGradeSelect.value || 'Not specified';
        const strengthsInterests = strengthsInterestsResiliencyInput.value || 'Not specified';
        const reinforcers = reinforcerPreferencesInput.value || 'Not specified';

        let anecdotal = anecdotalInput.value || 'No specific anecdotal notes provided.';
        if (anecdotalInput.value && !anecdotalInput.value.toLowerCase().includes("daily") && !anecdotalInput.value.toLowerCase().includes("weekly") && !anecdotalInput.value.toLowerCase().includes("often") && !anecdotalInput.value.toLowerCase().includes("frequently")) {
            anecdotal += " (Note: Assume these behavioral observations represent recurring patterns over time unless otherwise specified in the patterns below.)";
        }

        const referral = referralInput && !referralInfoContainer.classList.contains('hidden') ? referralInput.value : '';
        const behavioralLevel = behavioralSkillsSelect.value || 'Not specified';
        const socialLevel = socialSkillsSelect.value || 'Not specified';
        const pragmaticLevel = pragmaticLanguageSkillsSelect.value || 'Not specified';

        // Collect all behavior blocks dynamically
        const allBehaviorBlocksData = [];
        document.querySelectorAll('.behavior-block').forEach((block, index) => {
            const typeSelect = document.getElementById(`behaviorTypeSelect_${index}`);
            const antecedentSelect = document.getElementById(`antecedentSelect_${index}`);
            const behaviorSpecificSelect = document.getElementById(`behaviorSelect_${index}`);
            const consequenceSelect = document.getElementById(`consequenceSelect_${index}`);

            // Get values, preferring 'Other' text input if 'Other' is selected in dropdown
            const behaviorType = (typeSelect.value === "Other" || typeSelect.value === "General / Other") ? (document.getElementById(`behaviorTypeOther_${index}`) ? document.getElementById(`behaviorTypeOther_${index}`).value : '') : typeSelect.value;
            const antecedent = (antecedentSelect.value === "Other") ? (document.getElementById(`antecedentOther_${index}`) ? document.getElementById(`antecedentOther_${index}`).value : '') : antecedentSelect.value;
            const specificBehavior = (behaviorSpecificSelect.value === "Other") ? (document.getElementById(`behaviorSpecificOther_${index}`) ? document.getElementById(`behaviorSpecificOther_${index}`).value : '') : behaviorSpecificSelect.value;
            const consequence = (consequenceSelect.value === "Other") ? (document.getElementById(`consequenceOther_${index}`) ? document.getElementById(`consequenceOther_${index}`).value : '') : consequenceSelect.value;
            
            // Only include if at least one field in the block has content (prevents empty optional blocks)
            if (behaviorType || antecedent || specificBehavior || consequence) {
                allBehaviorBlocksData.push({
                    type: behaviorType,
                    antecedent: antecedent,
                    specificBehavior: specificBehavior,
                    consequence: consequence
                });
            }
        });

        let behaviorsForPrompt = '';
        if (allBehaviorBlocksData.length > 0) {
            behaviorsForPrompt = allBehaviorBlocksData.map((block, i) => {
                let title = block.type;
                if (!title || title === "Other" || title === "General / Other") {
                    title = block.specificBehavior || `Pattern ${i + 1}`;
                    if (title.toLowerCase().includes("other")) { // Further refinement if 'Other' specified in specific behavior
                        title = `Custom Behavior: ${title}`;
                    }
                }
                return `Observed Recurring Pattern - ${title}:\n  Antecedent: ${block.antecedent || 'Not specified'}\n  Specific Behavior: ${block.specificBehavior || 'Not specified'}\n  Typical Consequence: ${block.consequence || 'Not specified'}`;
            }).join('\n\n');
        } else {
            behaviorsForPrompt = 'No specific recurring behavior patterns selected. If none are detailed, use the anecdotal notes to infer patterns and hypothesize the most likely ABC sequence.';
        }

        const evidenceBasedStrategies = `
ADDITIONAL GUIDANCE FOR REPLACEMENT BEHAVIORS:
When developing the 'Short-term Replacement Behaviors', 'Teaching Strategies for Short-term Replacement Behaviors', 'Reinforcement Strategies for Short-term Replacement Behaviors', and 'Long-term Replacement Behaviors' sections, please consider the following evidence-based approaches, categorized by common behavioral functions. First, hypothesize the function based on the provided ABC data and student information. Then, select and adapt strategies relevant to that hypothesized function. These strategies are based on principles from evidence-based practices like Applied Behavior Analysis (ABA), Positive Behavioral Interventions and Supports (PBIS), and Functional Behavior Assessments (FBA). Implementation should be individualized and aligned with student needs, context, and data.

FOR STUDENTS SEEKING ATTENTION:
1. Teach Positive Communication for Attention: Help students learn respectful ways to gain attention such as using a help card, raising their hand, or saying “Excuse me.” Ensure these efforts are consistently acknowledged right away.
2. Schedule Frequent Adult Interaction: Provide students with brief, regular positive interactions (like a check-in or high-five every 10–15 minutes), regardless of behavior. This helps reduce unnecessary bids for attention.
3. Reinforce Positive Efforts Only: Acknowledge and reward behaviors like hand-raising while withholding responses to disruptions like calling out.
4. Visuals and Stories to Model Expectations: Display visual prompts (e.g., icons showing expected behaviors) and read or act out short stories that teach how to appropriately ask for attention.
5. Withhold Attention from Minor Disruptions: If a student uses attention-seeking behaviors that are not dangerous, calmly ignore the behavior and instead redirect or respond when they show appropriate behavior.

FOR STUDENTS AVOIDING TASKS OR DEMANDS:
1. Teach Requesting a Break or Help: Students can learn to say “I need help” or use a break card when tasks feel overwhelming. This prevents outbursts or avoidance behaviors.
2. Provide Limited, Meaningful Choices: Allow students to choose between task formats or work locations (“Do math on the rug or at your desk?”).
3. Modify Tasks and Support Gradually: Break complex assignments into smaller steps, simplify directions, or offer one-on-one support early to prevent frustration.
4. Offer Routine Breaks Regardless of Behavior: Plan short activity or movement breaks at predictable intervals. Teach students how to wait for or ask for breaks appropriately.
5. Use Timers and Prepare for Transitions: Timers and visual schedules help show students what’s coming. Give verbal cues before transitions to reduce surprise-related anxiety.

FOR STUDENTS WHO WANT SPECIFIC ITEMS OR ACTIVITIES:
1. Teach Appropriate Requesting Skills: Guide students to request items clearly and respectfully through words, signs, or visuals.
2. Reward the Right Behavior Only: If a student asks politely for something, honor the request briefly. Avoid giving the item when it’s demanded or taken aggressively.
3. Use Token Boards or First/Then Charts: Tie access to preferred items with task completion (e.g., “First reading, then tablet time”).
4. Teach Turn-Taking and Sharing: Model and rehearse taking turns with peers. Use timers or scripts to help students manage item sharing during play or meals.

FOR STUDENTS WITH SENSORY-BASED NEEDS:
1. Provide Sensory Breaks and Movement Time: Schedule body-based activities (e.g., jumping jacks, stretching) after periods of focus.
2. Offer Tools for Sensory Regulation: Give students items like fidget tools or stress balls, and teach how and when to use them.
3. Adjust the Environment: Lower noise, adjust lighting, or provide seating away from overstimulating areas.
4. Teach Calming Techniques: Model deep breathing, counting, or guided relaxation strategies. Create a calm-down space and practice using it proactively.

Remember that all strategies should be consistently implemented across settings and by all relevant staff.
`;
        let gradeContext = '';
        const selectedGradeKey = studentGradeSelect.value;
        if (gradeLevelContexts[selectedGradeKey]) {
            const context = gradeLevelContexts[selectedGradeKey];
            gradeContext = `
Typical Developmental Context for Student's Grade (${selectedGradeKey}):
- Behavioral Context: ${context.behavioral}
- Social Context: ${context.social}
- Language Context: ${context.language}
This grade-level context should be considered alongside the specifically selected individual skill levels.
`;
        }

        const hypothesisGenerationInstructions = `
IMPORTANT INSTRUCTION FOR 'Function Hypothesis Statement':
For the 'Function Hypothesis Statement' section, you MUST synthesize the provided ABC data (Antecedent, Behavior, Consequence from the selected patterns and/or anecdotal notes) to formulate a clear and concise hypothesis.
If only one behavior pattern is primarily being addressed, the statement MUST strictly follow this structure:
'When [accurately describe the specific antecedent conditions based on input...], the student will [accurately describe the specific observable problem behavior based on input...] because [accurately describe what the student typically obtains or escapes as a result of the behavior...] therefore, the function of the behavior appears to be [clearly state the hypothesized function for this pattern...].'
If multiple distinct behavior patterns are provided with potentially different hypothesized functions, you MUST address each clearly. You can do this by:
a) Providing a separate hypothesis statement in the above format for each distinct pattern (e.g., "For [Pattern Title from input, e.g., Physical Aggression]: When..., the student will..., because..., therefore the function is X. For [Second Pattern Title from input, e.g., Task Refusal]: When..., the student will..., because..., therefore the function is Y."). Use the pattern titles derived from the 'Observed Recurring Behavior Patterns' input as reference for your subheadings.
b) Or, if appropriate, a comprehensive summary that clearly links different functions to specific patterns.
Ensure each part of any hypothesis statement ([antecedent], [behavior], [consequence/reason], and [function]) is directly derived from and consistent with the student information and behavior patterns provided. Do not use placeholders like "[antecedent]" in your actual output; fill them with specific descriptions based on the input.
`;
        const personalizationInstruction = `
IMPORTANT PERSONALIZATION GUIDANCE:
When developing ALL sections of the Behavior Intervention Plan (especially Antecedent Strategies, all aspects of Replacement Behaviors including teaching and reinforcement, and Response Strategies), you MUST actively and explicitly incorporate the student's stated 'Strengths, Interests, and Resiliency Factors', their 'Preferred Reinforcers', and the contextual details from the 'Anecdotal Notes'. The goal is to create a highly personalized and practical plan. For example:
- If a student is interested in dinosaurs, consider how this interest can be woven into replacement behaviors, rewards, or task modifications.
- If strengths include artistic ability, explore how this can be used in coping strategies or alternative tasks.
- If anecdotal notes highlight specific triggers or successful past interactions, these must inform the antecedent and response strategies.
- 'Preferred Reinforcers' should be directly and creatively integrated into the 'Reinforcement Strategies for Short-Term Replacement Behaviors' and considered for long-term motivation.
Do not just list these factors; demonstrate their application in the strategies you propose throughout the plan.
`;

        const multiBehaviorInstruction = `
GUIDANCE FOR HANDLING MULTIPLE BEHAVIOR PATTERNS (APPLIES TO ALL STRATEGY SECTIONS):
If more than one 'Observed Recurring Behavior Pattern' is detailed in the input, it is crucial that the generated Behavior Intervention Plan addresses each pattern systematically. For each of the following sections – 'Antecedent Strategies', 'Short-term Replacement Behaviors', 'Teaching Strategies for Short-term Replacement Behaviors', 'Reinforcement Strategies for Short-term Replacement Behaviors', 'Long-term Replacement Behaviors' – you MUST:
1.  Consider each behavior pattern individually, especially if their hypothesized functions or topographies differ.
2.  Clearly delineate or preface which strategies apply to which behavior pattern. For example, you might use subheadings like "For [Pattern Title from input, e.g., Physical Aggression]:" followed by relevant strategies, then "For [Second Pattern Title from input, e.g., Task Refusal]:" followed by its strategies. Use the pattern titles derived from the 'Observed Recurring Behavior Patterns' input for these subheadings.
3.  If a strategy is applicable to multiple or all identified behavior patterns, you may consolidate, but explicitly state which patterns it covers.
Ensure the generated text within each section clearly indicates how it relates to the specific behavior patterns provided.
(Specific instructions for "Response Strategies for Problem Behavior" section are provided separately below).
`;
        const responseStrategyRefinedInstruction = `
**Critically, the 'Response Strategies for Problem Behavior' section must be detailed and robust.**
If multiple distinct 'Observed Recurring Behavior Patterns' are provided (as detailed in the 'Observed Recurring Behavior Patterns' input), you MUST structure this section to provide a complete and distinct set of response strategies for EACH behavior pattern. Use the exact pattern titles derived from the 'Observed Recurring Behavior Patterns' input (e.g., "Physical Aggression", "Task Refusal / Noncompliance", or "Other Behavior Pattern (refer to anecdotal notes for specifics)") as subheadings for each set of responses. For each behavior pattern, clearly outline:
    a. Immediate actions to take when this specific problem behavior pattern occurs to ensure the safety of the student and others.
    b. De-escalation techniques suitable for this specific behavior pattern and student characteristics.
    c. Clear, brief, and consistent verbal and non-verbal responses from staff for this pattern.
    d. Procedures for follow-up after an incident of this pattern, including re-teaching, and how to return the student to the learning environment.
    e. How to avoid strategies that could inadvertently reinforce this specific problem behavior based on its hypothesized function.

If only one behavior pattern is provided, you should present a single consolidated list covering points a-e above for that behavior, using its pattern title.
`;

        const fullPrompt = `
Act as an expert Board Certified Behavior Analyst (BCBA) in a school setting. Your primary task is to develop a comprehensive and actionable Behavior Intervention Plan (BIP) based on the student information provided below.

It is crucial to understand that the observed behaviors described are **recurring patterns that have been happening over time**, not isolated incidents. Therefore, the entire BIP, including all strategies, must reflect this understanding of chronicity and learned history.

Student Information:
Student Age: ${age}
Grade: ${grade}
Strengths, Interests, and Resiliency Factors: ${strengthsInterests}
Preferred Reinforcers: ${reinforcers}
Anecdotal Notes (including context of recurrence, frequency, intensity, duration if available): ${anecdotal}
${referral ? "Referral Information: " + referral : ""}
Current Behavioral Skills Level: ${behavioralLevel}
Current Social Skills Level: ${socialLevel}
Current Pragmatic Language Skills Level: ${pragmaticLevel}
${gradeContext}
Observed Recurring Behavior Patterns (ABC Data - based on dropdown selections):
${behaviorsForPrompt}

${evidenceBasedStrategies}

${hypothesisGenerationInstructions}

${personalizationInstruction}

${multiBehaviorInstruction}

Please generate the Behavior Intervention Plan. Format your response using these section headings (exactly as written). Ensure ALL sections are thoroughly addressed with specific, actionable, and research-based strategies appropriate for a school environment, drawing from the evidence-based strategies provided above where relevant to the hypothesized function. **You should act as if you have all necessary information to complete every section of the plan comprehensively and should attempt to provide recommendations for all listed sections. Do not state that more information is needed for any section; instead, provide the best possible strategies based on the information at hand.**

${responseStrategyRefinedInstruction}

Required BIP Sections:
Function Hypothesis Statement:
Antecedent Strategies:
Short-term Replacement Behaviors:
Teaching Strategies for Short-term Replacement Behaviors:
Reinforcement Strategies for Short-term Replacement Behaviors:
Long-term Replacement Behaviors:
Response Strategies for Problem Behavior:
        `.trim();
        return fullPrompt;
    }

    function parsePlanSections(planText) {
        const sectionKeys = [
            "Function Hypothesis Statement", "Antecedent Strategies", "Short-term Replacement Behaviors",
            "Teaching Strategies for Short-term Replacement Behaviors", "Reinforcement Strategies for Short-term Replacement Behaviors",
            "Long-term Replacement Behaviors", "Response Strategies for Problem Behavior"
        ];
        const sections = {};
        sectionKeys.forEach(key => sections[key] = "");

        const lines = planText.split('\n');
        let currentSectionKey = null;
        let contentForCurrentSection = [];

        for (const line of lines) {
            let matchedNewSection = false;
            for (const key of sectionKeys) {
                const trimmedLine = line.trim();
                // Match heading with optional bolding (**) or no bolding, followed by colon
                const pattern = new RegExp(`^(?:\\*\\*)?${key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}(?:\\*\\*)?:`, "i");
                if (pattern.test(trimmedLine)) {
                    if (currentSectionKey && contentForCurrentSection.length > 0) {
                        sections[currentSectionKey] = contentForCurrentSection.join('\n').trim();
                    }
                    currentSectionKey = key;
                    contentForCurrentSection = [];
                    const contentOnHeadingLine = trimmedLine.replace(pattern, "").trim();
                    if (contentOnHeadingLine) {
                        contentForCurrentSection.push(contentOnHeadingLine);
                    }
                    matchedNewSection = true;
                    break;
                }
            }
            if (!matchedNewSection && currentSectionKey) {
                // Only add line if it's not empty, or if previous lines in contentForCurrentSection were not empty
                if (line.trim() !== "" || contentForCurrentSection.some(l => l.trim() !== "")) {
                    contentForCurrentSection.push(line);
                }
            }
        }
        if (currentSectionKey && contentForCurrentSection.length > 0) {
            sections[currentSectionKey] = contentForCurrentSection.join('\n').trim();
        }
        for (let key in sections) {
            sections[key] = sections[key].trim();
        }
        return sections;
    }

    function getActiveProblemBehaviorPhrases() {
        const phrases = new Set();
        document.querySelectorAll('.behavior-block').forEach((block, index) => {
            const typeSelect = document.getElementById(`behaviorTypeSelect_${index}`);
            const behaviorSpecificSelect = document.getElementById(`behaviorSelect_${index}`);
            const behaviorTypeOther = document.getElementById(`behaviorTypeOther_${index}`);
            const behaviorSpecificOther = document.getElementById(`behaviorSpecificOther_${index}`);

            const typeValue = typeSelect ? typeSelect.value : '';
            const specificBehaviorValue = behaviorSpecificSelect ? behaviorSpecificSelect.value : '';

            if (typeValue && typeValue !== "Other" && typeValue !== "General / Other" && typeValue.trim().length > 2) {
                phrases.add(typeValue.trim());
            } else if ((typeValue === "Other" || typeValue === "General / Other") && behaviorTypeOther && behaviorTypeOther.value.trim().length > 2) {
                phrases.add(behaviorTypeOther.value.trim());
            }
            
            if (specificBehaviorValue && specificBehaviorValue !== "Other (Specify in Notes)" && specificBehaviorValue !== "Other" && specificBehaviorValue.trim().length > 2) {
                phrases.add(specificBehaviorValue.trim());
            } else if (specificBehaviorValue === "Other" && behaviorSpecificOther && behaviorSpecificOther.value.trim().length > 2) {
                phrases.add(behaviorSpecificOther.value.trim());
            }
        });
        return Array.from(phrases);
    }

    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function showPlanSections(sections, problemBehaviorPhrases = []) {
        const fallbackMsg = "The AI attempted to generate this section but may require more specific input for optimal results. Review and refine as needed.";

        function cleanAndBoldContent(text, phrasesToBold) {
            if (typeof text !== 'string') return '';
            let processedText = text.replace(/\*/g, ''); // Remove markdown bolding

            const sortedPhrases = [...phrasesToBold].sort((a, b) => b.length - a.length);

            sortedPhrases.forEach(phrase => {
                if (phrase && phrase.trim() !== '') {
                    const regex = new RegExp(`(\\b${escapeRegExp(phrase.trim())}\\b)`, 'gi');
                    processedText = processedText.replace(regex, (match) => `<strong>${match}</strong>`);
                }
            });
            return processedText;
        }

        let hypothesisContent = sections["Function Hypothesis Statement"] || fallbackMsg;
        const hypothesisDisplayPrefixLine1 = "Function Hypothesis Statement - The following provides an overview of the current behavior(s).";
        const hypothesisDisplayPrefixLine2 = "Summary Statement: ";
        bipFunctionHypothesis.innerHTML = cleanAndBoldContent(`${hypothesisDisplayPrefixLine1}\n${hypothesisDisplayPrefixLine2}${hypothesisContent}`, problemBehaviorPhrases);

        bipAntecedentStrategies.innerHTML = cleanAndBoldContent(sections["Antecedent Strategies"] || fallbackMsg, problemBehaviorPhrases);
        bipShortTermBehaviors.innerHTML = cleanAndBoldContent(sections["Short-term Replacement Behaviors"] || fallbackMsg, problemBehaviorPhrases);
        bipTeachingStrategies.innerHTML = cleanAndBoldContent(sections["Teaching Strategies for Short-term Replacement Behaviors"] || fallbackMsg, problemBehaviorPhrases);
        bipReinforcementShortTerm.innerHTML = cleanAndBoldContent(sections["Reinforcement Strategies for Short-term Replacement Behaviors"] || fallbackMsg, problemBehaviorPhrases);
        bipLongTermBehaviors.innerHTML = cleanAndBoldContent(sections["Long-term Replacement Behaviors"] || fallbackMsg, problemBehaviorPhrases);
        bipResponseStrategies.innerHTML = cleanAndBoldContent(sections["Response Strategies for Problem Behavior"] || fallbackMsg, problemBehaviorPhrases);

        bipOutputDiv.classList.remove('hidden');
    }

    function showErrorOutput(msg) {
        bipFunctionHypothesis.innerHTML = msg;
        bipAntecedentStrategies.innerHTML = "";
        bipShortTermBehaviors.innerHTML = "";
        bipTeachingStrategies.innerHTML = "";
        bipReinforcementShortTerm.innerHTML = "";
        bipLongTermBehaviors.innerHTML = "";
        bipResponseStrategies.innerHTML = "";
        bipOutputDiv.classList.remove('hidden');
    }

    function hidePlanOutput() {
        bipFunctionHypothesis.textContent = "";
        bipAntecedentStrategies.textContent = "";
        bipShortTermBehaviors.textContent = "";
        bipTeachingStrategies.textContent = "";
        bipReinforcementShortTerm.textContent = "";
        bipLongTermBehaviors.textContent = "";
        bipResponseStrategies.textContent = "";
        bipOutputDiv.classList.add('hidden');
    }

    // This is the function that will now call your Cloud Function
    async function generatePlanWithGemini() {
        generateBIPSpinner.classList.remove('hidden');
        generateBIPButton.disabled = true;
        sessionStatusDisplay.textContent = "Generating...";
        hidePlanOutput();

        const userGeneratedPrompt = createPromptFromForm(); // The full prompt for the AI
        console.log("Full Prompt being sent to AI:", userGeneratedPrompt); // Log the actual prompt

        try {
            // Call your existing askGemini function directly
            const responseData = await askGemini(userGeneratedPrompt);

            if (responseData && responseData.candidates && responseData.candidates.length > 0 && responseData.candidates[0].content && responseData.candidates[0].content.parts && responseData.candidates[0].content.parts[0].text) {
                const planText = responseData.candidates[0].content.parts[0].text;
                const sections = parsePlanSections(planText);
                const activePhrases = getActiveProblemBehaviorPhrases();
                showPlanSections(sections, activePhrases);
                sessionStatusDisplay.textContent = "Active (AI Generated)"; // Update status
            } else {
                let specificError = "Received an unexpected response structure from Gemini or no plan was generated.";
                if (responseData && responseData.candidates && responseData.candidates.length > 0 && responseData.candidates[0].finishReason) {
                    specificError = `The response generation finished with reason: ${responseData.candidates[0].finishReason}.`;
                } else if (responseData && responseData.promptFeedback && responseData.promptFeedback.blockReason) {
                    specificError = `The prompt was blocked by Gemini. Reason: ${responseData.promptFeedback.blockReason}.`;
                }
                showErrorOutput(specificError);
                sessionStatusDisplay.textContent = "Generation Failed"; // Update status
            }
        } catch (err) {
            showErrorOutput("An error occurred during the plan generation: " + err.message);
            sessionStatusDisplay.textContent = "Generation Failed"; // Update status
        } finally {
            generateBIPSpinner.classList.add('hidden');
            generateBIPButton.disabled = false;
        }
    }

    // Make sure the global askGemini function is defined BEFORE it's called
    // by generatePlanWithGemini. If script.js is loaded after this module, it will be fine.
    // If not, you might need to move askGemini inside this script block or ensure loading order.
    // For now, assuming script.js is loaded later or askGemini is made globally available.

    // Export to PDF (Print)
    exportPdfButton.addEventListener('click', () => {
        const printContent = document.createElement('div');
        printContent.innerHTML = `
            <style>
                body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
                .plan-section { margin-bottom: 15px; page-break-inside: avoid; }
                h1, h2, h3 { color: #1976d2; margin-bottom: 10px; }
                h1 { font-size: 24px; text-align: center; }
                h2 { font-size: 20px; }
                h3 { font-size: 18px; }
                p, ul, li { font-size: 12px; line-height: 1.5; margin-bottom: 5px; }
                strong { font-weight: bold; }
                ul { list-style-type: disc; margin-left: 20px; }
                .header-info p { margin-bottom: 5px; }
            </style>
            <div class="header-info">
                <h1>Function Based Problem Solving Worksheet</h1>
                <p><strong>Student:</strong> _________________________ <strong>Date:</strong> ______________ <strong>Observer:</strong> ______________</p>
                <p><strong>Setting/Activity:</strong> _________________________ <strong>Time Start:</strong> _________ <strong>Time End:</strong> __________</p>
                <p><strong>Strengths, Interests, and Resiliency Factors:</strong> ${strengthsInterestsResiliencyInput.value || 'Not specified'}</p>
                <p><strong>Preferred Reinforcers:</strong> ${reinforcerPreferencesInput.value || 'Not specified'}</p>
                <p><strong>Anecdotal Notes:</strong> ${anecdotalInput.value || 'No specific anecdotal notes provided.'}</p>
                ${(document.querySelector('input[name="addReferralInfo"]:checked').value === 'yes' && referralInput.value) ? `<p><strong>Referral Information:</strong> ${referralInput.value}</p>` : ''}
                <p><strong>Behavioral Skills Level:</strong> ${behavioralSkillsSelect.value || 'Not specified'}</p>
                <p><strong>Social Skills Level:</strong> ${socialSkillsSelect.value || 'Not specified'}</p>
                <p><strong>Pragmatic Language Skills Level:</strong> ${pragmaticLanguageSkillsSelect.value || 'Not specified'}</p>
            </div>
        `;

        // Append main plan sections
        printContent.innerHTML += `
            <div class="plan-section">
                <h3>Function Hypothesis Statement:</h3>
                <p>${bipFunctionHypothesis.textContent}</p>
            </div>
            <div class="plan-section">
                <h3>Antecedent Strategies:</h3>
                ${bipAntecedentStrategies.innerHTML}
            </div>
            <div class="plan-section">
                <h3>Short-term Replacement Behaviors:</h3>
                ${bipShortTermBehaviors.innerHTML}
            </div>
            <div class="plan-section">
                <h3>Teaching Strategies for Short-term Replacement Behaviors:</h3>
                ${bipTeachingStrategies.innerHTML}
            </div>
            <div class="plan-section">
                <h3>Reinforcement Strategies for Short-term Replacement Behaviors:</h3>
                ${bipReinforcementShortTerm.innerHTML}
            </div>
            <div class="plan-section">
                <h3>Long-term Replacement Behaviors:</h3>
                ${bipLongTermBehaviors.innerHTML}
            </div>
            <div class="plan-section">
                <h3>Response Strategies for Problem Behavior:</h3>
                ${bipResponseStrategies.innerHTML}
            </div>
            <div class="plan-section">
                <h3>Monitoring and Plan Review:</h3>
                ${monitoringStatementContentElement.innerHTML}
            </div>
        `;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent.outerHTML);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    });

    // Export to CSV
    exportCsvButton.addEventListener('click', () => {
        let csvContent = "";
        const delimiter = ",";

        // Basic Info
        csvContent += `Field${delimiter}Value\n`;
        csvContent += `Student Age${delimiter}${studentAgeInput.value}\n`;
        csvContent += `Student Grade${delimiter}${studentGradeSelect.value}\n`;
        csvContent += `Strengths/Interests${delimiter}"${strengthsInterestsResiliencyInput.value.replace(/"/g, '""')}"\n`;
        csvContent += `Reinforcers${delimiter}"${reinforcerPreferencesInput.value.replace(/"/g, '""')}"\n`;
        csvContent += `Anecdotal Notes${delimiter}"${anecdotalInput.value.replace(/"/g, '""')}"\n`;
        if (document.querySelector('input[name="addReferralInfo"]:checked').value === 'yes' && referralInput.value) {
            csvContent += `Referral Info${delimiter}"${referralInput.value.replace(/"/g, '""')}"\n`;
        }
        csvContent += `Behavioral Skills Level${delimiter}${behavioralSkillsSelect.value}\n`;
        csvContent += `Social Skills Level${delimiter}${socialSkillsSelect.value}\n`;
        csvContent += `Pragmatic Language Skills Level${delimiter}${pragmaticLanguageSkillsSelect.value}\n`;
        csvContent += "\n";

        // Behavior Patterns
        csvContent += `Behavior Patterns\n`;
        csvContent += `Pattern Index${delimiter}Type${delimiter}Antecedent${delimiter}Specific Behavior${delimiter}Consequence\n`;
        document.querySelectorAll('.behavior-block').forEach((block, index) => {
            const typeSelect = document.getElementById(`behaviorTypeSelect_${index}`);
            const antecedentSelect = document.getElementById(`antecedentSelect_${index}`);
            const behaviorSpecificSelect = document.getElementById(`behaviorSelect_${index}`);
            const consequenceSelect = document.getElementById(`consequenceSelect_${index}`);
            
            const behaviorType = (typeSelect.value === "Other" || typeSelect.value === "General / Other") ? document.getElementById(`behaviorTypeOther_${index}`).value : typeSelect.value;
            const antecedent = (antecedentSelect.value === "Other") ? document.getElementById(`antecedentOther_${index}`).value : antecedentSelect.value;
            const specificBehavior = (behaviorSpecificSelect.value === "Other") ? document.getElementById(`behaviorSpecificOther_${index}`).value : behaviorSpecificSelect.value;
            const consequence = (consequenceSelect.value === "Other") ? document.getElementById(`consequenceOther_${index}`).value : consequenceSelect.value;

            if (behaviorType || antecedent || specificBehavior || consequence) {
                csvContent += `${index + 1}${delimiter}`;
                csvContent += `"${behaviorType.replace(/"/g, '""')}"${delimiter}`;
                csvContent += `"${antecedent.replace(/"/g, '""')}"${delimiter}`;
                csvContent += `"${specificBehavior.replace(/"/g, '""')}"${delimiter}`;
                csvContent += `"${consequence.replace(/"/g, '""')}"\n`;
            }
        });
        csvContent += "\n";

        // Generated Plan Sections
        csvContent += `Generated Plan\n`;
        const sectionsToCopy = [
            { id: 'bipFunctionHypothesis', title: 'Function Hypothesis Statement' },
            { id: 'bipAntecedentStrategies', title: 'Antecedent Strategies' },
            { id: 'bipShortTermBehaviors', title: 'Short-term Replacement Behaviors' },
            { id: 'bipTeachingStrategies', title: 'Teaching Strategies for Short-term Replacement Behaviors' },
            { id: 'bipReinforcementShortTerm', title: 'Reinforcement Strategies for Short-term Replacement Behaviors' },
            { id: 'bipLongTermBehaviors', title: 'Long-term Replacement Behaviors' },
            { id: 'bipResponseStrategies', title: 'Response Strategies for Problem Behavior' },
            { id: 'monitoringStatementContent', title: 'Monitoring and Plan Review' }
        ];

        sectionsToCopy.forEach(section => {
            const element = document.getElementById(section.id);
            if (element) {
                let content = element.textContent.trim();
                // For hypothesis, remove the fixed prefix
                if (section.id === 'bipFunctionHypothesis') {
                    content = content.replace(/^Function Hypothesis Statement - The following provides an overview of the current behavior\(s\)\.[\s\S]*?Summary Statement:\s*/, '').trim();
                }
                csvContent += `"${section.title}"${delimiter}"${content.replace(/"/g, '""').replace(/\n/g, '\\n')}"\n`; // Replace newlines for CSV cell
            }
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'FBPSW_Plan.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            alert('Your browser does not support downloading files directly. Please copy the text and paste it into a spreadsheet.');
        }
    });


    document.getElementById('newPlanButton').addEventListener('click', () => {
        studentAgeInput.value = '';
        studentGradeSelect.value = '';
        strengthsInterestsResiliencyInput.value = '';
        reinforcerPreferencesInput.value = '';
        anecdotalInput.value = '';
        referralInput.value = '';
        behavioralSkillsSelect.value = '';
        socialSkillsSelect.value = '';
        pragmaticLanguageSkillsSelect.value = '';

        // Remove all existing behavior blocks except for the first one
        document.querySelectorAll('.behavior-block').forEach(block => block.remove()); // Remove all
        behaviorPatternIndex = 0; // Reset index
        createBehaviorBlock(); // Create a fresh first block


        addReferralNo.checked = true;
        referralInfoContainer.classList.add('hidden');
        hidePlanOutput();
        sessionStatusDisplay.textContent = "Active";
        updateFormProgress(); // Recalculate progress after reset
    });
</script>
<input id="userPrompt" placeholder="Ask about a behavior..." />
<button onclick="askGemini()">Ask Gemini</button>
<pre id="responseOutput"></pre>
<script src="script.js"></script>
    <input id="userPrompt" placeholder="Ask about a behavior..." />
<button onclick="askGemini()">Ask Gemini</button>
<pre id="responseOutput"></pre>
<script src="script.js"></script>
</body>
</html>
