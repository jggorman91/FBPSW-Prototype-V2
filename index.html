// --- Place this at the END of your <script type="module"> block ---

/**
 * Gather inputs from your form and assemble a prompt string for the AI.
 */
function createPromptFromForm() {
    // Gather basic info
    const age = studentAgeInput.value || '';
    const grade = studentGradeSelect.value || '';
    const reinforcers = reinforcerPreferencesInput.value || '';
    const anecdotal = anecdotalInput.value || '';
    const referral = referralInput && !referralInfoContainer.classList.contains('hidden') ? referralInput.value : '';

    // Gather developmental levels
    const behavioralLevel = behavioralSkillsSelect.value || '';
    const socialLevel = socialSkillsSelect.value || '';
    const pragmaticLevel = pragmaticLanguageSkillsSelect.value || '';

    // Gather behaviors (up to 3 behavior blocks)
    function getBehaviorBlock(index) {
        const type = document.getElementById(`behaviorTypeSelect_${index}`)?.value || '';
        const antecedent = document.getElementById(`antecedentSelect_${index}`)?.value || '';
        const behavior = document.getElementById(`behaviorSelect_${index}`)?.value || '';
        const consequence = document.getElementById(`consequenceSelect_${index}`)?.value || '';
        let result = '';
        if (type || antecedent || behavior || consequence) {
            result = `Behavior ${index+1}:\n  Type: ${type}\n  Antecedent: ${antecedent}\n  Behavior: ${behavior}\n  Consequence: ${consequence}`;
        }
        return result;
    }
    const behaviors = [0,1,2].map(getBehaviorBlock).filter(Boolean).join('\n\n');

    // Compose the prompt
    return `
Student Age: ${age}
Grade: ${grade}
Preferred Reinforcers: ${reinforcers}
Anecdotal Notes: ${anecdotal}
${referral ? "Referral: " + referral : ""}
Behavioral Skills Level: ${behavioralLevel}
Social Skills Level: ${socialLevel}
Pragmatic Language Skills Level: ${pragmaticLevel}

Behaviors:
${behaviors || 'None provided.'}
    `.trim();
}

/**
 * Show or hide the generated plan output.
 */
function showPlanOutput(content) {
    bipFunctionHypothesis.textContent = content;
    bipOutputDiv.classList.remove('hidden');
}

function hidePlanOutput() {
    bipFunctionHypothesis.textContent = '';
    bipOutputDiv.classList.add('hidden');
}

/**
 * Main plan generation function.
 */
async function generatePlan() {
    // UI feedback
    generateBIPSpinner.classList.remove('hidden');
    generateBIPButton.disabled = true;
    sessionStatusDisplay.textContent = "Generating...";

    // Hide previous output
    hidePlanOutput();

    // Construct the prompt
    const prompt = createPromptFromForm();

    try {
        const response = await fetch('/api/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt })
        });
        const data = await response.json();

        if (data.error || !data.choices) {
            // Show detailed error message
            let errorMsg = typeof data.error === 'string' ? data.error : JSON.stringify(data.error, null, 2);
            if (data.details) {
                errorMsg += "\nDetails: " + (typeof data.details === 'string' ? data.details : JSON.stringify(data.details, null, 2));
            }
            showPlanOutput("Failed to generate a plan.\n" + errorMsg);
        } else {
            // Show the AI's generated plan (you can further parse this if you want)
            const content = data.choices[0]?.message?.content || "No plan generated.";
            showPlanOutput(content);
        }
    } catch (err) {
        showPlanOutput("An error occurred: " + err.message);
        console.error(err);
    } finally {
        generateBIPSpinner.classList.add('hidden');
        generateBIPButton.disabled = false;
        sessionStatusDisplay.textContent = "Active";
    }
}

// Register the click handler once DOM is loaded
generateBIPButton.addEventListener('click', (e) => {
    e.preventDefault();
    generatePlan();
});
