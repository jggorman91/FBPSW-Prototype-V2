<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Function Based Problem Solving Worksheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com/"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e3f2fd; color: #334155; line-height: 1.6; }
        .container { max-width: 1200px; margin: 1.5rem auto; padding: 2rem; background-color: #fff; border-radius: 1.25rem; box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); }
        .card { background-color: #fff; border-radius: 1rem; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08); padding: 1.75rem; margin-bottom: 1.75rem; border: 1px solid #d0eaff; }
        textarea, input[type="text"], input[type="number"], input[type="date"], select {
            border: 2px solid #90caf9; border-radius: 0.625rem; padding: 0.875rem; width: 100%; font-size: 1rem; line-height: 1.5;
        }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus {
            outline: none; border-color: #2196f3; box-shadow: 0 0 0 4px rgba(33,150,243,0.3);
        }
        button { display: inline-flex; align-items: center; justify-content: center; padding: 0.875rem 1.5rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s, transform 0.15s, box-shadow 0.3s; box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        button:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
        .btn-primary { background-color: #2196f3; color: #fff; border: none; background-image: linear-gradient(to right,#2196f3,#1976d2);}
        .btn-primary:hover { background-color: #1976d2; background-image: linear-gradient(to right,#1976d2,#1565c0);}
        .btn-secondary { background-color: #e0e0e0; color: #424242; border: 1px solid #bdbdbd; background-image: linear-gradient(to right,#e0e0e0,#cccccc);}
        .btn-secondary:hover { background-color: #cccccc; border-color: #9e9e9e; background-image: linear-gradient(to right,#cccccc,#9e9e9e);}
        .loading-spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin-right: 0.5rem;}
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .plan-section { margin-bottom: 1.5rem; }
        .plan-section h3 { font-weight: 700; margin-bottom: 0.75rem; color: #1976d2; font-size: 1.375rem;}
        .behavior-block { border: 2px solid #90caf9; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; background-color: #e3f2fd; box-shadow: 0 4px 8px rgba(0,0,0,0.08);}
        .behavior-block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 2px solid #64b5f6;}
        .info-modal-parent {
            position: relative; 
        }
        .info-modal {
            left: 0; 
            top: 100%; 
            min-width: 320px; 
            max-width: 500px; 
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container">
        <h1 class="text-4xl font-extrabold text-center text-blue-700 mb-8">
            Function Based Problem Solving Worksheet
        </h1>

        <div class="card flex justify-between items-center bg-blue-50 border border-blue-200 p-4 mb-6">
            <p class="text-blue-800 font-semibold">FBPSW: <span id="sessionStatusDisplay" class="font-normal text-blue-600">Active</span></p>
            <button id="newPlanButton" class="btn-secondary">
                <i class="fas fa-plus mr-2"></i> New Plan
            </button>
        </div>

        <div class="card">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Teacher Input</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="studentAge" class="block text-gray-700 text-sm font-semibold mb-2">Student Age</label>
                    <input type="number" id="studentAge" placeholder="e.g., 7" min="3" max="18">
                </div>
                <div>
                    <label for="studentGrade" class="block text-gray-700 text-sm font-semibold mb-2">Student Grade Level</label>
                    <select id="studentGrade">
                        <option value="">Select Grade</option>
                        <option value="K">Kindergarten</option>
                        <option value="1st">1st Grade</option>
                        <option value="2nd">2nd Grade</option>
                        <option value="3rd">3rd Grade</option>
                        <option value="4th">4th Grade</option>
                        <option value="5th">5th Grade</option>
                        <option value="6th">6th Grade</option>
                        <option value="7th">7th Grade</option>
                        <option value="8th">8th Grade</option>
                        <option value="Higher">Higher Grades</option>
                        <option value="Other">Other / Not Applicable</option>
                    </select>
                </div>
                <div id="behaviorsContainer" class="md:col-span-2">
                    <div class="behavior-block" data-behavior-index="0">
                        <div class="behavior-block-header">
                            <h3 class="text-lg font-semibold text-gray-700">Behavior Pattern 1</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="behaviorTypeSelect_0" class="block text-gray-700 text-sm font-semibold mb-2">Behavior Type</label>
                                <select id="behaviorTypeSelect_0">
                                    <option value="">Select Behavior Type</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="antecedentSelect_0" class="block text-gray-700 text-sm font-semibold mb-2">Antecedent</label>
                                <select id="antecedentSelect_0">
                                    <option value="">Select Antecedent</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="behaviorSelect_0" class="block text-gray-700 text-sm font-semibold mb-2">Specific Behavior</label>
                                <select id="behaviorSelect_0">
                                    <option value="">Select Specific Behavior</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="consequenceSelect_0" class="block text-gray-700 text-sm font-semibold mb-2">Typical Consequence</label>
                                <select id="consequenceSelect_0">
                                    <option value="">Select Consequence</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="behavior-block" data-behavior-index="1">
                        <div class="behavior-block-header">
                                <h3 class="text-lg font-semibold text-gray-700">Behavior Pattern 2 (Optional)</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div>
                                <label for="behaviorTypeSelect_1" class="block text-gray-700 text-sm font-semibold mb-2">Behavior Type</label>
                                <select id="behaviorTypeSelect_1">
                                    <option value="">Select Behavior Type</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="antecedentSelect_1" class="block text-gray-700 text-sm font-semibold mb-2">Antecedent</label>
                                <select id="antecedentSelect_1">
                                    <option value="">Select Antecedent</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="behaviorSelect_1" class="block text-gray-700 text-sm font-semibold mb-2">Specific Behavior</label>
                                <select id="behaviorSelect_1">
                                    <option value="">Select Specific Behavior</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="consequenceSelect_1" class="block text-gray-700 text-sm font-semibold mb-2">Typical Consequence</label>
                                <select id="consequenceSelect_1">
                                    <option value="">Select Consequence</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="behavior-block" data-behavior-index="2">
                        <div class="behavior-block-header">
                                <h3 class="text-lg font-semibold text-gray-700">Behavior Pattern 3 (Optional)</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="behaviorTypeSelect_2" class="block text-gray-700 text-sm font-semibold mb-2">Behavior Type</label>
                                <select id="behaviorTypeSelect_2">
                                    <option value="">Select Behavior Type</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="antecedentSelect_2" class="block text-gray-700 text-sm font-semibold mb-2">Antecedent</label>
                                <select id="antecedentSelect_2">
                                    <option value="">Select Antecedent</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="behaviorSelect_2" class="block text-gray-700 text-sm font-semibold mb-2">Specific Behavior</label>
                                <select id="behaviorSelect_2">
                                    <option value="">Select Specific Behavior</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="consequenceSelect_2" class="block text-gray-700 text-sm font-semibold mb-2">Typical Consequence</label>
                                <select id="consequenceSelect_2">
                                    <option value="">Select Consequence</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="anecdotal" class="block text-gray-700 text-sm font-semibold mb-2">Anecdotal Notes (include information about frequency, intensity, duration of behaviors if known)</label>
                    <textarea id="anecdotal" rows="3" placeholder="e.g., Student exhibits task refusal daily during math, lasting 5-10 minutes..."></textarea>
                </div>
                <div>
                    <label for="reinforcerPreferences" class="block text-gray-700 text-sm font-semibold mb-2">Student's Preferred Reinforcers</label>
                    <textarea id="reinforcerPreferences" rows="2" placeholder="e.g., Loves computer time, enjoys drawing..."></textarea>
                </div>

                <div class="info-modal-parent">
                    <div class="flex items-center mb-1"> 
                        <label for="behavioralSkillsSelect" class="block text-gray-700 text-sm font-semibold">Behavioral Skills Level</label>
                        <i id="behavioralInfoIcon" class="fas fa-info-circle text-blue-500 ml-2 cursor-pointer hover:text-blue-700" title="Show behavioral levels"></i>
                    </div>
                    <select id="behavioralSkillsSelect">
                        <option value="">Select Level</option>
                        <option value="Foundational Regulator">Foundational Regulator</option>
                        <option value="Guided Participant">Guided Participant</option>
                        <option value="Emerging Self-Manager">Emerging Self-Manager</option>
                        <option value="Flexible Adapter">Flexible Adapter</option>
                        <option value="Intentional Strategist">Intentional Strategist</option>
                        <option value="Reflective Adapter">Reflective Adapter</option>
                        <option value="Independent Regulator">Independent Regulator</option>
                        <option value="Strategic Manager">Strategic Manager</option>
                        <option value="Autonomous Problem-Solver">Autonomous Problem-Solver</option>
                    </select>
                    <div id="behavioralInfoModal" class="info-modal hidden absolute z-50 mt-1 p-4 bg-white border-2 border-blue-300 rounded-lg shadow-xl"> 
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-md font-semibold text-blue-700">Behavioral Developmental Levels</h4>
                            <button id="closeBehavioralModal" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
                        </div>
                        <table class="w-full text-xs table-fixed">
                            <thead class="sticky top-0 bg-blue-100">
                                <tr>
                                    <th class="p-1 text-left font-semibold text-blue-800 w-1/3">Level</th>
                                    <th class="p-1 text-left font-semibold text-blue-800 w-2/3">Description</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">
                                <tr><td class="p-1 border-t align-top">Foundational Regulator</td><td class="p-1 border-t align-top">Beginning to follow directions and respond to adult guidance.</td></tr>
                                <tr><td class="p-1 border-t align-top">Guided Participant</td><td class="p-1 border-t align-top">Learning routines and beginning to manage impulses with support.</td></tr>
                                <tr><td class="p-1 border-t align-top">Emerging Self-Manager</td><td class="p-1 border-t align-top">Following routines with less prompting; initial self-regulation.</td></tr>
                                <tr><td class="p-1 border-t align-top">Flexible Adapter</td><td class="p-1 border-t align-top">Monitors own behavior, shows flexibility, and assumes responsibility.</td></tr>
                                <tr><td class="p-1 border-t align-top">Intentional Strategist</td><td class="p-1 border-t align-top">Applies coping strategies to manage frustration and persist.</td></tr>
                                <tr><td class="p-1 border-t align-top">Reflective Adapter</td><td class="p-1 border-t align-top">Reflects on behavior and adapts to social/academic demands.</td></tr>
                                <tr><td class="p-1 border-t align-top">Independent Regulator</td><td class="p-1 border-t align-top">Demonstrates mature coping, goal-setting, and ownership.</td></tr>
                                <tr><td class="p-1 border-t align-top">Strategic Manager</td><td class="p-1 border-t align-top">Uses internal strategies to manage emotions across contexts.</td></tr>
                                <tr><td class="p-1 border-t align-top">Autonomous Problem-Solver</td><td class="p-1 border-t align-top">Independently evaluates behavior, adjusts actions, and mentors others.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="info-modal-parent">
                    <div class="flex items-center mb-1">
                        <label for="socialSkillsSelect" class="block text-gray-700 text-sm font-semibold">Social Skills Level</label>
                        <i id="socialInfoIcon" class="fas fa-info-circle text-blue-500 ml-2 cursor-pointer hover:text-blue-700" title="Show social levels"></i>
                    </div>
                    <select id="socialSkillsSelect">
                        <option value="">Select Level</option>
                        <option value="Social Initiator">Social Initiator</option>
                        <option value="Emerging Peer">Emerging Peer</option>
                        <option value="Collaborative Partner">Collaborative Partner</option>
                        <option value="Connected Participant">Connected Participant</option>
                        <option value="Social Navigator">Social Navigator</option>
                        <option value="Empathetic Ally">Empathetic Ally</option>
                        <option value="Relational Strategist">Relational Strategist</option>
                        <option value="Social Integrator">Social Integrator</option>
                        <option value="Leadership Model">Leadership Model</option>
                    </select>
                    <div id="socialInfoModal" class="info-modal hidden absolute z-50 mt-1 p-4 bg-white border-2 border-blue-300 rounded-lg shadow-xl">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-md font-semibold text-blue-700">Social Developmental Levels</h4>
                            <button id="closeSocialModal" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
                        </div>
                        <table class="w-full text-xs table-fixed">
                            <thead class="sticky top-0 bg-blue-100">
                                <tr>
                                    <th class="p-1 text-left font-semibold text-blue-800 w-1/3">Level</th>
                                    <th class="p-1 text-left font-semibold text-blue-800 w-2/3">Description</th>
                                </tr>
                            </thead>
                             <tbody class="text-gray-700">
                                <tr><td class="p-1 border-t align-top">Social Initiator</td><td class="p-1 border-t align-top">Begins play and initiates basic interactions.</td></tr>
                                <tr><td class="p-1 border-t align-top">Emerging Peer</td><td class="p-1 border-t align-top">Follows simple social rules and joins group activities.</td></tr>
                                <tr><td class="p-1 border-t align-top">Collaborative Partner</td><td class="p-1 border-t align-top">Solves conflicts with help and works in teams.</td></tr>
                                <tr><td class="p-1 border-t align-top">Connected Participant</td><td class="p-1 border-t align-top">Respects others' perspectives and works collaboratively.</td></tr>
                                <tr><td class="p-1 border-t align-top">Social Navigator</td><td class="p-1 border-t align-top">Forms friendships, practices inclusion, and builds group awareness.</td></tr>
                                <tr><td class="p-1 border-t align-top">Empathetic Ally</td><td class="p-1 border-t align-top">Leads with empathy and supports peer conflict resolution.</td></tr>
                                <tr><td class="p-1 border-t align-top">Relational Strategist</td><td class="p-1 border-t align-top">Manages peer dynamics and balances identity with belonging.</td></tr>
                                <tr><td class="p-1 border-t align-top">Social Integrator</td><td class="p-1 border-t align-top">Navigates complex relationships and group roles.</td></tr>
                                <tr><td class="p-1 border-t align-top">Leadership Model</td><td class="p-1 border-t align-top">Models inclusive behavior and mentors peers in social settings.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="info-modal-parent">
                    <div class="flex items-center mb-1">
                        <label for="pragmaticLanguageSkillsSelect" class="block text-gray-700 text-sm font-semibold">Pragmatic Language Skills Level</label>
                        <i id="pragmaticInfoIcon" class="fas fa-info-circle text-blue-500 ml-2 cursor-pointer hover:text-blue-700" title="Show pragmatic language levels"></i>
                    </div>
                    <select id="pragmaticLanguageSkillsSelect">
                        <option value="">Select Level</option>
                        <option value="Foundational Communicator">Foundational Communicator</option>
                        <option value="Emerging Conversationalist">Emerging Conversationalist</option>
                        <option value="Functional Speaker">Functional Speaker</option>
                        <option value="Social Interpreter">Social Interpreter</option>
                        <option value="Contextual Communicator">Contextual Communicator</option>
                        <option value="Purposeful Speaker">Purposeful Speaker</option>
                        <option value="Strategic Conversationalist">Strategic Conversationalist</option>
                        <option value="Adaptive Communicator">Adaptive Communicator</option>
                        <option value="Discourse Leader">Discourse Leader</option>
                    </select>
                     <div id="pragmaticInfoModal" class="info-modal hidden absolute z-50 mt-1 p-4 bg-white border-2 border-blue-300 rounded-lg shadow-xl">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-md font-semibold text-blue-700">Pragmatic Language Developmental Levels</h4>
                            <button id="closePragmaticModal" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
                        </div>
                        <table class="w-full text-xs table-fixed">
                            <thead class="sticky top-0 bg-blue-100">
                                <tr>
                                    <th class="p-1 text-left font-semibold text-blue-800 w-1/3">Level</th>
                                    <th class="p-1 text-left font-semibold text-blue-800 w-2/3">Description</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">
                                <tr><td class="p-1 border-t align-top">Foundational Communicator</td><td class="p-1 border-t align-top">Uses basic language to meet needs and respond socially.</td></tr>
                                <tr><td class="p-1 border-t align-top">Emerging Conversationalist</td><td class="p-1 border-t align-top">Engages in brief conversations using polite language.</td></tr>
                                <tr><td class="p-1 border-t align-top">Functional Speaker</td><td class="p-1 border-t align-top">Maintains conversations and clarifies messages.</td></tr>
                                <tr><td class="p-1 border-t align-top">Social Interpreter</td><td class="p-1 border-t align-top">Uses humor, negotiation, and topic maintenance.</td></tr>
                                <tr><td class="p-1 border-t align-top">Contextual Communicator</td><td class="p-1 border-t align-top">Adjusts tone and provides contextually relevant language.</td></tr>
                                <tr><td class="p-1 border-t align-top">Purposeful Speaker</td><td class="p-1 border-t align-top">Persuades, repairs misunderstandings, and discusses purposefully.</td></tr>
                                <tr><td class="p-1 border-t align-top">Strategic Conversationalist</td><td class="p-1 border-t align-top">Uses nuance and engages in advanced dialogue.</td></tr>
                                <tr><td class="p-1 border-t align-top">Adaptive Communicator</td><td class="p-1 border-t align-top">Adjusts language across academic, social, and emotional situations.</td></tr>
                                <tr><td class="p-1 border-t align-top">Discourse Leader</td><td class="p-1 border-t align-top">Engages in abstract, persuasive, and advocacy-oriented dialogue.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-gray-700 text-sm font-semibold mb-2">Add pertinent referral information?</label>
                    <div class="flex items-center space-x-4 mb-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="addReferralInfo" value="yes" class="form-radio" id="addReferralYes">
                            <span class="ml-2 text-gray-700">Yes</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="addReferralInfo" value="no" class="form-radio" id="addReferralNo" checked>
                            <span class="ml-2 text-gray-700">No</span>
                        </label>
                    </div>
                    <div id="referralInfoContainer" class="hidden">
                        <label for="referral" class="block text-gray-700 text-sm font-semibold mb-2">Referral Information</label>
                        <textarea id="referral" rows="4" placeholder="e.g., Student referred for disruptive behavior..."></textarea>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="generateBIPButton" class="btn-primary">
                    <span id="generateBIPSpinner" class="loading-spinner hidden"></span>
                    Generate Plan
                </button>
            </div>
        </div>

        <div id="bipOutput" class="card hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Generated Function Based Problem Solving Worksheet</h2>
            <div class="mb-4">
                <p id="bipFunctionHypothesis" class="text-blue-600 font-medium text-xl whitespace-pre-line"></p>
            </div>
            <div class="plan-section">
                <h3>Antecedent Strategies:</h3>
                <div id="bipAntecedentStrategies" class="prose max-w-none text-gray-800"></div>
            </div>
            <div class="plan-section">
                <h3>Short-term Replacement Behaviors:</h3>
                <div id="bipShortTermBehaviors" class="prose max-w-none text-gray-800"></div>
            </div>
            <div class="plan-section">
                <h3>Teaching Strategies for Short-Term Replacement Behaviors:</h3>
                <div id="bipTeachingStrategies" class="prose max-w-none text-gray-800"></div>
            </div>
            <div class="plan-section">
                <h3>Reinforcement Strategies for Short-Term Replacement Behaviors:</h3>
                <div id="bipReinforcementShortTerm" class="prose max-w-none text-gray-800"></div>
            </div>
            <div class="plan-section">
                <h3>Long-term Replacement Behaviors:</h3>
                <div id="bipLongTermBehaviors" class="prose max-w-none text-gray-800"></div>
            </div>
            <div class="plan-section">
                <h3>Response Strategies for Problem Behavior:</h3>
                <div id="bipResponseStrategies" class="prose max-w-none text-gray-800"></div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="copyBIPButton" class="btn-secondary">
                    <i class="fas fa-copy mr-2"></i> Copy Plan
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Data from PDF for ABC dropdowns ---
        const bipData = {
            "Physical Aggression": {
                antecedents: ["Task or work demand (difficult or nonpreferred task)", "Being told \"no\" or denied a request", "Transition events (e.g. end of a preferred activity, start of a non-preferred activity)", "Negative peer interactions (teasing, play fights)", "Sensory or environmental triggers (e.g. loud noise, bright lights)", "Long waits or unclear routines"],
                behaviors: ["Biting, hitting, kicking or punching peers or staff", "Throwing, smashing or hurling objects at others or on the floor", "Pushing, shoving, or charging at classmates", "Spitting at others"],
                consequences: ["Adult intervention (e.g. removal to time-out, staff physically stopping the behavior)", "Removal of task or allowance of a break (escape of demand)", "Verbal reprimand or redirection by teacher", "Loss of privileges (e.g. no recess, loss of special activities)", "Peers move away (social escape)"]
            },
            "Verbal Aggression": {
                antecedents: ["Being told \"no,\" corrected or reprimanded", "Frustration with tasks or requests", "Peer provocation or conflict", "Sudden changes or transitions"],
                behaviors: ["Shouting, screaming, or yelling at others", "Name-calling, insults, or profanity directed at peers or adults", "Verbal threats or defiant statements", "Saying \"no\" or arguing with an adult about an instruction"],
                consequences: ["Teacher redirection or verbal reprimand (attention given)", "Student sent to time-out or isolated", "Loss of privileges (e.g. removal from group)", "Peers react (laughter or avoidance)"]
            },
            "Self-Injurious Behavior": {
                antecedents: ["High task demands or frustration (escape)", "Sensory overload or discomfort (e.g. noisy, crowded environment)", "Emotional distress (anxiety, fatigue)", "Physical discomfort (hunger, pain)"],
                behaviors: ["Head hitting or banging against desk, wall, or floor", "Hand or arm biting", "Slapping or scratching one's own body or face", "Hair pulling", "Rocking, hand-flapping, or other repetitive motions (self-stimulatory)"],
                consequences: ["Teacher or aide physically blocks or holds the student to ensure safety", "Task may be removed or student given a break", "Staff provide comfort or attention", "Possible time-out or medical check"]
            },
            "Task Refusal / Noncompliance": {
                antecedents: ["Presentation of a non-preferred or difficult academic demand", "Transition to a non-preferred task", "Being told \"no\" (denied permission)", "Large or lengthy assignments", "Unclear instructions"],
                behaviors: ["Verbal refusal (saying \"no,\" arguing)", "Ignoring the instruction (looking away, covering ears)", "Physically leaving the area or pushing materials away", "Crying, screaming, or tantruming to protest"],
                consequences: ["Task is removed or postponed (student escapes demand)", "Student given a break or allowed preferred activity", "Teacher re-delivers the task or uses prompts", "If tantrum occurs, adult attention may inadvertently reinforce escape"]
            },
            "Elopement (Running Away)": {
                antecedents: ["Being in a non-preferred or overstimulating setting", "Transitions (e.g. before entering a disliked class)", "Unstructured times (e.g. free play, waiting)"],
                behaviors: ["Leaving a supervised area without permission (running out of classroom, playground, hallway or school grounds)", "Climbing fences or running through doors", "Moving rapidly toward an appealing location (e.g. exit, office) or away from demands"],
                consequences: ["Staff chase or physically redirect the student (safety hold)", "Student returned to supervised area (often with close monitoring)", "Removal of privileges or additional supervision", "Student may accidentally be reinforced if elopement leads to escape of the disliked situation"]
            },
            "Disruptive Behavior (Non-Aggressive)": {
                antecedents: ["Boring or highly demanding tasks (student seeks stimulation)", "Long instructional periods without breaks", "Lack of engagement with work", "Unsupervised or unstructured periods", "Need for attention"],
                behaviors: ["Talking out of turn or calling out answers", "Making noises (tapping desk, jingling items, humming)", "Frequent whining or complaining", "Out-of-seat behavior (wandering classroom, showing items)", "Mild defiance (refusing minor requests, interrupting peers)"],
                consequences: ["Teacher attention through redirection or scolding (gaining attention)", "Loss of privileges or rewards", "Brief time-out", "Classmates may laugh or react (peer attention)", "If ignored, student may successfully delay task (escape reinforcement)"]
            },
            "Off-Task Behavior": {
                antecedents: ["Academic work that is too difficult (frustration) or too easy/uninteresting (boredom)", "Lack of clear instructions", "Slow-paced or repetitive tasks", "Insufficient structure or environmental distractions"],
                behaviors: ["Daydreaming, staring into space", "Fiddling with materials, doodling, or handling unrelated objects", "Beginning a task very slowly or on wrong assignment", "Pretending to work while doing something else (e.g. playing on a device)", "Asking off-topic questions to stall"],
                consequences: ["Teacher prompts or reminders to focus (teacher attention)", "Task may be simplified or re-taught", "Student may lose participation privileges or breaks", "If behavior continues, student may be removed from task (escape from demand)"]
            },
            "Property Destruction": { 
                antecedents: [
                    "Task demand", 
                    "Denied access to desired object or activity (frustration)",
                    "Unstructured moments with access to items",
                    "High emotional arousal (e.g. after reprimand)"
                ],
                behaviors: [
                    "Clearing materials off of desk", 
                    "Tearing or ripping paper, books, or clothing",
                    "Bending, breaking, or smashing objects (toys, furniture, pencil)",
                    "Drawing on or carving into walls, desks or personal property",
                    "Kicking or punching walls or furniture",
                    "Throwing objects forcefully to break them"
                ],
                consequences: [
                    "Student required to clean up or repair damage",
                    "Loss of access to items (item taken away) or privileges",
                    "Time-out or removal from class",
                    "Teacher reprimand or referral"
                ]
            }
        };

        // DOM elements
        const studentAgeInput = document.getElementById('studentAge');
        const studentGradeSelect = document.getElementById('studentGrade');
        const reinforcerPreferencesInput = document.getElementById('reinforcerPreferences');
        const behavioralSkillsSelect = document.getElementById('behavioralSkillsSelect');
        const socialSkillsSelect = document.getElementById('socialSkillsSelect');
        const pragmaticLanguageSkillsSelect = document.getElementById('pragmaticLanguageSkillsSelect');
        const anecdotalInput = document.getElementById('anecdotal');
        const referralInput = document.getElementById('referral');
        const generateBIPButton = document.getElementById('generateBIPButton');
        const generateBIPSpinner = document.getElementById('generateBIPSpinner');
        const bipOutputDiv = document.getElementById('bipOutput');
        const bipFunctionHypothesis = document.getElementById('bipFunctionHypothesis');
        const bipAntecedentStrategies = document.getElementById('bipAntecedentStrategies');
        const bipShortTermBehaviors = document.getElementById('bipShortTermBehaviors');
        const bipTeachingStrategies = document.getElementById('bipTeachingStrategies');
        const bipReinforcementShortTerm = document.getElementById('bipReinforcementShortTerm');
        const bipLongTermBehaviors = document.getElementById('bipLongTermBehaviors');
        const bipResponseStrategies = document.getElementById('bipResponseStrategies');
        const copyBIPButton = document.getElementById('copyBIPButton');
        const sessionStatusDisplay = document.getElementById('sessionStatusDisplay');
        const addReferralYes = document.getElementById('addReferralYes');
        const addReferralNo = document.getElementById('addReferralNo');
        const referralInfoContainer = document.getElementById('referralInfoContainer');

        const behavioralInfoIcon = document.getElementById('behavioralInfoIcon');
        const behavioralInfoModal = document.getElementById('behavioralInfoModal');
        const closeBehavioralModalButton = document.getElementById('closeBehavioralModal');

        const socialInfoIcon = document.getElementById('socialInfoIcon');
        const socialInfoModal = document.getElementById('socialInfoModal');
        const closeSocialModalButton = document.getElementById('closeSocialModal');

        const pragmaticInfoIcon = document.getElementById('pragmaticInfoIcon');
        const pragmaticInfoModal = document.getElementById('pragmaticInfoModal');
        const closePragmaticModalButton = document.getElementById('closePragmaticModal');


        addReferralYes.addEventListener('change', () => {
            referralInfoContainer.classList.remove('hidden');
        });
        addReferralNo.addEventListener('change', () => {
            referralInfoContainer.classList.add('hidden');
        });

        function populateSelectWithOptions(selectElement, optionsArray, defaultOptionText, keepOther = true) {
            let otherOptionHTML = '';
            if (keepOther) {
                const existingOther = selectElement.querySelector('option[value="Other"]');
                if (existingOther) {
                    otherOptionHTML = existingOther.outerHTML; 
                } else {
                    otherOptionHTML = '<option value="Other">Other (Specify in Notes)</option>';
                }
            }
            selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`; 
            if (optionsArray && Array.isArray(optionsArray)) { 
                optionsArray.forEach(optionText => {
                    const option = document.createElement('option');
                    option.value = optionText;
                    option.textContent = optionText;
                    selectElement.appendChild(option);
                });
            }
            if (keepOther && otherOptionHTML) { 
                selectElement.insertAdjacentHTML('beforeend', otherOptionHTML);
            }
        }

        function initializeBehaviorDropdowns() {
            const behaviorTypeKeys = Object.keys(bipData);
            for (let i = 0; i < 3; i++) {
                const behaviorTypeSelect = document.getElementById(`behaviorTypeSelect_${i}`);
                const antecedentSelect = document.getElementById(`antecedentSelect_${i}`);
                const behaviorSelect = document.getElementById(`behaviorSelect_${i}`);
                const consequenceSelect = document.getElementById(`consequenceSelect_${i}`);

                if (!behaviorTypeSelect) {
                    console.error(`ERROR: Element with ID 'behaviorTypeSelect_${i}' not found.`);
                    continue; 
                }
                if (!antecedentSelect) console.warn(`Warning: Element with ID 'antecedentSelect_${i}' not found. Dependent dropdown will not work for block ${i}.`);
                if (!behaviorSelect) console.warn(`Warning: Element with ID 'behaviorSelect_${i}' not found. Dependent dropdown will not work for block ${i}.`);
                if (!consequenceSelect) console.warn(`Warning: Element with ID 'consequenceSelect_${i}' not found. Dependent dropdown will not work for block ${i}.`);
                
                populateSelectWithOptions(behaviorTypeSelect, behaviorTypeKeys, "Select Behavior Type");

                behaviorTypeSelect.addEventListener('change', function() {
                    const selectedBehaviorType = this.value;
                    if (selectedBehaviorType && bipData[selectedBehaviorType]) {
                        if (antecedentSelect) populateSelectWithOptions(antecedentSelect, bipData[selectedBehaviorType].antecedents, "Select Antecedent");
                        if (behaviorSelect) populateSelectWithOptions(behaviorSelect, bipData[selectedBehaviorType].behaviors, "Select Specific Behavior");
                        if (consequenceSelect) populateSelectWithOptions(consequenceSelect, bipData[selectedBehaviorType].consequences, "Select Consequence");
                    } else {
                        if (antecedentSelect) populateSelectWithOptions(antecedentSelect, [], "Select Antecedent (after choosing type)");
                        if (behaviorSelect) populateSelectWithOptions(behaviorSelect, [], "Select Specific Behavior (after choosing type)");
                        if (consequenceSelect) populateSelectWithOptions(consequenceSelect, [], "Select Consequence (after choosing type)");
                    }
                });
                if (antecedentSelect) populateSelectWithOptions(antecedentSelect, [], "Select Antecedent (after choosing type)");
                if (behaviorSelect) populateSelectWithOptions(behaviorSelect, [], "Select Specific Behavior (after choosing type)");
                if (consequenceSelect) populateSelectWithOptions(consequenceSelect, [], "Select Consequence (after choosing type)");
            }
        }
        
        function setupInfoModal(iconId, modalId, closeButtonId) {
            const icon = document.getElementById(iconId);
            const modal = document.getElementById(modalId);
            const closeButton = document.getElementById(closeButtonId);

            if (icon && modal) {
                icon.addEventListener('click', (event) => {
                    event.stopPropagation();
                    [behavioralInfoModal, socialInfoModal, pragmaticInfoModal].forEach(m => {
                        if (m && m !== modal) m.classList.add('hidden');
                    });
                    modal.classList.toggle('hidden');
                });
            }
            if (closeButton && modal) {
                closeButton.addEventListener('click', () => {
                    modal.classList.add('hidden');
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeBehaviorDropdowns();
            setupInfoModal('behavioralInfoIcon', 'behavioralInfoModal', 'closeBehavioralModal');
            setupInfoModal('socialInfoIcon', 'socialInfoModal', 'closeSocialModal');
            setupInfoModal('pragmaticInfoIcon', 'pragmaticInfoModal', 'closePragmaticModal');
        });

        document.addEventListener('click', (event) => {
            const modals = [behavioralInfoModal, socialInfoModal, pragmaticInfoModal];
            const icons = [behavioralInfoIcon, socialInfoIcon, pragmaticInfoIcon];

            modals.forEach((modal, index) => {
                if (modal && !modal.classList.contains('hidden')) {
                    let currentIcon = icons[index]; 
                    let targetIsIconOrChild = false;
                    if (currentIcon) { 
                        targetIsIconOrChild = currentIcon.contains(event.target) || currentIcon === event.target;
                    }

                    if (!modal.contains(event.target) && !targetIsIconOrChild) {
                        modal.classList.add('hidden');
                    }
                }
            });
        });

        // MODIFICATION START: Updated createPromptFromForm function
        function createPromptFromForm() {
            const age = studentAgeInput.value || 'Not specified';
            const grade = studentGradeSelect.value || 'Not specified';
            const reinforcers = reinforcerPreferencesInput.value || 'Not specified';
            
            let anecdotal = anecdotalInput.value || 'No specific anecdotal notes provided.';
            if (anecdotalInput.value && !anecdotalInput.value.toLowerCase().includes("daily") && !anecdotalInput.value.toLowerCase().includes("weekly") && !anecdotalInput.value.toLowerCase().includes("often") && !anecdotalInput.value.toLowerCase().includes("frequently")) {
                anecdotal += " (Note: Assume these behavioral observations represent recurring patterns over time unless otherwise specified in the patterns below.)";
            }

            const referral = referralInput && !referralInfoContainer.classList.contains('hidden') ? referralInput.value : '';
            const behavioralLevel = behavioralSkillsSelect.value || 'Not specified';
            const socialLevel = socialSkillsSelect.value || 'Not specified';
            const pragmaticLevel = pragmaticLanguageSkillsSelect.value || 'Not specified';

            function getBehaviorBlock(index) {
                const typeSelect = document.getElementById(`behaviorTypeSelect_${index}`);
                const antecedentSelect = document.getElementById(`antecedentSelect_${index}`);
                const behaviorSelect = document.getElementById(`behaviorSelect_${index}`);
                const consequenceSelect = document.getElementById(`consequenceSelect_${index}`);

                const type = typeSelect ? typeSelect.value : '';
                const antecedent = antecedentSelect ? antecedentSelect.value : '';
                const behavior = behaviorSelect ? behaviorSelect.value : '';
                const consequence = consequenceSelect ? consequenceSelect.value : '';
                
                let result = '';
                if (type || antecedent || behavior || consequence) {
                    result = `Observed Recurring Behavior Pattern ${index + 1} (ABC Data):\n  Selected Behavior Type: ${type || 'Not specified'}\n  Selected Antecedent: ${antecedent || 'Not specified'}\n  Selected Specific Behavior: ${behavior || 'Not specified'}\n  Selected Typical Consequence: ${consequence || 'Not specified'}`;
                }
                return result;
            }
            const behaviors = [0,1,2].map(getBehaviorBlock).filter(Boolean).join('\n\n');

            const evidenceBasedStrategies = `
ADDITIONAL GUIDANCE FOR REPLACEMENT BEHAVIORS:
When developing the 'Short-term Replacement Behaviors', 'Teaching Strategies for Short-Term Replacement Behaviors', 'Reinforcement Strategies for Short-Term Replacement Behaviors', and 'Long-term Replacement Behaviors' sections, please consider the following evidence-based approaches, categorized by common behavioral functions. First, hypothesize the function based on the provided ABC data and student information. Then, select and adapt strategies relevant to that hypothesized function.

1. For ATTENTION-SEEKING BEHAVIORS:
   - Functional Communication Training (FCT): Teach appropriate ways to gain attention (e.g., raising hand, using a "help" card, polite verbal requests like "Excuse me" or "Am I doing good work?"). Immediately reinforce these appropriate requests with praise or desired interaction.
   - Scheduled Attention/Check-ins (Noncontingent Reinforcement - NCR): Provide brief, positive interactions on a regular schedule (e.g., every 10-15 minutes) regardless of the student's current behavior. This predictability can reduce anxiety about getting attention. Always use these check-ins to reinforce expected behaviors.
   - Differential Reinforcement of Alternative Behavior (DRA): Provide attention and rewards exclusively for the appropriate replacement behavior for seeking attention. Withhold attention/rewards when the problem attention-seeking behavior occurs.
   - Visual Supports & Social Stories: Use visual cues (e.g., picture of hand-raising) and social narratives to clearly illustrate expected methods for seeking attention and waiting for a turn.
   - Planned Ignoring & Redirecting: Consistently ignore minor, safe attention-seeking actions. When the student attempts the appropriate replacement behavior, immediately provide attention or praise. (Not for aggressive or self-injurious behaviors).

2. For ESCAPE/AVOIDANCE BEHAVIORS:
   - FCT for Breaks/Help: Teach the student to request breaks or assistance using cards, pictures, or specific phrases (e.g., "I need a break," "Help please," "I don't understand") when tasks are difficult. Reinforce these requests.
   - Choice-Making: Offer limited, appropriate choices related to tasks to increase the student's sense of control (e.g., "Worksheet with pencil or marker?", "Work at desk or on the rug?"). The core task requirement remains.
   - Task Modification & Support: Break down difficult tasks into smaller, manageable steps; simplify instructions; or shorten work sessions. Provide visual aids or one-on-one help. Consider high-probability request sequences.
   - Scheduled Breaks (NCR for Escape): Implement brief, routine breaks independent of the student's behavior (e.g., a short walk every 10 minutes of work).
   - Visual Timers & Priming: Use timers, countdowns, or visual schedules to show remaining task time. Provide advance warnings for transitions or changes in activity.

3. For ACCESS-TO-TANGIBLES BEHAVIORS:
   - FCT for Requests: Teach clear and appropriate ways to request desired items or activities (e.g., "Can I have X, please?", picture exchange). Immediately honor successful, appropriate requests.
   - Differential Reinforcement (DRA): Reinforce only appropriate requesting behaviors. Withhold the desired tangible item/activity when the student uses problem behaviors (e.g., grabbing, tantrums) to try to obtain it.
   - Scheduled Access & Token Systems: Plan regular, predictable opportunities for the student to access preferred items or activities. Use visual systems like "first/then" boards or token economies to link task completion with access to tangibles.
   - Sharing and Turn-Taking Skills: Explicitly teach, model, and practice skills for sharing and taking turns, using role-play, timers, and scripts. Reinforce cooperative behaviors.

4. For SENSORY-STIMULATION BEHAVIORS:
   - Sensory Breaks & Movement: Schedule regular opportunities for appropriate sensory or motor activities (e.g., jumping jacks, wall push-ups, short walks, stretch breaks, trampoline time) to provide needed input in a planned way.
   - Sensory Tools & Alternatives: Provide a selection of acceptable sensory items (e.g., stress balls, fidget toys, chewable jewelry) and teach the student when and how to use them as an alternative to inappropriate sensory-seeking behaviors. Praise appropriate use.
   - Environmental Modifications: Adapt the learning environment to reduce sensory overload (e.g., allow noise-canceling headphones, dim lights, provide a quieter workspace). Prepare the student for known sensory events using schedules or priming.
   - Calming & Self-Regulation Techniques: Teach simple coping strategies like deep breathing, counting, or using a designated "calm-down corner." Practice these techniques when the student is calm.
Remember that all strategies should be consistently implemented across settings and by all relevant staff.
`;

            const hypothesisGenerationInstructions = `
IMPORTANT INSTRUCTION FOR 'Function Hypothesis Statement':
For the 'Function Hypothesis Statement' section, you MUST synthesize the provided ABC data (Antecedent, Behavior, Consequence from the selected patterns and/or anecdotal notes) to formulate a clear and concise hypothesis.
The statement MUST strictly follow this structure:
'When [accurately describe the specific antecedent conditions based on input, e.g., 'When asked to complete non-preferred academic tasks'], the student will [accurately describe the specific observable problem behavior based on input, e.g., 'tear worksheets and refuse to write'] because [accurately describe what the student typically obtains or escapes as a result of the behavior, linking to the provided consequence data or inferred maintaining consequence, e.g., 'the task is often delayed or removed' or 'they receive peer attention'] therefore, the function of the behavior appears to be [clearly state the single primary hypothesized function: e.g., 'escape from academic demands', 'to gain attention', 'to access preferred items', 'automatic reinforcement due to sensory input'].'
Ensure each part of this structured hypothesis ([antecedent], [behavior], [consequence/reason], and [function]) is directly derived from and consistent with the student information and behavior patterns provided. Do not use placeholders like "[antecedent]" in your actual output; fill them with specific descriptions based on the input.
`;

            return `
Act as an expert Board Certified Behavior Analyst (BCBA) in a school setting. Your primary task is to develop a comprehensive and actionable Behavior Intervention Plan (BIP) based on the student information provided below.

It is crucial to understand that the observed behaviors described are **recurring patterns that have been happening over time**, not isolated incidents. Therefore, the entire BIP, including all strategies, must reflect this understanding of chronicity and learned history.

Student Information:
Student Age: ${age}
Grade: ${grade}
Preferred Reinforcers: ${reinforcers}
Anecdotal Notes (including context of recurrence, frequency, intensity, duration if available): ${anecdotal}
${referral ? "Referral Information: " + referral : ""}
Current Behavioral Skills Level: ${behavioralLevel}
Current Social Skills Level: ${socialLevel}
Current Pragmatic Language Skills Level: ${pragmaticLevel}

Observed Recurring Behavior Patterns (ABC Data - based on dropdown selections):
${behaviors || 'No specific recurring behavior patterns selected. If none are detailed, use the anecdotal notes to infer patterns and hypothesize the most likely ABC sequence.'}

${evidenceBasedStrategies}

${hypothesisGenerationInstructions}

Please generate the Behavior Intervention Plan. Format your response using these section headings (exactly as written). Ensure ALL sections are thoroughly addressed with specific, actionable, and research-based strategies appropriate for a school environment, drawing from the evidence-based strategies provided above where relevant to the hypothesized function. **You should act as if you have all necessary information to complete every section of the plan comprehensively and should attempt to provide recommendations for all listed sections. Do not state that more information is needed for any section; instead, provide the best possible strategies based on the information at hand.**

**Critically, the 'Response Strategies for Problem Behavior' section must be detailed and robust.** This section should clearly outline:
1.  Immediate actions to take when the problem behavior pattern occurs to ensure the safety of the student and others.
2.  De-escalation techniques suitable for the described behavior patterns and student characteristics.
3.  Clear, brief, and consistent verbal and non-verbal responses from staff.
4.  Procedures for follow-up after an incident, including re-teaching, and how to return the student to the learning environment.
5.  Avoid strategies that could inadvertently reinforce the problem behavior based on its hypothesized function.

Required BIP Sections:
Function Hypothesis Statement:
Antecedent Strategies:
Short-term Replacement Behaviors:
Teaching Strategies for Short-Term Replacement Behaviors:
Reinforcement Strategies for Short-Term Replacement Behaviors:
Long-term Replacement Behaviors:
Response Strategies for Problem Behavior:
            `.trim();
        }
        // MODIFICATION END: Updated createPromptFromForm function

        function parsePlanSections(planText) {
            console.log("[FRONTEND] parsePlanSections received planText (length):", planText.length);
            const sectionKeys = [ 
                "Function Hypothesis Statement", "Antecedent Strategies", "Short-term Replacement Behaviors",
                "Teaching Strategies for Short-Term Replacement Behaviors", "Reinforcement Strategies for Short-Term Replacement Behaviors",
                "Long-term Replacement Behaviors", "Response Strategies for Problem Behavior"
            ];
            const sections = {};
            sectionKeys.forEach(key => sections[key] = ""); 

            const lines = planText.split('\n');
            let currentSectionKey = null;
            let contentForCurrentSection = [];

            for (const line of lines) {
                let matchedNewSection = false;
                for (const key of sectionKeys) {
                    const trimmedLine = line.trim();
                    const pattern = new RegExp(`^(?:\\*\\*)?${key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}(?:\\*\\*)?:`, "i");
                    if (pattern.test(trimmedLine)) {
                        if (currentSectionKey && contentForCurrentSection.length > 0) {
                            sections[currentSectionKey] = contentForCurrentSection.join('\n').trim();
                        }
                        currentSectionKey = key;
                        contentForCurrentSection = []; 
                        const contentOnHeadingLine = trimmedLine.replace(pattern, "").trim();
                        if (contentOnHeadingLine) contentForCurrentSection.push(contentOnHeadingLine);
                        matchedNewSection = true;
                        break; 
                    }
                }
                if (!matchedNewSection && currentSectionKey) {
                    if (line.trim() !== "" || contentForCurrentSection.length > 0) contentForCurrentSection.push(line); 
                }
            }
            if (currentSectionKey && contentForCurrentSection.length > 0) {
                sections[currentSectionKey] = contentForCurrentSection.join('\n').trim();
            }
            for (let key in sections) sections[key] = sections[key].trim();
            console.log("[FRONTEND] parsePlanSections generated sections:", JSON.parse(JSON.stringify(sections)));
            return sections;
        }

        // MODIFICATION START: Updated showPlanSections function
        function showPlanSections(sections) {
            console.log("[FRONTEND] showPlanSections received sections:", JSON.parse(JSON.stringify(sections)));
            const fallbackMsg = "The AI attempted to generate this section but may require more specific input for optimal results. Review and refine as needed, ensuring it follows the 'When... will... because... therefore...' format.";
            
            // The AI is now expected to return the full "When...will...because...therefore..." statement for aiGeneratedFullHypothesis
            const aiGeneratedFullHypothesis = sections["Function Hypothesis Statement"] || fallbackMsg; 
            
            const hypothesisDisplayPrefixLine1 = "Function Hypothesis Statement - The following provides an overview of the current behavior(s).";
            const hypothesisDisplayPrefixLine2 = "Summary Statement: "; // Simplified prefix

            const formattedHypothesisText = `${hypothesisDisplayPrefixLine1}\n${hypothesisDisplayPrefixLine2}${aiGeneratedFullHypothesis}`;
            bipFunctionHypothesis.textContent = formattedHypothesisText;
            // Adding a class to handle potential line breaks within the AI's hypothesis and the prefix.
            bipFunctionHypothesis.classList.add('whitespace-pre-line'); 
            
            bipAntecedentStrategies.textContent = sections["Antecedent Strategies"] || fallbackMsg;
            bipShortTermBehaviors.textContent = sections["Short-term Replacement Behaviors"] || fallbackMsg;
            bipTeachingStrategies.textContent = sections["Teaching Strategies for Short-Term Replacement Behaviors"] || fallbackMsg;
            bipReinforcementShortTerm.textContent = sections["Reinforcement Strategies for Short-Term Replacement Behaviors"] || fallbackMsg;
            bipLongTermBehaviors.textContent = sections["Long-term Replacement Behaviors"] || fallbackMsg;
            bipResponseStrategies.textContent = sections["Response Strategies for Problem Behavior"] || fallbackMsg; 
            bipOutputDiv.classList.remove('hidden');
            console.log("[FRONTEND] bipOutputDiv should now be visible.");
        }
        // MODIFICATION END: Updated showPlanSections function


        function showErrorOutput(msg) {
            console.log("[FRONTEND] showErrorOutput called with msg:", msg);
            bipFunctionHypothesis.textContent = msg; 
            bipFunctionHypothesis.classList.add('whitespace-pre-line');
            bipAntecedentStrategies.textContent = ""; 
            bipShortTermBehaviors.textContent = "";
            bipTeachingStrategies.textContent = "";
            bipReinforcementShortTerm.textContent = "";
            bipLongTermBehaviors.textContent = "";
            bipResponseStrategies.textContent = ""; 
            bipOutputDiv.classList.remove('hidden');
        }

        function hidePlanOutput() {
            bipFunctionHypothesis.textContent = "";
            bipAntecedentStrategies.textContent = "";
            bipShortTermBehaviors.textContent = "";
            bipTeachingStrategies.textContent = "";
            bipReinforcementShortTerm.textContent = "";
            bipLongTermBehaviors.textContent = "";
            bipResponseStrategies.textContent = ""; 
            bipOutputDiv.classList.add('hidden');
        }

        async function generatePlanWithGemini() {
            console.log("[FRONTEND] generatePlanWithGemini called");
            generateBIPSpinner.classList.remove('hidden');
            generateBIPButton.disabled = true;
            sessionStatusDisplay.textContent = "Generating...";
            hidePlanOutput();
            const userGeneratedPrompt = createPromptFromForm();
            console.log("[FRONTEND] Generated prompt for backend (first 500 chars):", userGeneratedPrompt.substring(0,500) + "..."); 
            const backendApiUrl = '/api/ask'; 
            const requestBody = { prompt: userGeneratedPrompt };
            try {
                const response = await fetch(backendApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                console.log("[FRONTEND] Received response from backend. Status:", response.status, "Ok:", response.ok); 
                const data = await response.json();
                console.log("[FRONTEND] Parsed data from backend response (structure check):", data ? "Data received" : "No data received");
                if (!response.ok) {
                    let errorMsg = data.error || `Request failed with status ${response.status}`;
                    if (data.details) errorMsg += `\nDetails: ${typeof data.details === 'object' ? JSON.stringify(data.details) : data.details}`;
                    showErrorOutput("Failed to generate a plan (server error).\n" + errorMsg);
                    console.error("[FRONTEND] Backend Error (response not ok):", data);
                } else if (data.error) { 
                    let errorMsg = data.error.message || JSON.stringify(data.error, null, 2);
                    if (data.error.details) errorMsg += `\nDetails: ${JSON.stringify(data.error.details, null, 2)}`;
                    showErrorOutput("Failed to generate a plan (API error).\n" + errorMsg);
                    console.error("[FRONTEND] Gemini API Error (via backend, data.error is present):", data.error);
                } else if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0 && data.candidates[0].content.parts[0].text) {
                    console.log("[FRONTEND] Valid candidates found in data. Processing plan.");
                    const planText = data.candidates[0].content.parts[0].text;
                    const sections = parsePlanSections(planText);
                    showPlanSections(sections);
                } else {
                    let specificError = "Received an unexpected response from the server or no plan was generated.";
                    if (data.candidates && data.candidates.length > 0 && data.candidates[0].finishReason) {
                         specificError = `The response generation finished with reason: ${data.candidates[0].finishReason}. `;
                         if (data.candidates[0].finishReason === "SAFETY") {
                             specificError += "This often means the content was blocked by safety filters. Review input and safety settings. ";
                             console.warn("[FRONTEND] Response blocked due to SAFETY finishReason", data.candidates[0].safetyRatings);
                         } else if (data.candidates[0].finishReason === "MAX_TOKENS") {
                              specificError += "The maximum number of tokens for the response was reached. The plan may be incomplete. ";
                         } else if (data.candidates[0].finishReason === "RECITATION") {
                              specificError += "The response was blocked due to detected recitation from a source. ";
                         }
                    } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                         specificError = `The prompt was blocked by the API. Reason: ${data.promptFeedback.blockReason}.`;
                         if (data.promptFeedback.safetyRatings) specificError += ` Details: ${JSON.stringify(data.promptFeedback.safetyRatings)}`;
                         console.warn("[FRONTEND] Prompt blocked by API", data.promptFeedback);
                    } else {
                        console.log("[FRONTEND] Response OK, but no valid candidates or text found in data, or unexpected structure."); 
                        console.error("[FRONTEND] Unexpected successful response structure:", data);
                    }
                    showErrorOutput(specificError);
                }
            } catch (err) {
                console.error("[FRONTEND] Error in fetch try-catch block (e.g., network error, or response.json() failed):", err); 
                showErrorOutput("An error occurred while communicating with the server: " + err.message);
            } finally {
                generateBIPSpinner.classList.add('hidden');
                generateBIPButton.disabled = false;
                sessionStatusDisplay.textContent = "Active";
                console.log("[FRONTEND] generatePlanWithGemini finished.");
            }
        }

        generateBIPButton.addEventListener('click', (e) => {
            e.preventDefault();
            generatePlanWithGemini();
        });

        copyBIPButton.addEventListener('click', () => {
            let textToCopy = 
`${bipFunctionHypothesis.textContent} 

Antecedent Strategies:
${bipAntecedentStrategies.textContent}

Short-term Replacement Behaviors:
${bipShortTermBehaviors.textContent}

Teaching Strategies for Short-Term Replacement Behaviors:
${bipTeachingStrategies.textContent}

Reinforcement Strategies for Short-Term Replacement Behaviors:
${bipReinforcementShortTerm.textContent}

Long-term Replacement Behaviors:
${bipLongTermBehaviors.textContent}

Response Strategies for Problem Behavior:
${bipResponseStrategies.textContent}
`;
            navigator.clipboard.writeText(textToCopy.trim()); 
            const originalButtonText = copyBIPButton.innerHTML; 
            copyBIPButton.innerHTML = '<i class="fas fa-check mr-2"></i> Copied!';
            setTimeout(() => { copyBIPButton.innerHTML = originalButtonText; }, 2000);
        });

        document.getElementById('newPlanButton').addEventListener('click', () => {
            studentAgeInput.value = '';
            studentGradeSelect.value = '';
            reinforcerPreferencesInput.value = '';
            anecdotalInput.value = '';
            referralInput.value = '';
            behavioralSkillsSelect.value = '';
            socialSkillsSelect.value = '';
            pragmaticLanguageSkillsSelect.value = '';
            for (let i = 0; i < 3; i++) {
                const behaviorTypeSelect = document.getElementById(`behaviorTypeSelect_${i}`);
                if (behaviorTypeSelect) { 
                    behaviorTypeSelect.value = '';
                    behaviorTypeSelect.dispatchEvent(new Event('change'));
                }

                const antecedentSelect = document.getElementById(`antecedentSelect_${i}`);
                if (antecedentSelect) antecedentSelect.innerHTML = '<option value="">Select Antecedent (after choosing type)</option><option value="Other">Other (Specify in Notes)</option>';
                
                const behaviorSelect = document.getElementById(`behaviorSelect_${i}`);
                if (behaviorSelect) behaviorSelect.innerHTML = '<option value="">Select Specific Behavior (after choosing type)</option><option value="Other">Other (Specify in Notes)</option>';
                
                const consequenceSelect = document.getElementById(`consequenceSelect_${i}`);
                if (consequenceSelect) consequenceSelect.innerHTML = '<option value="">Select Consequence (after choosing type)</option><option value="Other">Other (Specify in Notes)</option>';
            }
            addReferralNo.checked = true;
            referralInfoContainer.classList.add('hidden');
            hidePlanOutput();
            sessionStatusDisplay.textContent = "Active";
            console.log("[FRONTEND] New plan started, fields cleared.");
        });
    </script>
</body>
</html>
