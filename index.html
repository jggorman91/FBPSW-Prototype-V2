<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BIP Generator</title>
  <style>
    .section { margin: 1em 0; }
    .output { white-space: pre-wrap; background: #f4f4f4; padding: 1em; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Behavior Intervention Plan (BIP) Generator</h1>

  <!-- Student Info Inputs -->
  <div class="section">
    <label>Grade: <input type="text" id="grade" /></label><br>
    <label>Student Age: <input type="text" id="age" /></label><br>
    <label>Strengths: <input type="text" id="strengths" /></label><br>
    <label>Reinforcers: <input type="text" id="reinforcers" /></label><br>
  </div>

  <!-- ABC Dropdowns -->
  <div class="section">
    <label>Antecedent:
      <select id="antecedent">
        <option value="">Select...</option>
        <option value="Change in routine">Change in routine</option>
        <option value="Given difficult task">Given difficult task</option>
      </select>
    </label><br>

    <label>Behavior:
      <select id="behavior">
        <option value="">Select...</option>
        <option value="Leaving work area">Leaving work area</option>
        <option value="Crying/Yelling">Crying/Yelling</option>
      </select>
    </label><br>

    <label>Consequence:
      <select id="consequence">
        <option value="">Select...</option>
        <option value="Break given">Break given</option>
        <option value="Attention from adult">Attention from adult</option>
      </select>
    </label>
  </div>

  <button id="generateBIPButton">Generate Plan</button>
  <div id="generateBIPSpinner" style="display:none;">Loading...</div>
  <div id="sessionStatusDisplay"></div>

  <div class="section output" id="responseOutput">Your plan will appear here.</div>

  <script>
    function createPromptFromForm() {
      const grade = document.getElementById("grade").value;
      const age = document.getElementById("age").value;
      const strengths = document.getElementById("strengths").value;
      const reinforcers = document.getElementById("reinforcers").value;
      const antecedent = document.getElementById("antecedent").value;
      const behavior = document.getElementById("behavior").value;
      const consequence = document.getElementById("consequence").value;

      return `Act as an expert BCBA in a school setting. Create a comprehensive Behavior Intervention Plan (BIP) for a student with the following details:
- Grade: ${grade || "Not specified"}
- Age: ${age || "Not specified"}
- Strengths: ${strengths || "Not specified"}
- Reinforcers: ${reinforcers || "Not specified"}
- Observed Behavior: ${behavior || "Not specified"}
- Antecedent: ${antecedent || "Not specified"}
- Consequence: ${consequence || "Not specified"}

Format the response into:
1. Function Hypothesis Statement
2. Antecedent Strategies
3. Short-term Replacement Behaviors
4. Teaching Strategies for Short-term Replacement Behaviors
5. Reinforcement Strategies for Short-term Replacement Behaviors
6. Long-term Replacement Behaviors
7. Response Strategies for Problem Behavior`;
    }

    async function askGemini(prompt) {
      const res = await fetch('https://us-central1-teacherbehaviorhubapp.cloudfunctions.net/askGemini', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });

      if (!res.ok) {
        const errorText = await res.text();
        console.error("Cloud Function Error Response:", errorText);
        throw new Error("Cloud Function call failed");
      }

      const data = await res.json();
      return data;
    }

    async function generatePlanWithGemini() {
      const prompt = createPromptFromForm();
      document.getElementById("generateBIPSpinner").style.display = 'inline';
      document.getElementById("generateBIPButton").disabled = true;
      document.getElementById("sessionStatusDisplay").textContent = "Generating...";

      try {
        const responseData = await askGemini(prompt);
        if (responseData && typeof responseData.plan === "string") {
          document.getElementById("responseOutput").textContent = responseData.plan;
          document.getElementById("sessionStatusDisplay").textContent = "Success!";
        } else {
          document.getElementById("responseOutput").textContent = "Unexpected structure or no plan returned.";
          document.getElementById("sessionStatusDisplay").textContent = "Error";
        }
      } catch (err) {
        console.error(err);
        document.getElementById("responseOutput").textContent = "Error: " + err.message;
        document.getElementById("sessionStatusDisplay").textContent = "Failed";
      } finally {
        document.getElementById("generateBIPSpinner").style.display = 'none';
        document.getElementById("generateBIPButton").disabled = false;
      }
    }

    document.getElementById("generateBIPButton").addEventListener("click", generatePlanWithGemini);
  </script>
</body>
</html>