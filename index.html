<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Function Based Problem Solving Worksheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com/"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e3f2fd; color: #334155; line-height: 1.6; }
        .container { max-width: 1200px; margin: 1.5rem auto; padding: 2rem; background-color: #fff; border-radius: 1.25rem; box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); }
        .card { background-color: #fff; border-radius: 1rem; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08); padding: 1.75rem; margin-bottom: 1.75rem; border: 1px solid #d0eaff; }
        textarea, input[type="text"], input[type="number"], input[type="date"], select {
            border: 2px solid #90caf9; border-radius: 0.625rem; padding: 0.875rem; width: 100%; font-size: 1rem; line-height: 1.5;
        }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus {
            outline: none; border-color: #2196f3; box-shadow: 0 0 0 4px rgba(33,150,243,0.3);
        }
        button { display: inline-flex; align-items: center; justify-content: center; padding: 0.875rem 1.5rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s, transform 0.15s, box-shadow 0.3s; box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        button:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
        .btn-primary { background-color: #2196f3; color: #fff; border: none; background-image: linear-gradient(to right,#2196f3,#1976d2);}
        .btn-primary:hover { background-color: #1976d2; background-image: linear-gradient(to right,#1976d2,#1565c0);}
        .btn-secondary { background-color: #e0e0e0; color: #424242; border: 1px solid #bdbdbd; background-image: linear-gradient(to right,#e0e0e0,#cccccc);}
        .btn-secondary:hover { background-color: #cccccc; border-color: #9e9e9e; background-image: linear-gradient(to right,#cccccc,#9e9e9e);}
        .loading-spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin-right: 0.5rem;}
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .plan-section { margin-bottom: 1.5rem; }
        .plan-section h3 { font-weight: 700; margin-bottom: 0.75rem; color: #1976d2; font-size: 1.375rem;}
        .behavior-block { border: 2px solid #90caf9; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; background-color: #e3f2fd; box-shadow: 0 4px 8px rgba(0,0,0,0.08);}
        .behavior-block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 2px solid #64b5f6;}
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container">
        <h1 class="text-4xl font-extrabold text-center text-blue-700 mb-8">
            Function Based Problem Solving Worksheet
        </h1>

        <div class="card flex justify-between items-center bg-blue-50 border border-blue-200 p-4 mb-6">
            <p class="text-blue-800 font-semibold">FBPSW: <span id="sessionStatusDisplay" class="font-normal text-blue-600">Active</span></p>
            <button id="newPlanButton" class="btn-secondary">
                <i class="fas fa-plus mr-2"></i> New Plan
            </button>
        </div>

        <div class="card">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Teacher Input</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="studentAge" class="block text-gray-700 text-sm font-semibold mb-2">Student Age</label>
                    <input type="number" id="studentAge" placeholder="e.g., 7" min="3" max="18">
                </div>
                <div>
                    <label for="studentGrade" class="block text-gray-700 text-sm font-semibold mb-2">Student Grade Level</label>
                    <select id="studentGrade">
                        <option value="">Select Grade</option>
                        <option value="K">Kindergarten</option>
                        <option value="1st">1st Grade</option>
                        <option value="2nd">2nd Grade</option>
                        <option value="3rd">3rd Grade</option>
                        <option value="4th">4th Grade</option>
                        <option value="5th">5th Grade</option>
                        <option value="6th">6th Grade</option>
                        <option value="7th">7th Grade</option>
                        <option value="8th">8th Grade</option>
                        <option value="Higher">Higher Grades</option>
                        <option value="Other">Other / Not Applicable</option>
                    </select>
                </div>
                <div id="behaviorsContainer" class="md:col-span-2">
                    <div class="behavior-block" data-behavior-index="0">
                        <div class="behavior-block-header">
                            <h3 class="text-lg font-semibold text-gray-700">Behavior Pattern 1</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="behaviorTypeSelect_0" class="block text-gray-700 text-sm font-semibold mb-2">Behavior Type</label>
                                <select id="behaviorTypeSelect_0">
                                    <option value="">Select Behavior Type</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="antecedentSelect_0" class="block text-gray-700 text-sm font-semibold mb-2">Antecedent</label>
                                <select id="antecedentSelect_0">
                                    <option value="">Select Antecedent</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="behaviorSelect_0" class="block text-gray-700 text-sm font-semibold mb-2">Specific Behavior</label>
                                <select id="behaviorSelect_0">
                                    <option value="">Select Specific Behavior</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="consequenceSelect_0" class="block text-gray-700 text-sm font-semibold mb-2">Typical Consequence</label>
                                <select id="consequenceSelect_0">
                                    <option value="">Select Consequence</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="behavior-block" data-behavior-index="1">
                        <div class="behavior-block-header">
                                <h3 class="text-lg font-semibold text-gray-700">Behavior Pattern 2 (Optional)</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div>
                                <label for="behaviorTypeSelect_1" class="block text-gray-700 text-sm font-semibold mb-2">Behavior Type</label>
                                <select id="behaviorTypeSelect_1">
                                    <option value="">Select Behavior Type</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="antecedentSelect_1" class="block text-gray-700 text-sm font-semibold mb-2">Antecedent</label>
                                <select id="antecedentSelect_1">
                                    <option value="">Select Antecedent</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="behaviorSelect_1" class="block text-gray-700 text-sm font-semibold mb-2">Specific Behavior</label>
                                <select id="behaviorSelect_1">
                                    <option value="">Select Specific Behavior</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="consequenceSelect_1" class="block text-gray-700 text-sm font-semibold mb-2">Typical Consequence</label>
                                <select id="consequenceSelect_1">
                                    <option value="">Select Consequence</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="behavior-block" data-behavior-index="2">
                        <div class="behavior-block-header">
                                <h3 class="text-lg font-semibold text-gray-700">Behavior Pattern 3 (Optional)</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="behaviorTypeSelect_2" class="block text-gray-700 text-sm font-semibold mb-2">Behavior Type</label>
                                <select id="behaviorTypeSelect_2">
                                    <option value="">Select Behavior Type</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="antecedentSelect_2" class="block text-gray-700 text-sm font-semibold mb-2">Antecedent</label>
                                <select id="antecedentSelect_2">
                                    <option value="">Select Antecedent</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="behaviorSelect_2" class="block text-gray-700 text-sm font-semibold mb-2">Specific Behavior</label>
                                <select id="behaviorSelect_2">
                                    <option value="">Select Specific Behavior</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="consequenceSelect_2" class="block text-gray-700 text-sm font-semibold mb-2">Typical Consequence</label>
                                <select id="consequenceSelect_2">
                                    <option value="">Select Consequence</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="anecdotal" class="block text-gray-700 text-sm font-semibold mb-2">Anecdotal Notes (include information about frequency, intensity, duration of behaviors if known)</label>
                    <textarea id="anecdotal" rows="3" placeholder="e.g., Student exhibits task refusal daily during math, lasting 5-10 minutes..."></textarea>
                </div>
                <div>
                    <label for="reinforcerPreferences" class="block text-gray-700 text-sm font-semibold mb-2">Student's Preferred Reinforcers</label>
                    <textarea id="reinforcerPreferences" rows="2" placeholder="e.g., Loves computer time, enjoys drawing..."></textarea>
                </div>
                <div>
                    <label for="behavioralSkillsSelect" class="block text-gray-700 text-sm font-semibold mb-2">Behavioral Skills Level</label>
                    <select id="behavioralSkillsSelect">
                        <option value="">Select Level</option>
                        <option value="Emerging Regulator">Emerging Regulator</option>
                        <option value="Developing Follower">Developing Follower</option>
                        <option value="Routine Participant">Routine Participant</option>
                        <option value="Adaptive Monitor">Adaptive Monitor</option>
                        <option value="Intentional Regulator">Intentional Regulator</option>
                        <option value="Reflective Manager">Reflective Manager</option>
                        <option value="Independent Self-Regulator">Independent Self-Regulator</option>
                        <option value="Strategic Self-Manager">Strategic Self-Manager</option>
                        <option value="Autonomous Problem-Solver">Autonomous Problem-Solver</option>
                    </select>
                </div>
                <div>
                    <label for="socialSkillsSelect" class="block text-gray-700 text-sm font-semibold mb-2">Social Skills Level</label>
                    <select id="socialSkillsSelect">
                        <option value="">Select Level</option>
                        <option value="Social Explorer">Social Explorer</option>
                        <option value="Emerging Friend">Emerging Friend</option>
                        <option value="Cooperative Peer">Cooperative Peer</option>
                        <option value="Connected Contributor">Connected Contributor</option>
                        <option value="Social Navigator">Social Navigator</option>
                        <option value="Empathetic Collaborator">Empathetic Collaborator</option>
                        <option value="Interpersonal Strategist">Interpersonal Strategist</option>
                        <option value="Relational Thinker">Relational Thinker</option>
                        <option value="Social Leader">Social Leader</option>
                    </select>
                </div>
                <div>
                    <label for="pragmaticLanguageSkillsSelect" class="block text-gray-700 text-sm font-semibold mb-2">Pragmatic Language Skills Level</label>
                    <select id="pragmaticLanguageSkillsSelect">
                        <option value="">Select Level</option>
                        <option value="Beginning Communicator">Beginning Communicator</option>
                        <option value="Emerging Conversationalist">Emerging Conversationalist</option>
                        <option value="Functional Talker">Functional Talker</option>
                        <option value="Social Interpreter">Social Interpreter</option>
                        <option value="Contextual Communicator">Contextual Communicator</option>
                        <option value="Purposeful Speaker">Purposeful Speaker</option>
                        <option value="Strategic Conversationalist">Strategic Conversationalist</option>
                        <option value="Flexible Communicator">Flexible Communicator</option>
                        <option value="Advanced Discourse User">Advanced Discourse User</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-gray-700 text-sm font-semibold mb-2">Add pertinent referral information?</label>
                    <div class="flex items-center space-x-4 mb-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="addReferralInfo" value="yes" class="form-radio" id="addReferralYes">
                            <span class="ml-2 text-gray-700">Yes</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="addReferralInfo" value="no" class="form-radio" id="addReferralNo" checked>
                            <span class="ml-2 text-gray-700">No</span>
                        </label>
                    </div>
                    <div id="referralInfoContainer" class="hidden">
                        <label for="referral" class="block text-gray-700 text-sm font-semibold mb-2">Referral Information</label>
                        <textarea id="referral" rows="4" placeholder="e.g., Student referred for disruptive behavior..."></textarea>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="generateBIPButton" class="btn-primary">
                    <span id="generateBIPSpinner" class="loading-spinner hidden"></span>
                    Generate Plan
                </button>
            </div>
        </div>

        <div id="bipOutput" class="card hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Generated Function Based Problem Solving Worksheet</h2>
            <div class="mb-4">
                <p class="text-lg font-semibold text-gray-700">Function Hypothesis Statement:</p>
                <p id="bipFunctionHypothesis" class="text-blue-600 font-medium text-xl"></p>
            </div>
            <div class="plan-section">
                <h3>Antecedent Strategies:</h3>
                <div id="bipAntecedentStrategies" class="prose max-w-none text-gray-800"></div>
            </div>
            <div class="plan-section">
                <h3>Short-term Replacement Behaviors:</h3>
                <div id="bipShortTermBehaviors" class="prose max-w-none text-gray-800"></div>
            </div>
            <div class="plan-section">
                <h3>Teaching Strategies for Short-Term Replacement Behaviors:</h3>
                <div id="bipTeachingStrategies" class="prose max-w-none text-gray-800"></div>
            </div>
            <div class="plan-section">
                <h3>Reinforcement Strategies for Short-Term Replacement Behaviors:</h3>
                <div id="bipReinforcementShortTerm" class="prose max-w-none text-gray-800"></div>
            </div>
            <div class="plan-section">
                <h3>Long-term Replacement Behaviors:</h3>
                <div id="bipLongTermBehaviors" class="prose max-w-none text-gray-800"></div>
            </div>
            <div class="plan-section">
                <h3>Response Strategies for Problem Behavior:</h3>
                <div id="bipResponseStrategies" class="prose max-w-none text-gray-800"></div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="copyBIPButton" class="btn-secondary">
                    <i class="fas fa-copy mr-2"></i> Copy Plan
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Data from PDF for dropdowns ---
        const bipData = {
            "Physical Aggression": {
                antecedents: ["Task or work demand (difficult or nonpreferred task)", "Being told \"no\" or denied a request", "Transition events (e.g. end of a preferred activity, start of a non-preferred activity)", "Negative peer interactions (teasing, play fights)", "Sensory or environmental triggers (e.g. loud noise, bright lights)", "Long waits or unclear routines"],
                behaviors: ["Biting, hitting, kicking or punching peers or staff", "Throwing, smashing or hurling objects at others or on the floor", "Pushing, shoving, or charging at classmates", "Spitting at others"],
                consequences: ["Adult intervention (e.g. removal to time-out, staff physically stopping the behavior)", "Removal of task or allowance of a break (escape of demand)", "Verbal reprimand or redirection by teacher", "Loss of privileges (e.g. no recess, loss of special activities)", "Peers move away (social escape)"]
            },
            "Verbal Aggression": {
                antecedents: ["Being told \"no,\" corrected or reprimanded", "Frustration with tasks or requests", "Peer provocation or conflict", "Sudden changes or transitions"],
                behaviors: ["Shouting, screaming, or yelling at others", "Name-calling, insults, or profanity directed at peers or adults", "Verbal threats or defiant statements", "Saying \"no\" or arguing with an adult about an instruction"],
                consequences: ["Teacher redirection or verbal reprimand (attention given)", "Student sent to time-out or isolated", "Loss of privileges (e.g. removal from group)", "Peers react (laughter or avoidance)"]
            },
            "Self-Injurious Behavior": {
                antecedents: ["High task demands or frustration (escape)", "Sensory overload or discomfort (e.g. noisy, crowded environment)", "Emotional distress (anxiety, fatigue)", "Physical discomfort (hunger, pain)"],
                behaviors: ["Head hitting or banging against desk, wall, or floor", "Hand or arm biting", "Slapping or scratching one's own body or face", "Hair pulling", "Rocking, hand-flapping, or other repetitive motions (self-stimulatory)"],
                consequences: ["Teacher or aide physically blocks or holds the student to ensure safety", "Task may be removed or student given a break", "Staff provide comfort or attention", "Possible time-out or medical check"]
            },
            "Task Refusal / Noncompliance": {
                antecedents: ["Presentation of a non-preferred or difficult academic demand", "Transition to a non-preferred task", "Being told \"no\" (denied permission)", "Large or lengthy assignments", "Unclear instructions"],
                behaviors: ["Verbal refusal (saying \"no,\" arguing)", "Ignoring the instruction (looking away, covering ears)", "Physically leaving the area or pushing materials away", "Crying, screaming, or tantruming to protest"],
                consequences: ["Task is removed or postponed (student escapes demand)", "Student given a break or allowed preferred activity", "Teacher re-delivers the task or uses prompts", "If tantrum occurs, adult attention may inadvertently reinforce escape"]
            },
            "Elopement (Running Away)": {
                antecedents: ["Being in a non-preferred or overstimulating setting", "Transitions (e.g. before entering a disliked class)", "Unstructured times (e.g. free play, waiting)"],
                behaviors: ["Leaving a supervised area without permission (running out of classroom, playground, hallway or school grounds)", "Climbing fences or running through doors", "Moving rapidly toward an appealing location (e.g. exit, office) or away from demands"],
                consequences: ["Staff chase or physically redirect the student (safety hold)", "Student returned to supervised area (often with close monitoring)", "Removal of privileges or additional supervision", "Student may accidentally be reinforced if elopement leads to escape of the disliked situation"]
            },
            "Disruptive Behavior (Non-Aggressive)": {
                antecedents: ["Boring or highly demanding tasks (student seeks stimulation)", "Long instructional periods without breaks", "Lack of engagement with work", "Unsupervised or unstructured periods", "Need for attention"],
                behaviors: ["Talking out of turn or calling out answers", "Making noises (tapping desk, jingling items, humming)", "Frequent whining or complaining", "Out-of-seat behavior (wandering classroom, showing items)", "Mild defiance (refusing minor requests, interrupting peers)"],
                consequences: ["Teacher attention through redirection or scolding (gaining attention)", "Loss of privileges or rewards", "Brief time-out", "Classmates may laugh or react (peer attention)", "If ignored, student may successfully delay task (escape reinforcement)"]
            },
            "Off-Task Behavior": {
                antecedents: ["Academic work that is too difficult (frustration) or too easy/uninteresting (boredom)", "Lack of clear instructions", "Slow-paced or repetitive tasks", "Insufficient structure or environmental distractions"],
                behaviors: ["Daydreaming, staring into space", "Fiddling with materials, doodling, or handling unrelated objects", "Beginning a task very slowly or on wrong assignment", "Pretending to work while doing something else (e.g. playing on a device)", "Asking off-topic questions to stall"],
                consequences: ["Teacher prompts or reminders to focus (teacher attention)", "Task may be simplified or re-taught", "Student may lose participation privileges or breaks", "If behavior continues, student may be removed from task (escape from demand)"]
            },
            "Property Destruction": {
                antecedents: ["Denied access to desired object or activity (frustration)", "Unstructured moments with access to items", "High emotional arousal (e.g. after reprimand)"],
                behaviors: ["Tearing or ripping paper, books, or clothing", "Bending, breaking, or smashing objects (toys, furniture, pencil)", "Drawing on or carving into walls, desks or personal property", "Kicking or punching walls or furniture", "Throwing objects forcefully to break them"],
                consequences: ["Student required to clean up or repair damage", "Loss of access to items (item taken away) or privileges", "Time-out or removal from class", "Teacher reprimand or referral"]
            }
        };

        // DOM elements
        const studentAgeInput = document.getElementById('studentAge');
        const studentGradeSelect = document.getElementById('studentGrade');
        // ... (all your other existing DOM element consts)
        const reinforcerPreferencesInput = document.getElementById('reinforcerPreferences');
        const behavioralSkillsSelect = document.getElementById('behavioralSkillsSelect');
        const socialSkillsSelect = document.getElementById('socialSkillsSelect');
        const pragmaticLanguageSkillsSelect = document.getElementById('pragmaticLanguageSkillsSelect');
        const anecdotalInput = document.getElementById('anecdotal');
        const referralInput = document.getElementById('referral');
        const generateBIPButton = document.getElementById('generateBIPButton');
        const generateBIPSpinner = document.getElementById('generateBIPSpinner');
        const bipOutputDiv = document.getElementById('bipOutput');
        const bipFunctionHypothesis = document.getElementById('bipFunctionHypothesis');
        const bipAntecedentStrategies = document.getElementById('bipAntecedentStrategies');
        const bipShortTermBehaviors = document.getElementById('bipShortTermBehaviors');
        const bipTeachingStrategies = document.getElementById('bipTeachingStrategies');
        const bipReinforcementShortTerm = document.getElementById('bipReinforcementShortTerm');
        const bipLongTermBehaviors = document.getElementById('bipLongTermBehaviors');
        const bipResponseStrategies = document.getElementById('bipResponseStrategies');
        const copyBIPButton = document.getElementById('copyBIPButton');
        const sessionStatusDisplay = document.getElementById('sessionStatusDisplay');
        const addReferralYes = document.getElementById('addReferralYes');
        const addReferralNo = document.getElementById('addReferralNo');
        const referralInfoContainer = document.getElementById('referralInfoContainer');


        addReferralYes.addEventListener('change', () => {
            referralInfoContainer.classList.remove('hidden');
        });
        addReferralNo.addEventListener('change', () => {
            referralInfoContainer.classList.add('hidden');
        });

        function populateSelectWithOptions(selectElement, optionsArray, defaultOptionText, keepOther = true) {
            const existingOtherOption = selectElement.querySelector('option[value="Other"]');
            selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`; // Clear existing options and add default

            optionsArray.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectElement.appendChild(option);
            });

            if (keepOther && existingOtherOption) {
                 selectElement.appendChild(existingOtherOption.cloneNode(true));
            } else if (keepOther && !existingOtherOption) { // Add "Other" if it wasn't there but should be
                const otherOption = document.createElement('option');
                otherOption.value = "Other";
                otherOption.textContent = "Other (Specify in Notes)";
                selectElement.appendChild(otherOption);
            }
        }

        function initializeBehaviorDropdowns() {
            const behaviorTypeKeys = Object.keys(bipData);

            for (let i = 0; i < 3; i++) {
                const behaviorTypeSelect = document.getElementById(`behaviorTypeSelect_${i}`);
                const antecedentSelect = document.getElementById(`antecedentSelect_${i}`);
                const behaviorSelect = document.getElementById(`behaviorSelect_${i}`);
                const consequenceSelect = document.getElementById(`consequenceSelect_${i}`);

                // Populate Behavior Type
                populateSelectWithOptions(behaviorTypeSelect, behaviorTypeKeys, "Select Behavior Type");

                behaviorTypeSelect.addEventListener('change', function() {
                    const selectedBehaviorType = this.value;
                    if (selectedBehaviorType && bipData[selectedBehaviorType]) {
                        populateSelectWithOptions(antecedentSelect, bipData[selectedBehaviorType].antecedents, "Select Antecedent");
                        populateSelectWithOptions(behaviorSelect, bipData[selectedBehaviorType].behaviors, "Select Specific Behavior");
                        populateSelectWithOptions(consequenceSelect, bipData[selectedBehaviorType].consequences, "Select Consequence");
                    } else {
                        // Reset dependent dropdowns if "Select Behavior Type" or "Other" is chosen initially
                        populateSelectWithOptions(antecedentSelect, [], "Select Antecedent (after choosing type)");
                        populateSelectWithOptions(behaviorSelect, [], "Select Specific Behavior (after choosing type)");
                        populateSelectWithOptions(consequenceSelect, [], "Select Consequence (after choosing type)");
                    }
                });
                // Initial state for dependent dropdowns
                populateSelectWithOptions(antecedentSelect, [], "Select Antecedent (after choosing type)");
                populateSelectWithOptions(behaviorSelect, [], "Select Specific Behavior (after choosing type)");
                populateSelectWithOptions(consequenceSelect, [], "Select Consequence (after choosing type)");
            }
        }
        
        // Call initialization on script load
        initializeBehaviorDropdowns();

        // --- MODIFIED createPromptFromForm FUNCTION (from your previous version) ---
        function createPromptFromForm() {
            const age = studentAgeInput.value || 'Not specified';
            const grade = studentGradeSelect.value || 'Not specified';
            const reinforcers = reinforcerPreferencesInput.value || 'Not specified';
            
            let anecdotal = anecdotalInput.value || 'No specific anecdotal notes provided.';
            if (anecdotalInput.value && !anecdotalInput.value.toLowerCase().includes("daily") && !anecdotalInput.value.toLowerCase().includes("weekly") && !anecdotalInput.value.toLowerCase().includes("often") && !anecdotalInput.value.toLowerCase().includes("frequently")) {
                anecdotal += " (Note: Assume these behavioral observations represent recurring patterns over time unless otherwise specified in the patterns below.)";
            }

            const referral = referralInput && !referralInfoContainer.classList.contains('hidden') ? referralInput.value : '';
            const behavioralLevel = behavioralSkillsSelect.value || 'Not specified';
            const socialLevel = socialSkillsSelect.value || 'Not specified';
            const pragmaticLevel = pragmaticLanguageSkillsSelect.value || 'Not specified';

            function getBehaviorBlock(index) {
                const type = document.getElementById(`behaviorTypeSelect_${index}`)?.value || '';
                const antecedent = document.getElementById(`antecedentSelect_${index}`)?.value || '';
                const behavior = document.getElementById(`behaviorSelect_${index}`)?.value || '';
                const consequence = document.getElementById(`consequenceSelect_${index}`)?.value || '';
                let result = '';
                if (type || antecedent || behavior || consequence) {
                    result = `Observed Recurring Behavior Pattern ${index + 1} (ABC Data):\n  Selected Behavior Type: ${type || 'Not specified'}\n  Selected Antecedent: ${antecedent || 'Not specified'}\n  Selected Specific Behavior: ${behavior || 'Not specified'}\n  Selected Typical Consequence: ${consequence || 'Not specified'}`;
                }
                return result;
            }
            const behaviors = [0,1,2].map(getBehaviorBlock).filter(Boolean).join('\n\n');

            return `
Act as an expert Board Certified Behavior Analyst (BCBA) in a school setting. Your primary task is to develop a comprehensive and actionable Behavior Intervention Plan (BIP) based on the student information provided below.

It is crucial to understand that the observed behaviors described are **recurring patterns that have been happening over time**, not isolated incidents. Therefore, the entire BIP, including all strategies, must reflect this understanding of chronicity and learned history.

Student Information:
Student Age: ${age}
Grade: ${grade}
Preferred Reinforcers: ${reinforcers}
Anecdotal Notes (including context of recurrence, frequency, intensity, duration if available): ${anecdotal}
${referral ? "Referral Information: " + referral : ""}
Current Behavioral Skills Level: ${behavioralLevel}
Current Social Skills Level: ${socialLevel}
Current Pragmatic Language Skills Level: ${pragmaticLevel}

Observed Recurring Behavior Patterns (ABC Data - based on dropdown selections):
${behaviors || 'No specific recurring behavior patterns selected. If none are detailed, use the anecdotal notes to infer patterns.'}

Please generate the Behavior Intervention Plan. Format your response using these section headings (exactly as written). Ensure ALL sections are thoroughly addressed with specific, actionable, and research-based strategies appropriate for a school environment.

**Critically, the 'Response Strategies for Problem Behavior' section must be detailed and robust.** This section should clearly outline:
1.  Immediate actions to take when the problem behavior pattern occurs to ensure the safety of the student and others.
2.  De-escalation techniques suitable for the described behavior patterns and student characteristics.
3.  Clear, brief, and consistent verbal and non-verbal responses from staff.
4.  Procedures for follow-up after an incident, including re-teaching, and how to return the student to the learning environment.
5.  Avoid strategies that could inadvertently reinforce the problem behavior based on its hypothesized function.

If you have no specific recommendation for a particular section despite the information provided, please explicitly state "Based on the current information, no specific strategies are recommended for this section at this time, but further observation or data collection is advised to develop this area." Do not leave any section blank or with a generic placeholder.

Required BIP Sections:
Function Hypothesis Statement:
Antecedent Strategies:
Short-term Replacement Behaviors:
Teaching Strategies for Short-Term Replacement Behaviors:
Reinforcement Strategies for Short-Term Replacement Behaviors:
Long-term Replacement Behaviors:
Response Strategies for Problem Behavior:
            `.trim();
        }

        // --- REVISED parsePlanSections FUNCTION ---
        function parsePlanSections(planText) {
            console.log("[FRONTEND] parsePlanSections received planText (length):", planText.length);
            const sectionKeys = [ 
                "Function Hypothesis Statement", "Antecedent Strategies", "Short-term Replacement Behaviors",
                "Teaching Strategies for Short-Term Replacement Behaviors", "Reinforcement Strategies for Short-Term Replacement Behaviors",
                "Long-term Replacement Behaviors", "Response Strategies for Problem Behavior"
            ];
            const sections = {};
            sectionKeys.forEach(key => sections[key] = ""); 

            const lines = planText.split('\n');
            let currentSectionKey = null;
            let contentForCurrentSection = [];

            for (const line of lines) {
                let matchedNewSection = false;
                for (const key of sectionKeys) {
                    const trimmedLine = line.trim();
                    const pattern = new RegExp(`^(?:\\*\\*)?${key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}(?:\\*\\*)?:`, "i");
                    if (pattern.test(trimmedLine)) {
                        if (currentSectionKey && contentForCurrentSection.length > 0) {
                            sections[currentSectionKey] = contentForCurrentSection.join('\n').trim();
                        }
                        currentSectionKey = key;
                        contentForCurrentSection = []; 
                        const contentOnHeadingLine = trimmedLine.replace(pattern, "").trim();
                        if (contentOnHeadingLine) contentForCurrentSection.push(contentOnHeadingLine);
                        matchedNewSection = true;
                        break; 
                    }
                }
                if (!matchedNewSection && currentSectionKey) {
                    if (line.trim() !== "" || contentForCurrentSection.length > 0) contentForCurrentSection.push(line); 
                }
            }
            if (currentSectionKey && contentForCurrentSection.length > 0) {
                sections[currentSectionKey] = contentForCurrentSection.join('\n').trim();
            }
            for (let key in sections) sections[key] = sections[key].trim();
            console.log("[FRONTEND] parsePlanSections generated sections:", JSON.parse(JSON.stringify(sections)));
            return sections;
        }

        function showPlanSections(sections) {
            console.log("[FRONTEND] showPlanSections received sections:", JSON.parse(JSON.stringify(sections)));
            const fallbackMsg = "Information not found in plan or section is empty. The AI may not have had enough information or may have missed this section. Consider revising the input or trying again.";
            bipFunctionHypothesis.textContent = sections["Function Hypothesis Statement"] || fallbackMsg;
            bipAntecedentStrategies.textContent = sections["Antecedent Strategies"] || fallbackMsg;
            bipShortTermBehaviors.textContent = sections["Short-term Replacement Behaviors"] || fallbackMsg;
            bipTeachingStrategies.textContent = sections["Teaching Strategies for Short-Term Replacement Behaviors"] || fallbackMsg;
            bipReinforcementShortTerm.textContent = sections["Reinforcement Strategies for Short-Term Replacement Behaviors"] || fallbackMsg;
            bipLongTermBehaviors.textContent = sections["Long-term Replacement Behaviors"] || fallbackMsg;
            bipResponseStrategies.textContent = sections["Response Strategies for Problem Behavior"] || fallbackMsg; 
            bipOutputDiv.classList.remove('hidden');
            console.log("[FRONTEND] bipOutputDiv should now be visible.");
        }

        function showErrorOutput(msg) {
            console.log("[FRONTEND] showErrorOutput called with msg:", msg);
            bipFunctionHypothesis.textContent = msg;
            bipAntecedentStrategies.textContent = ""; 
            bipShortTermBehaviors.textContent = "";
            bipTeachingStrategies.textContent = "";
            bipReinforcementShortTerm.textContent = "";
            bipLongTermBehaviors.textContent = "";
            bipResponseStrategies.textContent = ""; 
            bipOutputDiv.classList.remove('hidden');
        }

        function hidePlanOutput() {
            bipFunctionHypothesis.textContent = "";
            bipAntecedentStrategies.textContent = "";
            bipShortTermBehaviors.textContent = "";
            bipTeachingStrategies.textContent = "";
            bipReinforcementShortTerm.textContent = "";
            bipLongTermBehaviors.textContent = "";
            bipResponseStrategies.textContent = ""; 
            bipOutputDiv.classList.add('hidden');
        }

        async function generatePlanWithGemini() {
            console.log("[FRONTEND] generatePlanWithGemini called");
            generateBIPSpinner.classList.remove('hidden');
            generateBIPButton.disabled = true;
            sessionStatusDisplay.textContent = "Generating...";
            hidePlanOutput();
            const userGeneratedPrompt = createPromptFromForm();
            console.log("[FRONTEND] Generated prompt for backend:", userGeneratedPrompt); 
            const backendApiUrl = '/api/ask'; 
            const requestBody = { prompt: userGeneratedPrompt };
            try {
                const response = await fetch(backendApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                console.log("[FRONTEND] Received response from backend. Status:", response.status, "Ok:", response.ok); 
                const data = await response.json();
                console.log("[FRONTEND] Parsed data from backend response:", JSON.parse(JSON.stringify(data)));
                if (!response.ok) {
                    let errorMsg = data.error || `Request failed with status ${response.status}`;
                    if (data.details) errorMsg += `\nDetails: ${typeof data.details === 'object' ? JSON.stringify(data.details) : data.details}`;
                    showErrorOutput("Failed to generate a plan (server error).\n" + errorMsg);
                    console.error("[FRONTEND] Backend Error (response not ok):", data);
                } else if (data.error) { 
                    let errorMsg = data.error.message || JSON.stringify(data.error, null, 2);
                    if (data.error.details) errorMsg += `\nDetails: ${JSON.stringify(data.error.details, null, 2)}`;
                    showErrorOutput("Failed to generate a plan (API error).\n" + errorMsg);
                    console.error("[FRONTEND] Gemini API Error (via backend, data.error is present):", data.error);
                } else if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0 && data.candidates[0].content.parts[0].text) {
                    console.log("[FRONTEND] Valid candidates found in data. Processing plan.");
                    const planText = data.candidates[0].content.parts[0].text;
                    const sections = parsePlanSections(planText);
                    showPlanSections(sections);
                } else {
                    let specificError = "Received an unexpected response from the server or no plan was generated.";
                    if (data.candidates && data.candidates.length > 0 && data.candidates[0].finishReason === "SAFETY") {
                        specificError = "The response was blocked due to safety settings. Please review your input or adjust safety configurations if possible.";
                        console.warn("[FRONTEND] Response blocked due to SAFETY finishReason", data.candidates[0].safetyRatings);
                    } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                        specificError = `The prompt was blocked. Reason: ${data.promptFeedback.blockReason}.`;
                        if (data.promptFeedback.safetyRatings) specificError += ` Details: ${JSON.stringify(data.promptFeedback.safetyRatings)}`;
                        console.warn("[FRONTEND] Prompt blocked by API", data.promptFeedback);
                    } else {
                        console.log("[FRONTEND] Response OK, but no valid candidates or text found in data, or unexpected structure."); 
                        console.error("[FRONTEND] Unexpected successful response structure:", data);
                    }
                    showErrorOutput(specificError);
                }
            } catch (err) {
                console.error("[FRONTEND] Error in fetch try-catch block (e.g., network error, or response.json() failed):", err); 
                showErrorOutput("An error occurred while communicating with the server: " + err.message);
            } finally {
                generateBIPSpinner.classList.add('hidden');
                generateBIPButton.disabled = false;
                sessionStatusDisplay.textContent = "Active";
                console.log("[FRONTEND] generatePlanWithGemini finished.");
            }
        }

        generateBIPButton.addEventListener('click', (e) => {
            e.preventDefault();
            generatePlanWithGemini();
        });

        copyBIPButton.addEventListener('click', () => {
            let textToCopy = 
`Function Hypothesis Statement:
${bipFunctionHypothesis.textContent}
Antecedent Strategies:
${bipAntecedentStrategies.textContent}
Short-term Replacement Behaviors:
${bipShortTermBehaviors.textContent}
Teaching Strategies for Short-Term Replacement Behaviors:
${bipTeachingStrategies.textContent}
Reinforcement Strategies for Short-Term Replacement Behaviors:
${bipReinforcementShortTerm.textContent}
Long-term Replacement Behaviors:
${bipLongTermBehaviors.textContent}
Response Strategies for Problem Behavior:
${bipResponseStrategies.textContent}
`;
            navigator.clipboard.writeText(textToCopy);
            const originalButtonText = copyBIPButton.innerHTML; 
            copyBIPButton.innerHTML = '<i class="fas fa-check mr-2"></i> Copied!';
            setTimeout(() => { copyBIPButton.innerHTML = originalButtonText; }, 2000);
        });

        document.getElementById('newPlanButton').addEventListener('click', () => {
            studentAgeInput.value = '';
            studentGradeSelect.value = '';
            reinforcerPreferencesInput.value = '';
            anecdotalInput.value = '';
            referralInput.value = '';
            behavioralSkillsSelect.value = '';
            socialSkillsSelect.value = '';
            pragmaticLanguageSkillsSelect.value = '';
            for (let i = 0; i < 3; i++) {
                document.getElementById(`behaviorTypeSelect_${i}`).value = '';
                // Trigger change to reset dependent dropdowns
                document.getElementById(`behaviorTypeSelect_${i}`).dispatchEvent(new Event('change'));
            }
            addReferralNo.checked = true;
            referralInfoContainer.classList.add('hidden');
            hidePlanOutput();
            sessionStatusDisplay.textContent = "Active";
            console.log("[FRONTEND] New plan started, fields cleared.");
        });
    </script>
</body>
</html>
