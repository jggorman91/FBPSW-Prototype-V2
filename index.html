<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Function Based Problem Solving Worksheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com/"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e3f2fd; color: #334155; line-height: 1.6; }
        .container { max-width: 1200px; margin: 1.5rem auto; padding: 2rem; background-color: #fff; border-radius: 1.25rem; box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); }
        .card { background-color: #fff; border-radius: 1rem; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08); padding: 1.75rem; margin-bottom: 1.75rem; border: 1px solid #d0eaff; }
        textarea, input[type="text"], input[type="number"], input[type="date"], select {
            border: 2px solid #90caf9; border-radius: 0.625rem; padding: 0.875rem; width: 100%; font-size: 1rem; line-height: 1.5;
        }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus {
            outline: none; border-color: #2196f3; box-shadow: 0 0 0 4px rgba(33,150,243,0.3);
        }
        button { display: inline-flex; align-items: center; justify-content: center; padding: 0.875rem 1.5rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s, transform 0.15s, box-shadow 0.3s; box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        button:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
        .btn-primary { background-color: #2196f3; color: #fff; border: none; background-image: linear-gradient(to right,#2196f3,#1976d2);}
        .btn-primary:hover { background-color: #1976d2; background-image: linear-gradient(to right,#1976d2,#1565c0);}
        .btn-secondary { background-color: #e0e0e0; color: #424242; border: 1px solid #bdbdbd; background-image: linear-gradient(to right,#e0e0e0,#cccccc);}
        .btn-secondary:hover { background-color: #cccccc; border-color: #9e9e9e; background-image: linear-gradient(to right,#cccccc,#9e9e9e);}
        .loading-spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin-right: 0.5rem;}
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .plan-section { margin-bottom: 1.5rem; }
        .plan-section h3 { font-weight: 700; margin-bottom: 0.75rem; color: #1976d2; font-size: 1.375rem;}
        .behavior-block { border: 2px solid #90caf9; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; background-color: #e3f2fd; box-shadow: 0 4px 8px rgba(0,0,0,0.08);}
        .behavior-block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 2px solid #64b5f6;}
        .info-modal-parent {
            position: relative;
        }
        .info-modal {
            left: 0;
            top: 100%;
            min-width: 320px;
            max-width: 500px;
        }
        .ai-output-content {
            white-space: pre-line;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container">
        <h1 class="text-4xl font-extrabold text-center text-blue-700 mb-8">
            Function Based Problem Solving Worksheet
        </h1>

        <div class="card flex justify-between items-center bg-blue-50 border border-blue-200 p-4 mb-6">
            <p class="text-blue-800 font-semibold">FBPSW: <span id="sessionStatusDisplay" class="font-normal text-blue-600">Active</span></p>
            <button id="newPlanButton" class="btn-secondary">
                <i class="fas fa-plus mr-2"></i> New Plan
            </button>
        </div>

        <div class="card">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Teacher Input</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="studentAge" class="block text-gray-700 text-sm font-semibold mb-2">Student Age</label>
                    <input type="number" id="studentAge" placeholder="e.g., 7" min="3" max="18">
                </div>
                <div>
                    <label for="studentGrade" class="block text-gray-700 text-sm font-semibold mb-2">Student Grade Level</label>
                    <select id="studentGrade">
                        <option value="">Select Grade</option>
                        <option value="K">Kindergarten</option>
                        <option value="1st">1st Grade</option>
                        <option value="2nd">2nd Grade</option>
                        <option value="3rd">3rd Grade</option>
                        <option value="4th">4th Grade</option>
                        <option value="5th">5th Grade</option>
                        <option value="6th">6th Grade</option>
                        <option value="7th">7th Grade</option>
                        <option value="8th">8th Grade</option>
                        <option value="Higher">Higher Grades</option>
                        <option value="Other">Other / Not Applicable</option>
                    </select>
                </div>

                <div class="md:col-span-2">
                    <label for="strengthsInterestsResiliency" class="block text-gray-700 text-sm font-semibold mb-2">Strengths, Interests, and Resiliency Factors</label>
                    <textarea id="strengthsInterestsResiliency" rows="3" placeholder="e.g., Strong in art, loves dinosaurs, responds well to positive adult attention, supportive family..."></textarea>
                </div>

                <div id="behaviorsContainer" class="md:col-span-2">
                    <div class="behavior-block" data-behavior-index="0">
                        <div class="behavior-block-header">
                            <h3 class="text-lg font-semibold text-gray-700">Behavior Pattern 1</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="behaviorTypeSelect_0" class="block text-gray-700 text-sm font-semibold mb-2">Behavior Type</label>
                                <select id="behaviorTypeSelect_0">
                                    <option value="">Select Behavior Type</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="antecedentSelect_0" class="block text-gray-700 text-sm font-semibold mb-2">Antecedent</label>
                                <select id="antecedentSelect_0">
                                    <option value="">Select Antecedent</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="behaviorSelect_0" class="block text-gray-700 text-sm font-semibold mb-2">Specific Behavior</label>
                                <select id="behaviorSelect_0">
                                    <option value="">Select Specific Behavior</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="consequenceSelect_0" class="block text-gray-700 text-sm font-semibold mb-2">Typical Consequence</label>
                                <select id="consequenceSelect_0">
                                    <option value="">Select Consequence</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="behavior-block" data-behavior-index="1">
                        <div class="behavior-block-header">
                                <h3 class="text-lg font-semibold text-gray-700">Behavior Pattern 2 (Optional)</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div>
                                <label for="behaviorTypeSelect_1" class="block text-gray-700 text-sm font-semibold mb-2">Behavior Type</label>
                                <select id="behaviorTypeSelect_1">
                                    <option value="">Select Behavior Type</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="antecedentSelect_1" class="block text-gray-700 text-sm font-semibold mb-2">Antecedent</label>
                                <select id="antecedentSelect_1">
                                    <option value="">Select Antecedent</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="behaviorSelect_1" class="block text-gray-700 text-sm font-semibold mb-2">Specific Behavior</label>
                                <select id="behaviorSelect_1">
                                    <option value="">Select Specific Behavior</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="consequenceSelect_1" class="block text-gray-700 text-sm font-semibold mb-2">Typical Consequence</label>
                                <select id="consequenceSelect_1">
                                    <option value="">Select Consequence</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="behavior-block" data-behavior-index="2">
                        <div class="behavior-block-header">
                                <h3 class="text-lg font-semibold text-gray-700">Behavior Pattern 3 (Optional)</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="behaviorTypeSelect_2" class="block text-gray-700 text-sm font-semibold mb-2">Behavior Type</label>
                                <select id="behaviorTypeSelect_2">
                                    <option value="">Select Behavior Type</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="antecedentSelect_2" class="block text-gray-700 text-sm font-semibold mb-2">Antecedent</label>
                                <select id="antecedentSelect_2">
                                    <option value="">Select Antecedent</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="behaviorSelect_2" class="block text-gray-700 text-sm font-semibold mb-2">Specific Behavior</label>
                                <select id="behaviorSelect_2">
                                    <option value="">Select Specific Behavior</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                            <div>
                                <label for="consequenceSelect_2" class="block text-gray-700 text-sm font-semibold mb-2">Typical Consequence</label>
                                <select id="consequenceSelect_2">
                                    <option value="">Select Consequence</option>
                                    <option value="Other">Other (Specify in Notes)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="anecdotal" class="block text-gray-700 text-sm font-semibold mb-2">Anecdotal Notes (include information about frequency, intensity, duration of behaviors if known)</label>
                    <textarea id="anecdotal" rows="3" placeholder="e.g., Student exhibits task refusal daily during math, lasting 5-10 minutes..."></textarea>
                </div>
                <div>
                    <label for="reinforcerPreferences" class="block text-gray-700 text-sm font-semibold mb-2">Student's Preferred Reinforcers</label>
                    <textarea id="reinforcerPreferences" rows="2" placeholder="e.g., Loves computer time, enjoys drawing..."></textarea>
                </div>

                <div class="info-modal-parent">
                    <div class="flex items-center mb-1">
                        <label for="behavioralSkillsSelect" class="block text-gray-700 text-sm font-semibold">Behavioral Skills Level</label>
                        <i id="behavioralInfoIcon" class="fas fa-info-circle text-blue-500 ml-2 cursor-pointer hover:text-blue-700" title="Show behavioral levels"></i>
                    </div>
                    <select id="behavioralSkillsSelect">
                        <option value="">Select Level</option>
                        <option value="Foundational Regulator">Foundational Regulator</option>
                        <option value="Guided Participant">Guided Participant</option>
                        <option value="Emerging Self-Manager">Emerging Self-Manager</option>
                        <option value="Flexible Adapter">Flexible Adapter</option>
                        <option value="Intentional Strategist">Intentional Strategist</option>
                        <option value="Reflective Adapter">Reflective Adapter</option>
                        <option value="Independent Regulator">Independent Regulator</option>
                        <option value="Strategic Manager">Strategic Manager</option>
                        <option value="Autonomous Problem-Solver">Autonomous Problem-Solver</option>
                    </select>
                    <div id="behavioralInfoModal" class="info-modal hidden absolute z-50 mt-1 p-4 bg-white border-2 border-blue-300 rounded-lg shadow-xl">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-md font-semibold text-blue-700">Behavioral Developmental Levels</h4>
                            <button id="closeBehavioralModal" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
                        </div>
                        <table class="w-full text-xs table-fixed">
                            <thead class="sticky top-0 bg-blue-100">
                                <tr>
                                    <th class="p-1 text-left font-semibold text-blue-800 w-1/3">Level</th>
                                    <th class="p-1 text-left font-semibold text-blue-800 w-2/3">Description</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="info-modal-parent">
                    <div class="flex items-center mb-1">
                        <label for="socialSkillsSelect" class="block text-gray-700 text-sm font-semibold">Social Skills Level</label>
                        <i id="socialInfoIcon" class="fas fa-info-circle text-blue-500 ml-2 cursor-pointer hover:text-blue-700" title="Show social levels"></i>
                    </div>
                    <select id="socialSkillsSelect">
                        <option value="">Select Level</option>
                        <option value="Social Initiator">Social Initiator</option>
                        <option value="Emerging Peer">Emerging Peer</option>
                        <option value="Collaborative Partner">Collaborative Partner</option>
                        <option value="Connected Participant">Connected Participant</option>
                        <option value="Social Navigator">Social Navigator</option>
                        <option value="Empathetic Ally">Empathetic Ally</option>
                        <option value="Relational Strategist">Relational Strategist</option>
                        <option value="Social Integrator">Social Integrator</option>
                        <option value="Leadership Model">Leadership Model</option>
                    </select>
                    <div id="socialInfoModal" class="info-modal hidden absolute z-50 mt-1 p-4 bg-white border-2 border-blue-300 rounded-lg shadow-xl">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-md font-semibold text-blue-700">Social Developmental Levels</h4>
                            <button id="closeSocialModal" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
                        </div>
                        <table class="w-full text-xs table-fixed">
                            <thead class="sticky top-0 bg-blue-100">
                                <tr>
                                    <th class="p-1 text-left font-semibold text-blue-800 w-1/3">Level</th>
                                    <th class="p-1 text-left font-semibold text-blue-800 w-2/3">Description</th>
                                </tr>
                            </thead>
                                <tbody class="text-gray-700">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="info-modal-parent">
                    <div class="flex items-center mb-1">
                        <label for="pragmaticLanguageSkillsSelect" class="block text-gray-700 text-sm font-semibold">Pragmatic Language Skills Level</label>
                        <i id="pragmaticInfoIcon" class="fas fa-info-circle text-blue-500 ml-2 cursor-pointer hover:text-blue-700" title="Show pragmatic language levels"></i>
                    </div>
                    <select id="pragmaticLanguageSkillsSelect">
                        <option value="">Select Level</option>
                        <option value="Foundational Communicator">Foundational Communicator</option>
                        <option value="Emerging Conversationalist">Emerging Conversationalist</option>
                        <option value="Functional Speaker">Functional Speaker</option>
                        <option value="Social Interpreter">Social Interpreter</option>
                        <option value="Contextual Communicator">Contextual Communicator</option>
                        <option value="Purposeful Speaker">Purposeful Speaker</option>
                        <option value="Strategic Conversationalist">Strategic Conversationalist</option>
                        <option value="Adaptive Communicator">Adaptive Communicator</option>
                        <option value="Discourse Leader">Discourse Leader</option>
                    </select>
                            <div id="pragmaticInfoModal" class="info-modal hidden absolute z-50 mt-1 p-4 bg-white border-2 border-blue-300 rounded-lg shadow-xl">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-md font-semibold text-blue-700">Pragmatic Language Developmental Levels</h4>
                                <button id="closePragmaticModal" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
                            </div>
                            <table class="w-full text-xs table-fixed">
                                <thead class="sticky top-0 bg-blue-100">
                                    <tr>
                                        <th class="p-1 text-left font-semibold text-blue-800 w-1/3">Level</th>
                                        <th class="p-1 text-left font-semibold text-blue-800 w-2/3">Description</th>
                                    </tr>
                                </thead>
                                <tbody class="text-gray-700">
                                </tbody>
                            </table>
                        </div>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-gray-700 text-sm font-semibold mb-2">Add pertinent referral information?</label>
                    <div class="flex items-center space-x-4 mb-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="addReferralInfo" value="yes" class="form-radio" id="addReferralYes">
                            <span class="ml-2 text-gray-700">Yes</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="addReferralInfo" value="no" class="form-radio" id="addReferralNo" checked>
                            <span class="ml-2 text-gray-700">No</span>
                        </label>
                    </div>
                    <div id="referralInfoContainer" class="hidden">
                        <label for="referral" class="block text-gray-700 text-sm font-semibold mb-2">Referral Information</label>
                        <textarea id="referral" rows="4" placeholder="e.g., Student referred for disruptive behavior..."></textarea>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="generateBIPButton" class="btn-primary">
                    <span id="generateBIPSpinner" class="loading-spinner hidden"></span>
                    Generate Plan
                </button>
            </div>
        </div>

        <div id="bipOutput" class="card hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Generated Function Based Problem Solving Worksheet</h2>
            <div class="mb-4">
                <p id="bipFunctionHypothesis" class="text-blue-600 font-medium text-xl whitespace-pre-line"></p>
            </div>
            <div class="plan-section">
                <h3>Antecedent Strategies:</h3>
                <div id="bipAntecedentStrategies" class="prose max-w-none text-gray-800 ai-output-content"></div>
            </div>
            <div class="plan-section">
                <h3>Short-term Replacement Behaviors:</h3>
                <div id="bipShortTermBehaviors" class="prose max-w-none text-gray-800 ai-output-content"></div>
            </div>
            <div class="plan-section">
                <h3>Teaching Strategies for Short-Term Replacement Behaviors:</h3>
                <div id="bipTeachingStrategies" class="prose max-w-none text-gray-800 ai-output-content"></div>
            </div>
            <div class="plan-section">
                <h3>Reinforcement Strategies for Short-Term Replacement Behaviors:</h3>
                <div id="bipReinforcementShortTerm" class="prose max-w-none text-gray-800 ai-output-content"></div>
            </div>
            <div class="plan-section">
                <h3>Long-term Replacement Behaviors:</h3>
                <div id="bipLongTermBehaviors" class="prose max-w-none text-gray-800 ai-output-content"></div>
            </div>
            <div class="plan-section">
                <h3>Response Strategies for Problem Behavior:</h3>
                <div id="bipResponseStrategies" class="prose max-w-none text-gray-800 ai-output-content"></div>
            </div>

            <div class="plan-section">
                <h3>Monitoring and Plan Review:</h3>
                <div id="monitoringStatementContent" class="prose max-w-none text-gray-800">
                    <p>This plan needs to be reviewed by the school team no less than every four to six weeks starting the 25-26 school year. If the plan is not working, then some aspects should be revised at the meeting. If the plan is successful (extinguished maladaptive behaviors) for four consecutive weeks, then the IEP team should meet to amend the IEP and turn it into a full behavior intervention plan (BIP). Data supporting more intervention or success will be determined by Infinite Campus classroom incidents and referrals.</p>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-4">
                <button id="copyBIPButton" class="btn-secondary">
                    <i class="fas fa-copy mr-2"></i> Copy Plan
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Data for ABC dropdowns from "ABC_Framework_Behavior_Plan (Chat GPT Orginal)" & User Expansion ---
        const bipData = {
            "Physical Aggression": {
                antecedents: ["Challenging tasks", "Denial of requests", "Interruption of preferred activity", "Peer conflicts", "Protecting personal space/items", "Sensory overload", "Transitions", "Unwanted physical touch"].sort(),
                behaviors: ["Biting (others)", "Hitting", "Kicking", "Pinching", "Pulling hair (others)", "Pushing", "Scratching (others)", "Shoving", "Spitting (at others)", "Throwing objects (at people/property with intent to harm/disrupt)"].sort(),
                consequences: ["Adult attention (reprimand, comfort, intervention)", "Item/activity obtained", "Loss of privileges", "Peer avoidance/withdrawal", "Physical restraint (for safety)", "Removal from activity/area", "Task/demand escaped"].sort()
            },
            "Verbal Aggression": {
                antecedents: ["Denial of requests", "Feeling unheard/misunderstood", "Frustration with task", "Peer teasing/provocation", "Perceived unfairness", "Receiving corrections/reprimands", "Unexpected changes"].sort(),
                behaviors: ["Arguing/Defiance (verbal, e.g., \"No!\")", "Name-calling/Insults", "Sarcasm/Rude comments", "Swearing/Profanity", "Threats (verbal)", "Yelling/Screaming"].sort(),
                consequences: ["Adult attention (discussion, warning)", "Loss of privileges", "Peer reactions (laughter, arguing, fear)", "Reprimands (can be attention)", "Task/demand escaped or modified", "Time-outs"].sort()
            },
            "Self-Injurious Behavior": {
                antecedents: ["Denial of preferred item/activity", "Emotional distress (anxiety, frustration)", "High task demands", "Lack of stimulation/boredom", "Physical pain/discomfort (internal)", "Sensory discomfort/overload", "Transitions"].sort(),
                behaviors: ["Biting self", "Hair pulling (own)", "Head banging (against surface/self)", "Hitting self", "Picking skin/scabs", "Scratching self"].sort(),
                consequences: ["Access to sensory input (automatic reinforcement)", "Comfort/attention provided", "Escape from demand/social interaction", "Intervention for safety (physical block, removal)", "Task removal/postponement"].sort()
            },
            "Task Refusal / Noncompliance": {
                antecedents: ["Challenging/Difficult tasks", "Fatigue", "Lack of choice in task", "Long work periods", "Non-preferred tasks", "Transitions to non-preferred activity", "Unclear instructions"].sort(),
                behaviors: ["Arguing about task", "Asking to do something else", "Ignoring instructions/prompts", "Leaving work area (not elopement)", "Passively not starting task", "Putting head down", "Saying 'no' to requests"].sort(),
                consequences: ["Adult prompts/redirection (can be attention)", "Allowed to do preferred activity instead (escape)", "Break given", "Loss of reward/privilege if task incomplete", "Task postponed/removed", "Task simplification"].sort()
            },
            "Elopement (Running Away)": {
                antecedents: ["Non-preferred settings/activities", "Overstimulating environment", "To escape a demand or aversive situation", "To gain access to a preferred item/area/person outside current setting", "Transitions", "Unstructured times"].sort(),
                behaviors: ["Hiding from staff", "Leaving supervised area without permission", "Running away from staff/group"].sort(),
                consequences: ["Access to desired location/item (if successful elopement)", "Chased by staff (can be reinforcing)", "Increased one-on-one supervision", "Loss of privileges", "Return to original area/task (sometimes delayed)"].sort()
            },
            "Disruptive Behavior (Non-Aggressive)": {
                antecedents: ["Boring/Easy tasks", "Lack of engagement", "Seeking adult attention", "Seeking peer attention", "Transition periods", "Unstructured periods"].sort(),
                behaviors: ["Making noises (vocal, tapping, etc.)", "Out-of-seat (without permission)", "Playing with non-task items", "Talking out of turn/Interrupting", "Touching/bothering peers' belongings", "Wandering around (not elopement)"].sort(),
                consequences: ["Brief removal from group (if disruptive)", "Loss of rewards/points", "Peer attention (laughter, annoyance)", "Sent to a different seat", "Teacher attention (redirect, reprimand)"].sort()
            },
            "Off-Task Behavior": {
                antecedents: ["Distractions in environment", "Internal distractions (thoughts, fatigue)", "Lack of interest in task", "Long work periods without breaks", "Tasks too easy or too hard", "Unclear instructions"].sort(),
                behaviors: ["Daydreaming/Staring into space", "Doodling (unrelated to task)", "Fiddling with objects (non-task related)", "Getting up to do unrelated things (sharpen pencil repeatedly)", "Looking around the room (not at task)", "Slow task initiation/procrastination"].sort(),
                consequences: ["Less free time later", "Loss of privileges (if work not done)", "Natural consequence (work not completed, doesn't learn material)", "Prompts to focus from adult", "Task simplification (if too hard)"].sort()
            },
            "Property Destruction/Misuse": {
                antecedents: ["Denied access to desired items/activities", "Escape from task", "Frustration/Anger", "Seeking attention", "Unstructured moments"].sort(),
                behaviors: ["Breaking objects (pencils, crayons, toys)", "Drawing/writing on property (desks, walls, books)", "Tearing materials (books, worksheets)", "Throwing objects (not aimed at people, e.g., in frustration)"].sort(),
                consequences: ["Loss of item/access to similar items", "Reprimand/adult attention", "Required cleanup/restitution", "Task delayed or removed", "Time-out"].sort()
            },
            "General / Other": { // For when behavior type is "Other"
                antecedents: [
                    "Academic demand", "Change in routine", "Correction/Feedback", "Denial of access",
                    "Internal state (hungry, tired, anxious)", "Lack of attention", "Peer interaction (positive or negative)",
                    "Presence of specific person/item", "Sensory input (loud noise, bright light)",
                    "Social demand", "Transition", "Unstructured time"
                ].sort(),
                behaviors: [ // User will rely more on anecdotal notes for "Other" behaviors
                    "Crying", "Inappropriate physical contact (non-aggressive)", "Not following social rules",
                    "Pacing", "Refusing to speak", "Whining", "Withdrawing from interaction",
                    "(Specify in anecdotal notes)"
                ].sort(),
                consequences: [
                    "Access to preferred item/activity/person", "Adult attention (positive/negative)", "Comfort",
                    "Escape/Avoidance of task/situation/person", "Ignoring", "Loss of privilege",
                    "Peer attention (positive/negative)", "Removal from area", "Reprimand", "Redirection",
                    "Sensory stimulation (automatic)", "Task modification"
                ].sort()
            }
        };

        // --- Data for Developmental Level Modals from "Psychological_Developmental_Levels_Framework (Chat GPT Orginal)" ---
        const developmentalLevels = {
            behavioral: [
                { level: "Foundational Regulator", description: "Begins to respond to adult direction and follow basic instructions." },
                { level: "Guided Participant", description: "Learning routines and starting to manage impulses with support." },
                { level: "Emerging Self-Manager", description: "Follows daily expectations with minimal prompting; early signs of self-regulation." },
                { level: "Flexible Adapter", description: "Demonstrates behavioral awareness and adjusts actions to meet expectations." },
                { level: "Intentional Strategist", description: "Uses learned strategies to manage feelings and stay engaged." },
                { level: "Reflective Adapter", description: "Reflects on decisions and alters behavior based on environment." },
                { level: "Independent Regulator", description: "Applies strategies independently; shows accountability for behavior." },
                { level: "Strategic Manager", description: "Manages emotions in different settings with consistent strategy use." },
                { level: "Autonomous Problem-Solver", description: "Independently evaluates actions and mentors peers in regulation." }
            ],
            social: [
                { level: "Social Initiator", description: "Begins to interact and show interest in social contact." },
                { level: "Emerging Peer", description: "Engages in basic group participation and follows simple social rules." },
                { level: "Collaborative Partner", description: "Cooperates in tasks with support and initiates teamwork." },
                { level: "Connected Participant", description: "Shares ideas and respects others’ contributions." },
                { level: "Social Navigator", description: "Develops friendships and adapts to group dynamics." },
                { level: "Empathetic Ally", description: "Demonstrates empathy and resolves social issues constructively." },
                { level: "Relational Strategist", description: "Balances personal identity with social inclusion." },
                { level: "Social Integrator", description: "Manages complex peer relationships and social contexts." },
                { level: "Leadership Model", description: "Demonstrates leadership and models inclusive practices." }
            ],
            pragmatic: [
                { level: "Foundational Communicator", description: "Uses simple phrases to express needs and respond to others." },
                { level: "Emerging Conversationalist", description: "Begins conversations and uses basic conversational norms." },
                { level: "Functional Speaker", description: "Carries conversations and clarifies when needed." },
                { level: "Social Interpreter", description: "Uses humor and manages dialogue in social settings." },
                { level: "Contextual Communicator", description: "Adapts speech to suit audience and situation." },
                { level: "Purposeful Speaker", description: "Expresses intentions clearly and addresses breakdowns in communication." },
                { level: "Strategic Conversationalist", description: "Engages in layered, intentional discussions." },
                { level: "Adaptive Communicator", description: "Uses appropriate communication across varied settings." },
                { level: "Discourse Leader", description: "Communicates abstract ideas and leads discussions." }
            ]
        };

        // --- Data for Grade-Level Context from "Combined_Developmental_Levels_by_Grade.docx" ---
        const gradeLevelContexts = {
            "K": {
                behavioral: "Foundational Regulator to Guided Participant – Students are beginning to follow adult guidance, learn classroom routines, and require support to manage impulses.",
                social: "Social Initiator to Emerging Peer – Students start interacting with others and learn simple social rules and group participation.",
                language: "Foundational Communicator to Emerging Conversationalist – Students use basic language to express needs and begin short conversations using polite terms."
            },
            "1st": {
                behavioral: "Foundational Regulator to Guided Participant – Students are beginning to follow adult guidance, learn classroom routines, and require support to manage impulses.",
                social: "Social Initiator to Emerging Peer – Students start interacting with others and learn simple social rules and group participation.",
                language: "Foundational Communicator to Emerging Conversationalist – Students use basic language to express needs and begin short conversations using polite terms."
            },
            "2nd": {
                behavioral: "Emerging Self-Manager to Flexible Adapter – Students follow routines with less prompting and begin showing behavioral awareness.",
                social: "Collaborative Partner to Connected Participant – Students start cooperating in tasks and respecting others' contributions in group settings.",
                language: "Functional Speaker to Social Interpreter – Students maintain conversations and begin using humor or negotiation during interactions."
            },
            "3rd": {
                behavioral: "Emerging Self-Manager to Flexible Adapter – Students follow routines with less prompting and begin showing behavioral awareness.",
                social: "Collaborative Partner to Connected Participant – Students start cooperating in tasks and respecting others' contributions in group settings.",
                language: "Functional Speaker to Social Interpreter – Students maintain conversations and begin using humor or negotiation during interactions."
            },
            "4th": {
                behavioral: "Intentional Strategist to Reflective Adapter – Students apply coping strategies and reflect on behaviors to adjust to expectations.",
                social: "Social Navigator to Empathetic Ally – Students form friendships, include others, and begin resolving social conflicts empathetically.",
                language: "Contextual Communicator to Purposeful Speaker – Students adapt language to the setting and begin to discuss with clear intent and reasoning."
            },
            "5th": {
                behavioral: "Intentional Strategist to Reflective Adapter – Students apply coping strategies and reflect on behaviors to adjust to expectations.",
                social: "Social Navigator to Empathetic Ally – Students form friendships, include others, and begin resolving social conflicts empathetically.",
                language: "Contextual Communicator to Purposeful Speaker – Students adapt language to the setting and begin to discuss with clear intent and reasoning."
            },
            "6th": {
                behavioral: "Independent Regulator to Autonomous Problem-Solver – Students regulate behavior independently, show accountability, and support peers.",
                social: "Relational Strategist to Leadership Model – Students manage social identity, complex relationships, and lead by modeling inclusiveness.",
                language: "Strategic Conversationalist to Discourse Leader – Students use advanced dialogue, adjust communication styles across settings, and engage in persuasive or abstract discussions."
            },
            "7th": {
                behavioral: "Independent Regulator to Autonomous Problem-Solver – Students regulate behavior independently, show accountability, and support peers.",
                social: "Relational Strategist to Leadership Model – Students manage social identity, complex relationships, and lead by modeling inclusiveness.",
                language: "Strategic Conversationalist to Discourse Leader – Students use advanced dialogue, adjust communication styles across settings, and engage in persuasive or abstract discussions."
            },
            "8th": {
                behavioral: "Independent Regulator to Autonomous Problem-Solver – Students regulate behavior independently, show accountability, and support peers.",
                social: "Relational Strategist to Leadership Model – Students manage social identity, complex relationships, and lead by modeling inclusiveness.",
                language: "Strategic Conversationalist to Discourse Leader – Students use advanced dialogue, adjust communication styles across settings, and engage in persuasive or abstract discussions."
            }
        };


        // DOM elements
        const studentAgeInput = document.getElementById('studentAge');
        const studentGradeSelect = document.getElementById('studentGrade');
        const strengthsInterestsResiliencyInput = document.getElementById('strengthsInterestsResiliency');
        const reinforcerPreferencesInput = document.getElementById('reinforcerPreferences');
        const behavioralSkillsSelect = document.getElementById('behavioralSkillsSelect');
        const socialSkillsSelect = document.getElementById('socialSkillsSelect');
        const pragmaticLanguageSkillsSelect = document.getElementById('pragmaticLanguageSkillsSelect');
        const anecdotalInput = document.getElementById('anecdotal');
        const referralInput = document.getElementById('referral');
        const generateBIPButton = document.getElementById('generateBIPButton');
        const generateBIPSpinner = document.getElementById('generateBIPSpinner');
        const bipOutputDiv = document.getElementById('bipOutput');
        const bipFunctionHypothesis = document.getElementById('bipFunctionHypothesis');
        const bipAntecedentStrategies = document.getElementById('bipAntecedentStrategies');
        const bipShortTermBehaviors = document.getElementById('bipShortTermBehaviors');
        const bipTeachingStrategies = document.getElementById('bipTeachingStrategies');
        const bipReinforcementShortTerm = document.getElementById('bipReinforcementShortTerm');
        const bipLongTermBehaviors = document.getElementById('bipLongTermBehaviors');
        const bipResponseStrategies = document.getElementById('bipResponseStrategies');
        const copyBIPButton = document.getElementById('copyBIPButton');
        const sessionStatusDisplay = document.getElementById('sessionStatusDisplay');
        const addReferralYes = document.getElementById('addReferralYes');
        const addReferralNo = document.getElementById('addReferralNo');
        const referralInfoContainer = document.getElementById('referralInfoContainer');
        const monitoringStatementContentElement = document.getElementById('monitoringStatementContent');

        const behavioralInfoIcon = document.getElementById('behavioralInfoIcon');
        const behavioralInfoModal = document.getElementById('behavioralInfoModal');
        const closeBehavioralModalButton = document.getElementById('closeBehavioralModal');

        const socialInfoIcon = document.getElementById('socialInfoIcon');
        const socialInfoModal = document.getElementById('socialInfoModal');
        const closeSocialModalButton = document.getElementById('closeSocialModal');

        const pragmaticInfoIcon = document.getElementById('pragmaticInfoIcon');
        const pragmaticInfoModal = document.getElementById('pragmaticInfoModal');
        const closePragmaticModalButton = document.getElementById('closePragmaticModal');


        addReferralYes.addEventListener('change', () => {
            referralInfoContainer.classList.remove('hidden');
        });
        addReferralNo.addEventListener('change', () => {
            referralInfoContainer.classList.add('hidden');
        });

        function populateSelectWithOptions(selectElement, optionsArray, defaultOptionText, keepOther = true) {
            let otherOptionHTML = '';
            if (keepOther) {
                const existingOther = selectElement.querySelector('option[value="Other"]');
                if (existingOther) {
                    otherOptionHTML = existingOther.outerHTML;
                } else {
                    otherOptionHTML = '<option value="Other">Other (Specify in Notes)</option>';
                }
            }
            selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
            if (optionsArray && Array.isArray(optionsArray)) {
                optionsArray.forEach(optionText => {
                    const option = document.createElement('option');
                    option.value = optionText;
                    option.textContent = optionText;
                    selectElement.appendChild(option);
                });
            }
            if (keepOther && otherOptionHTML) {
                selectElement.insertAdjacentHTML('beforeend', otherOptionHTML);
            }
        }

        function initializeBehaviorDropdowns() {
            const behaviorTypeKeys = Object.keys(bipData);
            for (let i = 0; i < 3; i++) {
                const behaviorTypeSelect = document.getElementById(`behaviorTypeSelect_${i}`);
                const antecedentSelect = document.getElementById(`antecedentSelect_${i}`);
                const behaviorSelect = document.getElementById(`behaviorSelect_${i}`);
                const consequenceSelect = document.getElementById(`consequenceSelect_${i}`);

                if (!behaviorTypeSelect) {
                    console.error(`ERROR: Element with ID 'behaviorTypeSelect_${i}' not found.`);
                    continue;
                }
                if (!antecedentSelect) console.warn(`Warning: Element with ID 'antecedentSelect_${i}' not found. Dependent dropdown will not work for block ${i}.`);
                if (!behaviorSelect) console.warn(`Warning: Element with ID 'behaviorSelect_${i}' not found. Dependent dropdown will not work for block ${i}.`);
                if (!consequenceSelect) console.warn(`Warning: Element with ID 'consequenceSelect_${i}' not found. Dependent dropdown will not work for block ${i}.`);

                populateSelectWithOptions(behaviorTypeSelect, behaviorTypeKeys, "Select Behavior Type");

                behaviorTypeSelect.addEventListener('change', function() {
                    const selectedBehaviorType = this.value;
                    const currentBlockHeader = this.closest('.behavior-block').querySelector('h3');
                    if (selectedBehaviorType && currentBlockHeader) {
                         if (selectedBehaviorType === "Other") {
                            currentBlockHeader.textContent = `Behavior Pattern ${parseInt(this.closest('.behavior-block').dataset.behaviorIndex) + 1} (Other - specify in notes)`;
                        } else {
                            currentBlockHeader.textContent = selectedBehaviorType; // Update header to Behavior Type
                        }
                    } else if (currentBlockHeader) {
                         currentBlockHeader.textContent = `Behavior Pattern ${parseInt(this.closest('.behavior-block').dataset.behaviorIndex) + 1}${parseInt(this.closest('.behavior-block').dataset.behaviorIndex) > 0 ? ' (Optional)' : '' }`;
                    }


                    if (selectedBehaviorType && bipData[selectedBehaviorType]) {
                        if (antecedentSelect) populateSelectWithOptions(antecedentSelect, bipData[selectedBehaviorType].antecedents, "Select Antecedent");
                        if (behaviorSelect) populateSelectWithOptions(behaviorSelect, bipData[selectedBehaviorType].behaviors, "Select Specific Behavior");
                        if (consequenceSelect) populateSelectWithOptions(consequenceSelect, bipData[selectedBehaviorType].consequences, "Select Consequence");
                    } else {
                        // If "Other" or no type is selected, use the "General / Other" lists or clear
                        const defaultSource = selectedBehaviorType === "Other" ? bipData["General / Other"] : { antecedents: [], behaviors: [], consequences: [] };
                        if (antecedentSelect) populateSelectWithOptions(antecedentSelect, defaultSource.antecedents, "Select Antecedent");
                        if (behaviorSelect) populateSelectWithOptions(behaviorSelect, defaultSource.behaviors, "Select Specific Behavior");
                        if (consequenceSelect) populateSelectWithOptions(consequenceSelect, defaultSource.consequences, "Select Consequence");
                    }
                });
                if (antecedentSelect) populateSelectWithOptions(antecedentSelect, [], "Select Antecedent (after choosing type)");
                if (behaviorSelect) populateSelectWithOptions(behaviorSelect, [], "Select Specific Behavior (after choosing type)");
                if (consequenceSelect) populateSelectWithOptions(consequenceSelect, [], "Select Consequence (after choosing type)");
            }
        }

        function populateInfoModalTable(modalBodyElement, levelsData) {
            modalBodyElement.innerHTML = ''; // Clear existing rows
            levelsData.forEach(item => {
                const row = modalBodyElement.insertRow();
                const levelCell = row.insertCell();
                const descriptionCell = row.insertCell();
                levelCell.className = 'p-1 border-t align-top';
                descriptionCell.className = 'p-1 border-t align-top';
                levelCell.textContent = item.level;
                descriptionCell.textContent = item.description;
            });
        }

        function setupInfoModal(iconId, modalId, closeButtonId, levelsData) {
            const icon = document.getElementById(iconId);
            const modal = document.getElementById(modalId);
            const closeButton = document.getElementById(closeButtonId);
            const modalTableBody = modal.querySelector('tbody');

            if (modalTableBody && levelsData) {
                populateInfoModalTable(modalTableBody, levelsData);
            }

            if (icon && modal) {
                icon.addEventListener('click', (event) => {
                    event.stopPropagation();
                    [behavioralInfoModal, socialInfoModal, pragmaticInfoModal].forEach(m => {
                        if (m && m !== modal) m.classList.add('hidden');
                    });
                    modal.classList.toggle('hidden');
                });
            }
            if (closeButton && modal) {
                closeButton.addEventListener('click', () => {
                    modal.classList.add('hidden');
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeBehaviorDropdowns();
            setupInfoModal('behavioralInfoIcon', 'behavioralInfoModal', 'closeBehavioralModal', developmentalLevels.behavioral);
            setupInfoModal('socialInfoIcon', 'socialInfoModal', 'closeSocialModal', developmentalLevels.social);
            setupInfoModal('pragmaticInfoIcon', 'pragmaticInfoModal', 'closePragmaticModal', developmentalLevels.pragmatic);
        });

        document.addEventListener('click', (event) => {
            const modals = [behavioralInfoModal, socialInfoModal, pragmaticInfoModal];
            const icons = [behavioralInfoIcon, socialInfoIcon, pragmaticInfoIcon];

            modals.forEach((modal, index) => {
                if (modal && !modal.classList.contains('hidden')) {
                    let currentIcon = icons[index];
                    let targetIsIconOrChild = false;
                    if (currentIcon) {
                        targetIsIconOrChild = currentIcon.contains(event.target) || currentIcon === event.target;
                    }

                    if (!modal.contains(event.target) && !targetIsIconOrChild) {
                        modal.classList.add('hidden');
                    }
                }
            });
        });

        // MODIFICATION START: Updated createPromptFromForm function for new labeling
        function createPromptFromForm() {
            const age = studentAgeInput.value || 'Not specified';
            const grade = studentGradeSelect.value || 'Not specified';
            const strengthsInterests = strengthsInterestsResiliencyInput.value || 'Not specified';
            const reinforcers = reinforcerPreferencesInput.value || 'Not specified';

            let anecdotal = anecdotalInput.value || 'No specific anecdotal notes provided.';
            if (anecdotalInput.value && !anecdotalInput.value.toLowerCase().includes("daily") && !anecdotalInput.value.toLowerCase().includes("weekly") && !anecdotalInput.value.toLowerCase().includes("often") && !anecdotalInput.value.toLowerCase().includes("frequently")) {
                anecdotal += " (Note: Assume these behavioral observations represent recurring patterns over time unless otherwise specified in the patterns below.)";
            }

            const referral = referralInput && !referralInfoContainer.classList.contains('hidden') ? referralInput.value : '';
            const behavioralLevel = behavioralSkillsSelect.value || 'Not specified';
            const socialLevel = socialSkillsSelect.value || 'Not specified';
            const pragmaticLevel = pragmaticLanguageSkillsSelect.value || 'Not specified';

            function getBehaviorBlock(index) {
                const typeSelect = document.getElementById(`behaviorTypeSelect_${index}`);
                const antecedentSelect = document.getElementById(`antecedentSelect_${index}`);
                const behaviorSpecificSelect = document.getElementById(`behaviorSelect_${index}`);
                const consequenceSelect = document.getElementById(`consequenceSelect_${index}`);

                const typeValue = typeSelect ? typeSelect.value : '';
                const antecedentValue = antecedentSelect ? antecedentSelect.value : '';
                const specificBehaviorValue = behaviorSpecificSelect ? behaviorSpecificSelect.value : '';
                const consequenceValue = consequenceSelect ? consequenceSelect.value : '';

                let titleForPrompt = '';

                if (typeValue && typeValue !== "Other" && typeValue !== "General / Other") { // Exclude "General / Other" as a title
                    titleForPrompt = typeValue;
                } else if (typeValue === "Other" || typeValue === "General / Other") {
                    titleForPrompt = "Other Behavior Pattern (refer to anecdotal notes for specifics)";
                } else if (specificBehaviorValue && specificBehaviorValue !== "Other (Specify in Notes)" && specificBehaviorValue !== "Other") {
                    titleForPrompt = specificBehaviorValue;
                }


                let result = '';
                // Only create a block if a title was determined AND at least one of A, B (specific), or C is specified.
                if (titleForPrompt && (antecedentValue || specificBehaviorValue || consequenceValue)) {
                    result = `Observed Recurring Pattern - ${titleForPrompt}:\n  Antecedent: ${antecedentValue || 'Not specified'}\n  Specific Behavior: ${specificBehaviorValue || 'Not specified'}\n  Typical Consequence: ${consequenceValue || 'Not specified'}`;
                }
                return result;
            }
            // MODIFICATION END

            const behaviors = [0,1,2].map(getBehaviorBlock).filter(Boolean).join('\n\n');

            const evidenceBasedStrategies = `
ADDITIONAL GUIDANCE FOR REPLACEMENT BEHAVIORS:
When developing the 'Short-term Replacement Behaviors', 'Teaching Strategies for Short-Term Replacement Behaviors', 'Reinforcement Strategies for Short-Term Replacement Behaviors', and 'Long-term Replacement Behaviors' sections, please consider the following evidence-based approaches, categorized by common behavioral functions. First, hypothesize the function based on the provided ABC data and student information. Then, select and adapt strategies relevant to that hypothesized function. These strategies are based on principles from evidence-based practices like Applied Behavior Analysis (ABA), Positive Behavioral Interventions and Supports (PBIS), and Functional Behavior Assessments (FBA). Implementation should be individualized and aligned with student needs, context, and data.

FOR STUDENTS SEEKING ATTENTION:
1. Teach Positive Communication for Attention: Help students learn respectful ways to gain attention such as using a help card, raising their hand, or saying “Excuse me.” Ensure these efforts are consistently acknowledged right away.
2. Schedule Frequent Adult Interaction: Provide students with brief, regular positive interactions (like a check-in or high-five every 10–15 minutes), regardless of behavior. This helps reduce unnecessary bids for attention.
3. Reinforce Positive Efforts Only: Acknowledge and reward behaviors like hand-raising while withholding responses to disruptions like calling out.
4. Visuals and Stories to Model Expectations: Display visual prompts (e.g., icons showing expected behaviors) and read or act out short stories that teach how to appropriately ask for attention.
5. Withhold Attention from Minor Disruptions: If a student uses attention-seeking behaviors that are not dangerous, calmly ignore the behavior and instead redirect or respond when they show appropriate behavior.

FOR STUDENTS AVOIDING TASKS OR DEMANDS:
1. Teach Requesting a Break or Help: Students can learn to say “I need help” or use a break card when tasks feel overwhelming. This prevents outbursts or avoidance behaviors.
2. Provide Limited, Meaningful Choices: Allow students to choose between task formats or work locations (“Do math on the rug or at your desk?”).
3. Modify Tasks and Support Gradually: Break complex assignments into smaller steps, simplify directions, or offer one-on-one support early to prevent frustration.
4. Offer Routine Breaks Regardless of Behavior: Plan short activity or movement breaks at predictable intervals. Teach students how to wait for or ask for breaks appropriately.
5. Use Timers and Prepare for Transitions: Timers and visual schedules help show students what’s coming. Give verbal cues before transitions to reduce surprise-related anxiety.

FOR STUDENTS WHO WANT SPECIFIC ITEMS OR ACTIVITIES:
1. Teach Appropriate Requesting Skills: Guide students to request items clearly and respectfully through words, signs, or visuals.
2. Reward the Right Behavior Only: If a student asks politely for something, honor the request briefly. Avoid giving the item when it’s demanded or taken aggressively.
3. Use Token Boards or First/Then Charts: Tie access to preferred items with task completion (e.g., “First reading, then tablet time”).
4. Teach Turn-Taking and Sharing: Model and rehearse taking turns with peers. Use timers or scripts to help students manage item sharing during play or meals.

FOR STUDENTS WITH SENSORY-BASED NEEDS:
1. Provide Sensory Breaks and Movement Time: Schedule body-based activities (e.g., jumping jacks, stretching) after periods of focus.
2. Offer Tools for Sensory Regulation: Give students items like fidget tools or stress balls, and teach how and when to use them.
3. Adjust the Environment: Lower noise, adjust lighting, or provide seating away from overstimulating areas.
4. Teach Calming Techniques: Model deep breathing, counting, or guided relaxation strategies. Create a calm-down space and practice using it proactively.

Remember that all strategies should be consistently implemented across settings and by all relevant staff.
`;
            let gradeContext = '';
            const selectedGradeKey = studentGradeSelect.value;
            if (gradeLevelContexts[selectedGradeKey]) {
                const context = gradeLevelContexts[selectedGradeKey];
                gradeContext = `
Typical Developmental Context for Student's Grade (${selectedGradeKey}):
- Behavioral Context: ${context.behavioral}
- Social Context: ${context.social}
- Language Context: ${context.language}
This grade-level context should be considered alongside the specifically selected individual skill levels.
`;
            }


            const hypothesisGenerationInstructions = `
IMPORTANT INSTRUCTION FOR 'Function Hypothesis Statement':
For the 'Function Hypothesis Statement' section, you MUST synthesize the provided ABC data (Antecedent, Behavior, Consequence from the selected patterns and/or anecdotal notes) to formulate a clear and concise hypothesis.
If only one behavior pattern is primarily being addressed, the statement MUST strictly follow this structure:
'When [accurately describe the specific antecedent conditions based on input...], the student will [accurately describe the specific observable problem behavior based on input...] because [accurately describe what the student typically obtains or escapes as a result of the behavior...] therefore, the function of the behavior appears to be [clearly state the hypothesized function for this pattern...].'
If multiple distinct behavior patterns are provided with potentially different hypothesized functions, you MUST address each clearly. You can do this by:
a) Providing a separate hypothesis statement in the above format for each distinct pattern (e.g., "For [Pattern Title from input, e.g., Physical Aggression]: When..., the student will..., because..., therefore the function is X. For [Second Pattern Title from input, e.g., Task Refusal]: When..., the student will..., because..., therefore the function is Y."). Use the pattern titles derived from the 'Observed Recurring Behavior Patterns' input as reference for your subheadings.
b) Or, if appropriate, a comprehensive summary that clearly links different functions to specific patterns.
Ensure each part of any hypothesis statement ([antecedent], [behavior], [consequence/reason], and [function]) is directly derived from and consistent with the student information and behavior patterns provided. Do not use placeholders like "[antecedent]" in your actual output; fill them with specific descriptions based on the input.
`;
            const personalizationInstruction = `
IMPORTANT PERSONALIZATION GUIDANCE:
When developing ALL sections of the Behavior Intervention Plan (especially Antecedent Strategies, all aspects of Replacement Behaviors including teaching and reinforcement, and Response Strategies), you MUST actively and explicitly incorporate the student's stated 'Strengths, Interests, and Resiliency Factors', their 'Preferred Reinforcers', and the contextual details from the 'Anecdotal Notes'. The goal is to create a highly personalized and practical plan. For example:
- If a student is interested in dinosaurs, consider how this interest can be woven into replacement behaviors, rewards, or task modifications.
- If strengths include artistic ability, explore how this can be used in coping strategies or alternative tasks.
- If anecdotal notes highlight specific triggers or successful past interactions, these must inform the antecedent and response strategies.
- 'Preferred Reinforcers' should be directly and creatively integrated into the 'Reinforcement Strategies for Short-Term Replacement Behaviors' and considered for long-term motivation.
Do not just list these factors; demonstrate their application in the strategies you propose throughout the plan.
`;

            const multiBehaviorInstruction = `
GUIDANCE FOR HANDLING MULTIPLE BEHAVIOR PATTERNS (APPLIES TO ALL STRATEGY SECTIONS):
If more than one 'Observed Recurring Behavior Pattern' is detailed in the input, it is crucial that the generated Behavior Intervention Plan addresses each pattern systematically. For each of the following sections – 'Antecedent Strategies', 'Short-term Replacement Behaviors', 'Teaching Strategies for Short-Term Replacement Behaviors', 'Reinforcement Strategies for Short-Term Replacement Behaviors', 'Long-term Replacement Behaviors' – you MUST:
1.  Consider each behavior pattern individually, especially if their hypothesized functions or topographies differ.
2.  Clearly delineate or preface which strategies apply to which behavior pattern. For example, you might use subheadings like "For [Pattern Title from input, e.g., Physical Aggression]:" followed by relevant strategies, then "For [Second Pattern Title from input, e.g., Task Refusal]:" followed by its strategies. Use the pattern titles derived from the 'Observed Recurring Behavior Patterns' input for these subheadings.
3.  If a strategy is applicable to multiple or all identified behavior patterns, you may consolidate, but explicitly state which patterns it covers.
Ensure the generated text within each section clearly indicates how it relates to the specific behavior patterns provided.
(Specific instructions for "Response Strategies for Problem Behavior" section are provided separately below).
`;
            const responseStrategyRefinedInstruction = `
**Critically, the 'Response Strategies for Problem Behavior' section must be detailed and robust.**
If multiple distinct 'Observed Recurring Behavior Patterns' are provided (as detailed in the 'Observed Recurring Behavior Patterns' input), you MUST structure this section to provide a complete and distinct set of response strategies for EACH behavior pattern. Use the exact pattern titles derived from the 'Observed Recurring Behavior Patterns' input (e.g., "Physical Aggression", "Task Refusal / Noncompliance", or "Other Behavior Pattern (refer to anecdotal notes for specifics)") as subheadings for each set of responses. For each behavior pattern, clearly outline:
    a. Immediate actions to take when this specific problem behavior pattern occurs to ensure the safety of the student and others.
    b. De-escalation techniques suitable for this specific behavior pattern and student characteristics.
    c. Clear, brief, and consistent verbal and non-verbal responses from staff for this pattern.
    d. Procedures for follow-up after an incident of this pattern, including re-teaching, and how to return the student to the learning environment.
    e. How to avoid strategies that could inadvertently reinforce this specific problem behavior based on its hypothesized function.

If only one behavior pattern is provided, you should present a single consolidated list covering points a-e above for that behavior, using its pattern title.
`;

            return `
Act as an expert Board Certified Behavior Analyst (BCBA) in a school setting. Your primary task is to develop a comprehensive and actionable Behavior Intervention Plan (BIP) based on the student information provided below.

It is crucial to understand that the observed behaviors described are **recurring patterns that have been happening over time**, not isolated incidents. Therefore, the entire BIP, including all strategies, must reflect this understanding of chronicity and learned history.

Student Information:
Student Age: ${age}
Grade: ${grade}
Strengths, Interests, and Resiliency Factors: ${strengthsInterests}
Preferred Reinforcers: ${reinforcers}
Anecdotal Notes (including context of recurrence, frequency, intensity, duration if available): ${anecdotal}
${referral ? "Referral Information: " + referral : ""}
Current Behavioral Skills Level: ${behavioralLevel}
Current Social Skills Level: ${socialLevel}
Current Pragmatic Language Skills Level: ${pragmaticLevel}
${gradeContext}
Observed Recurring Behavior Patterns (ABC Data - based on dropdown selections):
${behaviors || 'No specific recurring behavior patterns selected. If none are detailed, use the anecdotal notes to infer patterns and hypothesize the most likely ABC sequence.'}

${evidenceBasedStrategies}

${hypothesisGenerationInstructions}

${personalizationInstruction}

${multiBehaviorInstruction}

Please generate the Behavior Intervention Plan. Format your response using these section headings (exactly as written). Ensure ALL sections are thoroughly addressed with specific, actionable, and research-based strategies appropriate for a school environment, drawing from the evidence-based strategies provided above where relevant to the hypothesized function. **You should act as if you have all necessary information to complete every section of the plan comprehensively and should attempt to provide recommendations for all listed sections. Do not state that more information is needed for any section; instead, provide the best possible strategies based on the information at hand.**

${responseStrategyRefinedInstruction}

Required BIP Sections:
Function Hypothesis Statement:
Antecedent Strategies:
Short-term Replacement Behaviors:
Teaching Strategies for Short-Term Replacement Behaviors:
Reinforcement Strategies for Short-Term Replacement Behaviors:
Long-term Replacement Behaviors:
Response Strategies for Problem Behavior:
            `.trim();
        }

        function parsePlanSections(planText) {
            // console.log("[FRONTEND] parsePlanSections received planText (length):", planText.length);
            const sectionKeys = [
                "Function Hypothesis Statement", "Antecedent Strategies", "Short-term Replacement Behaviors",
                "Teaching Strategies for Short-Term Replacement Behaviors", "Reinforcement Strategies for Short-Term Replacement Behaviors",
                "Long-term Replacement Behaviors", "Response Strategies for Problem Behavior"
            ];
            const sections = {};
            sectionKeys.forEach(key => sections[key] = "");

            const lines = planText.split('\n');
            let currentSectionKey = null;
            let contentForCurrentSection = [];

            for (const line of lines) {
                let matchedNewSection = false;
                for (const key of sectionKeys) {
                    const trimmedLine = line.trim();
                    const pattern = new RegExp(`^(?:\\*\\*)?${key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}(?:\\*\\*)?:`, "i");
                    if (pattern.test(trimmedLine)) {
                        if (currentSectionKey && contentForCurrentSection.length > 0) {
                            sections[currentSectionKey] = contentForCurrentSection.join('\n').trim();
                        }
                        currentSectionKey = key;
                        contentForCurrentSection = [];
                        const contentOnHeadingLine = trimmedLine.replace(pattern, "").trim();
                        if (contentOnHeadingLine) {
                            contentForCurrentSection.push(contentOnHeadingLine);
                        }
                        matchedNewSection = true;
                        break;
                    }
                }
                if (!matchedNewSection && currentSectionKey) {
                    if (line.trim() !== "" || contentForCurrentSection.some(l => l.trim() !== "")) {
                        contentForCurrentSection.push(line);
                    }
                }
            }
            if (currentSectionKey && contentForCurrentSection.length > 0) {
                sections[currentSectionKey] = contentForCurrentSection.join('\n').trim();
            }
            for (let key in sections) {
                sections[key] = sections[key].trim();
            }
            // console.log("[FRONTEND] parsePlanSections generated sections:", JSON.parse(JSON.stringify(sections)));
            return sections;
        }

        // MODIFICATION START: Function to get active problem behavior phrases
        function getActiveProblemBehaviorPhrases() {
            const phrases = new Set();
            for (let i = 0; i < 3; i++) {
                const typeSelect = document.getElementById(`behaviorTypeSelect_${i}`);
                const behaviorSpecificSelect = document.getElementById(`behaviorSelect_${i}`);

                const typeValue = typeSelect ? typeSelect.value : '';
                const specificBehaviorValue = behaviorSpecificSelect ? behaviorSpecificSelect.value : '';

                if (typeValue && typeValue !== "Other" && typeValue !== "General / Other" && typeValue.trim().length > 2) {
                    phrases.add(typeValue.trim());
                }
                // Also add specific behaviors if they are not generic placeholders and are distinct
                if (specificBehaviorValue && specificBehaviorValue !== "Other (Specify in Notes)" && specificBehaviorValue !== "Other" && specificBehaviorValue.trim().length > 2) {
                    phrases.add(specificBehaviorValue.trim());
                }
            }
            return Array.from(phrases);
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        // MODIFICATION END

        // MODIFICATION START: Updated showPlanSections to remove asterisks and bold problem behaviors
        function showPlanSections(sections, problemBehaviorPhrases = []) {
            // console.log("[FRONTEND] showPlanSections received sections:", JSON.parse(JSON.stringify(sections)));
            // console.log("[FRONTEND] Problem behavior phrases for bolding:", problemBehaviorPhrases);
            const fallbackMsg = "The AI attempted to generate this section but may require more specific input for optimal results. Review and refine as needed.";

            function cleanAndBoldContent(text, phrasesToBold) {
                if (typeof text !== 'string') return '';
                let processedText = text.replace(/\*/g, ''); // Remove all asterisks

                // Sort phrases by length descending to bold longer matches first
                const sortedPhrases = [...phrasesToBold].sort((a, b) => b.length - a.length);

                sortedPhrases.forEach(phrase => {
                    if (phrase && phrase.trim() !== '') {
                        // Match whole words/phrases, case-insensitive
                        const regex = new RegExp(`(\\b${escapeRegExp(phrase.trim())}\\b)`, 'gi');
                        processedText = processedText.replace(regex, (match) => `<strong>${match}</strong>`);
                    }
                });
                return processedText;
            }

            let hypothesisContent = sections["Function Hypothesis Statement"] || fallbackMsg;
            const hypothesisDisplayPrefixLine1 = "Function Hypothesis Statement - The following provides an overview of the current behavior(s).";
            const hypothesisDisplayPrefixLine2 = "Summary Statement: ";
            bipFunctionHypothesis.innerHTML = cleanAndBoldContent(`${hypothesisDisplayPrefixLine1}\n${hypothesisDisplayPrefixLine2}${hypothesisContent}`, problemBehaviorPhrases);

            bipAntecedentStrategies.innerHTML = cleanAndBoldContent(sections["Antecedent Strategies"] || fallbackMsg, problemBehaviorPhrases);
            bipShortTermBehaviors.innerHTML = cleanAndBoldContent(sections["Short-term Replacement Behaviors"] || fallbackMsg, problemBehaviorPhrases);
            bipTeachingStrategies.innerHTML = cleanAndBoldContent(sections["Teaching Strategies for Short-Term Replacement Behaviors"] || fallbackMsg, problemBehaviorPhrases);
            bipReinforcementShortTerm.innerHTML = cleanAndBoldContent(sections["Reinforcement Strategies for Short-Term Replacement Behaviors"] || fallbackMsg, problemBehaviorPhrases);
            bipLongTermBehaviors.innerHTML = cleanAndBoldContent(sections["Long-term Replacement Behaviors"] || fallbackMsg, problemBehaviorPhrases);
            bipResponseStrategies.innerHTML = cleanAndBoldContent(sections["Response Strategies for Problem Behavior"] || fallbackMsg, problemBehaviorPhrases);

            bipOutputDiv.classList.remove('hidden');
            // console.log("[FRONTEND] bipOutputDiv should now be visible.");
        }
        // MODIFICATION END


        function showErrorOutput(msg) {
            // console.log("[FRONTEND] showErrorOutput called with msg:", msg);
            bipFunctionHypothesis.innerHTML = msg; // Use innerHTML here too if errors might contain HTML
            bipAntecedentStrategies.innerHTML = "";
            bipShortTermBehaviors.innerHTML = "";
            bipTeachingStrategies.innerHTML = "";
            bipReinforcementShortTerm.innerHTML = "";
            bipLongTermBehaviors.innerHTML = "";
            bipResponseStrategies.innerHTML = "";
            bipOutputDiv.classList.remove('hidden');
        }

        function hidePlanOutput() {
            bipFunctionHypothesis.textContent = ""; // Can remain textContent if errors are plain text
            bipAntecedentStrategies.textContent = "";
            bipShortTermBehaviors.textContent = "";
            bipTeachingStrategies.textContent = "";
            bipReinforcementShortTerm.textContent = "";
            bipLongTermBehaviors.textContent = "";
            bipResponseStrategies.textContent = "";
            bipOutputDiv.classList.add('hidden');
        }

        // MODIFICATION START: generatePlanWithGemini to call getActiveProblemBehaviorPhrases
        async function generatePlanWithGemini() {
            // console.log("[FRONTEND] generatePlanWithGemini called");
            generateBIPSpinner.classList.remove('hidden');
            generateBIPButton.disabled = true;
            sessionStatusDisplay.textContent = "Generating...";
            hidePlanOutput();

            const activePhrases = getActiveProblemBehaviorPhrases(); // Get phrases
            const userGeneratedPrompt = createPromptFromForm();

            // console.log("[FRONTEND] Generated prompt for backend (first 500 chars):", userGeneratedPrompt.substring(0,500) + "...");
            // console.log("[FRONTEND] Active phrases for bolding:", activePhrases);

            // This is a FRONTEND ONLY example.
            // In a real application, you would send `userGeneratedPrompt` to your backend,
            // which then calls the Gemini API.
            // For this example, we'll simulate a delay and a mock response structure.
            console.log("Simulating API call with prompt (see console for full prompt):", userGeneratedPrompt.substring(0, 200) + "...");
            // alert("This is a frontend-only example. The plan generation is mocked. Check console for the prompt that would be sent to a backend.");

            // --- MOCK API CALL ---
            // Replace this section with your actual `fetch` call to your backend API
            // For demonstration purposes, this simulates a delay and uses a very basic response.
            // You will need a backend to securely call the Gemini API.
             try {
                // Simulate a delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                // This is where you'd typically have:
                // const response = await fetch('/api/ask', { method: 'POST', ... body: JSON.stringify({prompt: userGeneratedPrompt})});
                // const data = await response.json();
                // For now, we create a placeholder successful response.
                // You will need to replace this with actual backend interaction for Gemini.

                // IMPORTANT: This is a placeholder. The actual plan text would come from Gemini.
                // For testing, you might put a very short, structured example here.
                const placeholderPlanText = `
Function Hypothesis Statement:
When asked to do non-preferred tasks, the student will engage in task refusal to escape the demand. Therefore, the function is escape.

Antecedent Strategies:
- Use a visual schedule.
- Offer choices.

Short-term Replacement Behaviors:
- Request a break using a card.

Teaching Strategies for Short-Term Replacement Behaviors:
- Model and practice requesting a break.

Reinforcement Strategies for Short-Term Replacement Behaviors:
- Provide a short break immediately when requested appropriately.

Long-term Replacement Behaviors:
- Complete tasks with fewer prompts.

Response Strategies for Problem Behavior:
For Task Refusal / Noncompliance:
  a. Ensure safety.
  b. calmly redirect.
  c. Use minimal verbal interaction.
  d. Re-present demand after a short cool-down.
  e. Avoid lengthy discussions during refusal.
`;

                const mockData = {
                    candidates: [{
                        content: {
                            parts: [{ text: placeholderPlanText }]
                        },
                        finishReason: "STOP",
                        safetyRatings: [] // Assuming safe for this mock
                    }]
                };
                 // console.log("[FRONTEND] Mock API successful response received.");

                if (mockData.error) { // Simulating backend successfully forwarding an API error
                    let errorMsg = mockData.error.message || JSON.stringify(mockData.error, null, 2);
                    showErrorOutput("Failed to generate a plan (API error from backend).\n" + errorMsg);
                    console.error("[FRONTEND] Mock Gemini API Error (via backend):", mockData.error);
                } else if (mockData.candidates && mockData.candidates.length > 0 && mockData.candidates[0].content && mockData.candidates[0].content.parts && mockData.candidates[0].content.parts.length > 0 && mockData.candidates[0].content.parts[0].text) {
                    const planText = mockData.candidates[0].content.parts[0].text;
                    const sections = parsePlanSections(planText);
                    showPlanSections(sections, activePhrases);
                } else {
                    // Handle other cases like MAX_TOKENS, SAFETY, etc., based on real Gemini response structure
                    let specificError = "Received an unexpected response structure from the mock API or no plan was generated.";
                    if (mockData.candidates && mockData.candidates.length > 0 && mockData.candidates[0].finishReason) {
                        specificError = `The response generation finished with reason: ${mockData.candidates[0].finishReason}. (Mocked)`;
                         // Add more specific messages for SAFETY, MAX_TOKENS if you want to test those paths in mock
                    } else if (mockData.promptFeedback && mockData.promptFeedback.blockReason) {
                         specificError = `The prompt was blocked by the API. Reason: ${mockData.promptFeedback.blockReason}. (Mocked)`;
                    }
                    showErrorOutput(specificError);
                    console.error("[FRONTEND] Mock API - Unexpected successful response structure:", mockData);
                }
            } catch (err) {
                console.error("[FRONTEND] Error in mock API call simulation (e.g., if you had network issues with a real API):", err);
                showErrorOutput("An error occurred during the mock API call: " + err.message);
            } finally {
                generateBIPSpinner.classList.add('hidden');
                generateBIPButton.disabled = false;
                sessionStatusDisplay.textContent = "Active (Mock Response)";
                // console.log("[FRONTEND] generatePlanWithGemini (mock) finished.");
            }
            // --- END MOCK API CALL ---
        }
        // MODIFICATION END

        generateBIPButton.addEventListener('click', (e) => {
            e.preventDefault();
            generatePlanWithGemini();
        });

        copyBIPButton.addEventListener('click', () => {
            const monitoringStatementText = monitoringStatementContentElement ? monitoringStatementContentElement.textContent.trim() : "";
            // For copying, we want the plain text without the <strong> tags.
            // We can get this by temporarily rendering to a hidden div or by stripping HTML.
            // Simpler approach: copy from elements' textContent, which doesn't include HTML tags.

            const tempDiv = document.createElement('div');
            function getCleanText(elementId) {
                const element = document.getElementById(elementId);
                if (!element) return "";
                // Clone the element to avoid altering the live display for textContent extraction
                const clone = element.cloneNode(true);
                // If we used innerHTML to set it, textContent should give us the de-HTML'd version
                return clone.textContent || "";
            }


            let textToCopy =
`${getCleanText('bipFunctionHypothesis').trim()}

Antecedent Strategies:
${getCleanText('bipAntecedentStrategies').trim()}

Short-term Replacement Behaviors:
${getCleanText('bipShortTermBehaviors').trim()}

Teaching Strategies for Short-Term Replacement Behaviors:
${getCleanText('bipTeachingStrategies').trim()}

Reinforcement Strategies for Short-Term Replacement Behaviors:
${getCleanText('bipReinforcementShortTerm').trim()}

Long-term Replacement Behaviors:
${getCleanText('bipLongTermBehaviors').trim()}

Response Strategies for Problem Behavior:
${getCleanText('bipResponseStrategies').trim()}

Monitoring and Plan Review:
${monitoringStatementText}
`;
            navigator.clipboard.writeText(textToCopy.trim());
            const originalButtonText = copyBIPButton.innerHTML;
            copyBIPButton.innerHTML = '<i class="fas fa-check mr-2"></i> Copied!';
            setTimeout(() => { copyBIPButton.innerHTML = originalButtonText; }, 2000);
        });

        document.getElementById('newPlanButton').addEventListener('click', () => {
            studentAgeInput.value = '';
            studentGradeSelect.value = '';
            strengthsInterestsResiliencyInput.value = '';
            reinforcerPreferencesInput.value = '';
            anecdotalInput.value = '';
            referralInput.value = '';
            behavioralSkillsSelect.value = '';
            socialSkillsSelect.value = '';
            pragmaticLanguageSkillsSelect.value = '';

            for (let i = 0; i < 3; i++) {
                const behaviorBlock = document.querySelector(`.behavior-block[data-behavior-index="${i}"]`);
                if (behaviorBlock) {
                    const header = behaviorBlock.querySelector('h3');
                    if (header) {
                        header.textContent = `Behavior Pattern ${i + 1}${i > 0 ? ' (Optional)' : ''}`;
                    }
                }

                const behaviorTypeSelect = document.getElementById(`behaviorTypeSelect_${i}`);
                if (behaviorTypeSelect) {
                    behaviorTypeSelect.value = '';
                    behaviorTypeSelect.dispatchEvent(new Event('change'));
                }
                const antecedentSelect = document.getElementById(`antecedentSelect_${i}`);
                if (antecedentSelect) populateSelectWithOptions(antecedentSelect, [], "Select Antecedent (after choosing type)");

                const behaviorSelect = document.getElementById(`behaviorSelect_${i}`);
                if (behaviorSelect) populateSelectWithOptions(behaviorSelect, [], "Select Specific Behavior (after choosing type)");

                const consequenceSelect = document.getElementById(`consequenceSelect_${i}`);
                if (consequenceSelect) populateSelectWithOptions(consequenceSelect, [], "Select Consequence (after choosing type)");
            }

            addReferralNo.checked = true;
            referralInfoContainer.classList.add('hidden');
            hidePlanOutput();
            sessionStatusDisplay.textContent = "Active";
            // console.log("[FRONTEND] New plan started, fields cleared.");
        });
    </script>
</body>
</html>
